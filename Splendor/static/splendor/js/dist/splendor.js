const BASE_URL="https://app3774.acapp.acwing.com.cn";function refresh_tokens(){setInterval((()=>{$.ajax({url:`${BASE_URL}/gameclub/auth/jwt/token/refresh/`,type:"POST",data:{refresh:localStorage.getItem("gc-refresh")},success:t=>{localStorage.setItem("gc-access",t.access)}})}),27e4)}function clear_tokens(){localStorage.setItem("gc-access",""),localStorage.setItem("gc-refresh","")}export class SplendorLogin{constructor(t,e,s,i){this.id=t,this.os=e,this.$splendor_div=$("#"+t),localStorage.getItem("gc-access")||localStorage.setItem("gc-access",s),localStorage.getItem("gc-refresh")||localStorage.setItem("gc-refresh",i),this.start()}start(){this.$login_div=$("\n<div class='splendor-login-wrap'>\n    <div class='splendor-login-box'>\n        <div class='splendor-login-logo'>\n        </div>\n        <div class='splendor-login-content'>\n            <div class='splendor-login-title'>\n                <span>您还未登录,请前往GameClub登录</span>\n            </div>\n            <div class='splendor-login-button'>\n                <a>前往GameClub登录</a>\n            </div>\n        </div>\n    </div>\n</div>\n"),this.$login_div.hide(),this.$splendor_div.append(this.$login_div),this.add_listening_events(),this.get_info()}add_listening_events(){this.$login_div.find(".splendor-login-button").on("click",(()=>{window.location.href=`${BASE_URL}/?redirect=https://app3774.acapp.acwing.com.cn/splendor/signin/`}))}login(){this.$login_div.show()}get_info(){$.ajax({url:`${BASE_URL}/gameclub/auth/check/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},success:t=>{window.location.href=`${BASE_URL}/splendor/page/menu/`},error:t=>{this.login()}})}}export class SplendorMenu{constructor(t,e,s,i){this.id=t,this.os=e,this.room_id=s,this.need_pass=i,this.$menu_div=$("#"+this.id),this.start()}start(){this.start_ws(),this.start_room(),this.get_info(),this.create_settings()}start_ws(){this.socket=new SplendorRoomSocket(this)}start_room(){this.room=new SplendorRoom(this)}create_settings(){this.single_setting={single_mode:{name:"模式",content:["单人"]},single_player_number:{name:"人数",content:["2人","3人","4人","5人"]}},this.room_setting={room_mode:{name:"模式",content:["多人"]},room_player_number:{name:"人数",content:["2人","3人","4人","5人"]},room_round_second:{name:"回合秒数",content:["10s","15s","30s","35s"]},room_pass:{name:"房间密码",content:["none"]}}}create_element(){this.$base_wrap=$("\n<div class='menu-wrap'>\n    <div class='menu-player-info'>\n        <div class='player-info'>\n            <div class='player-info-left'>\n                <span></span>\n                <span></span>\n            </div>\n            <div class='player-info-right'>\n                <img>\n            </div>\n        </div>\n    </div>\n    <div class='menu-box'>\n    </div>\n</div>\n"),this.room_id&&this.room.create_room(this.player_info,this.room_id,this.need_pass,!1,null),this.$player_name=this.$base_wrap.find(".player-info-left > span:first"),this.$player_score=this.$base_wrap.find(".player-info-left > span:last"),this.$player_photo=this.$base_wrap.find(".player-info-right > img"),this.$menu_box=this.$base_wrap.find(".menu-box"),this.$menu_div.append(this.$base_wrap),this.$base_menu=$("\n<div class='menu-list' name='base-menu'>\n    <div class='menu-element' name='single'>\n        <span>单人游戏</span>\n    </div>\n    <div class='menu-element' name='multi'>\n        <span>多人游戏</span>\n    </div>\n    <div class='menu-element' name='ranklist'>\n        <span>排行榜</span>\n    </div>\n    <div class='menu-element' name='signout'>\n        <span>退出</span>\n    </div>\n</div>\n"),this.$single=this.$base_menu.find("[name='single']"),this.$multi=this.$base_menu.find("[name='multi']"),this.$rank=this.$base_menu.find("[name='ranklist']"),this.$signout=this.$base_menu.find("[name='signout']"),this.$menu_box.append(this.$base_menu),this.$single_setting=$("\n<div class='menu-setting-wrap'>\n    <div class='menu-setting-box'>\n        <div class='menu-setting-title'>\n            <span>单人设定</span>\n        </div>\n        <div class='menu-setting-config'>\n            <div class='menu-setting-content'>\n            </div>\n        </div>\n        <div class='menu-setting-button'>\n            <button>确定</button>\n            <button>取消</button>\n        </div>\n    </div>\n</div>\n"),this.$single_setting_content=this.$single_setting.find(".menu-setting-content"),this.contain_setting(this.$single_setting_content,this.single_setting),this.$single_check_button=this.$single_setting.find("button:first"),this.$single_cancel_button=this.$single_setting.find("button:last"),this.$single_setting.hide(),this.$menu_box.append(this.$single_setting),this.$multi_list=$("\n<div class='menu-list' name='multi-menu'>\n    <div class='menu-element' name='match'>\n        <span>开始匹配</span>\n    </div>\n    <div class='menu-element' name='create_room'>\n        <span>组队房间</span>\n    </div>\n    <div class='menu-element' name='multi-last'>\n        <span>上一级</span>\n    </div>\n</div>\n"),this.$match_loading=$("\n<div class='match-loading'>\n    <div class=\"rubik-loader\"></div>\n    <div></div>\n    <button>取消匹配</button>\n</div>\n"),this.$match=this.$multi_list.find("[name='match']"),this.$create_room=this.$multi_list.find("[name='create_room']"),this.$multi_last_menu=this.$multi_list.find("[name='multi-last']"),this.$multi_list.hide(),this.$menu_box.append(this.$multi_list),this.$menu_box.append(this.$match_loading),this.$create_room_setting=$("\n<div class='menu-setting-wrap'>\n    <div class='menu-setting-box'>\n        <div class='menu-setting-title'>\n            <span>房间设定</span>\n        </div>\n        <div class='menu-setting-config'>\n            <div class='menu-setting-content'>\n            </div>\n        </div>\n        <div class='menu-setting-button'>\n            <button>创建房间</button>\n            <button>取消</button>\n        </div>\n    </div>\n</div>\n"),this.$room_setting_content=this.$create_room_setting.find(".menu-setting-content"),this.contain_setting(this.$room_setting_content,this.room_setting),this.$room_check_button=this.$create_room_setting.find("button:first"),this.$room_cancel_button=this.$create_room_setting.find("button:last"),this.$create_room_setting.hide(),this.$menu_box.append(this.$create_room_setting),this.$ranklist=$("\n<div class='menu-ranklist-wrap'>\n    <div class='menu-ranklist-box'>\n        <div class='ranklist-title'>\n            <span>排行榜</span>\n            <img src=\"/static/gameclub/images/settings/cancel.svg\">\n        </div>\n        <div class='ranklist-box'>\n            <div class=\"rubik-loader\"></div>\n            <div class=\"ranklist-content-row ranklist-content-header\">\n                <span>排名</span>\n                <span>头像</span>\n                <span>昵称</span>\n                <span>分数</span>\n            </div>\n            <div class='ranklist-content'>\n            </div>\n        </div>\n        <div class=\"ranklist-content-row ranklist-content-me\">\n        </div>\n    </div>\n</div>\n"),this.$ranklist_content=this.$ranklist.find(".ranklist-content"),this.$ranklist_cancel=this.$ranklist.find("img"),this.$rubik_loader=this.$ranklist.find(".rubik-loader"),this.$ranklist_row_me=this.$ranklist.find(".ranklist-content-me"),this.$ranklist.hide(),this.$menu_box.append(this.$ranklist),$(".menu-setting-select-box").buttonset(),this.add_listening_events()}add_listening_events(){this.$single.on("click",(()=>{this.$base_menu.hide(),this.$single_setting.show()})),this.$multi.on("click",(()=>{this.$base_menu.hide(),this.$multi_list.show()})),this.$rank.on("click",(()=>{this.$base_menu.hide(),this.show_ranklist()})),this.$signout.on("click",(()=>{clear_tokens(),window.location.reload()})),this.$single_check_button.on("click",(()=>{let t=this.get_config(this.$single_setting_content);this.start_single_game(t)})),this.$single_cancel_button.on("click",(()=>{this.$single_setting.hide(),this.$base_menu.show()})),this.$room_check_button.on("click",(()=>{let t=this.get_config(this.$room_setting_content);this.create_room(t)})),this.$room_cancel_button.on("click",(()=>{this.$create_room_setting.hide(),this.$multi_list.show()})),this.$match.on("click",(()=>{this.$multi_list.hide(),this.$match_loading.show(),this.time_func_id=this.start_match_timing(),this.match_game(this.player_info)})),this.$match_loading.find("button").on("click",(()=>{this.stop_match(),this.$multi_list.show()})),this.$create_room.on("click",(()=>{this.$multi_list.hide(),this.$create_room_setting.show()})),this.$multi_last_menu.on("click",(()=>{this.$multi_list.hide(),this.$base_menu.show()})),this.$ranklist_cancel.on("click",(()=>{this.$ranklist.hide(),this.$base_menu.show()}))}create_room(t){this.socket.create_room(t)}receive_create_room(t){this.room.create_room(this.player_info,this.room_id,this.need_pass,!0,t)}match_success(t){this.stop_match_timing(this.time_func_id),this.$match_loading.find("button").hide(),this.$match_loading.find("div:last").css("color","rgb(68, 157, 68)"),this.$match_loading.find("div:last").text("匹配成功! loading..."),this.socket.join_room(t.room_id,this.player_info,t.pass,"true"),console.log("match_success")}start_game(t,e,s){let i=null;for(let t=0;t<e.length;t++)e[t].email===this.email?(e[t].character="me",i=e[t]):e[t].character="enemy";console.log("start_game",t,e,s),this.playground=new SplendorPlayground(this,t,e,s,i),this.room.hide(),this.hide()}stop_game(){this.playground&&(this.playground.close(),this.playground=null,this.show())}stop_match_timing(t){clearInterval(t)}start_match_timing(){let t=1;return this.$match_loading.find("div:last").text(""),setInterval((()=>{let e=t,s=e%60,i=Math.floor(e/60),n="匹配中... ";i>0&&(n+=i+"m"),n+=s+"s",this.$match_loading.find("div:last").text(n),t+=1}),1e3)}stop_match(){this.stop_match_timing(this.time_func_id),this.socket.stop_match(this.email,this.score),this.$match_loading.hide(),console.log("stop_match")}match_game(t){console.log("matching...",t),this.socket.match(t.email,t.score)}show_ranklist(){this.$ranklist.show(),this.rank_list?(this.$rubik_loader.hide(),this.$ranklist_content.show(),this.$ranklist_row_me.show()):this.get_ranklist()}get_ranklist(){$.ajax({url:`${BASE_URL}/splendor/auth/get_ranklist/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},data:{range_min:1,range_max:100},success:t=>{this.padding_ranklist(t),"none"!==this.$ranklist.css("display")&&(this.$rubik_loader.hide(),this.$ranklist_content.show(),this.$ranklist_row_me.show())}})}padding_ranklist(t){let e=-1,s=t.content;this.rank_list=s;let i=s.length;s.forEach(((t,s,n)=>{let a=s+1,o=t.photo,r=t.name,h=t.score,c=t.email,l=this.create_ranklist_row(a,o,r,h);1===a&&l.addClass("ranklist-content-first"),2===a&&l.addClass("ranklist-content-second"),3===a&&l.addClass("ranklist-content-third"),a===i&&l.addClass("ranklist-content-last-row"),this.email===c&&(e=a,l.addClass("ranklist-content-box-me")),this.$ranklist_content.append(l)})),-1===e&&(e="未上榜"),this.$ranklist_row_me.append($(`\n<span>${e}</span>\n<img src='${this.photo}'>\n<span>${this.name}</span>\n<span>${this.score}</span>\n`))}create_ranklist_row(t,e,s,i){return $(`\n<div class="ranklist-content-row">\n    <span>${t}</span>\n    <img src='${e}'>\n    <span>${s}</span>\n    <span>${i}</span>\n</div>\n`)}contain_setting(t,e){for(let s in e){let i=s,n=e[i],a=n.name,o=n.content;t.append(this.create_setting_config_element(i,a,o))}}get_config(t){let e=t.children("div"),s={};for(let t=0;t<e.length;t++){let i=$(e[t]),n=i.find("input")[0].name,a="";a="room_pass"===n?i.find("input").val():i.find("input:checked").val(),s[n]=a}return s}start_single_game(t){let e=parseInt(t.single_player_number[0]);t.single_player_number=e;let s=[],i=this.player_info;i.game_score=0,i.character="me",s.push(i);for(let t=1;t<e;t++)s.push({email:"robot"+t,name:"robot"+t,score:this.player_info.score,photo:`${BASE_URL}/media/default/user.jpg`,game_score:0,character:"robot"});console.log("start_single_game",t,s),this.playground=new SplendorPlayground(this,t,s,"splendor-room_single",i),this.room.hide(),this.hide()}padding_info(t){this.player_info=t,this.name=t.name,this.email=t.email,this.photo=t.photo,this.score=t.score,this.back=t.back,this.create_element(),this.$player_name.text(this.name),this.$player_score.text("Score: "+this.score),this.$player_photo.attr("src",this.photo),this.$base_wrap.css("background-image","linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("+this.back+")")}get_info(){$.ajax({url:`${BASE_URL}/splendor/auth/get_info/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},success:t=>{this.padding_info(t),refresh_tokens()},error:()=>{window.location.href=`${BASE_URL}`}})}show(){this.$base_wrap.show()}hide(){this.$base_wrap.hide()}create_setting_config_element(t,e,s){let i=$(`\n<div class='menu-setting-element'>\n    <div class='menu-setting-name'>\n        <span>${e}</span>\n        <span>:</span>\n    </div>\n    <div class='menu-setting-select'>\n        <div class='menu-setting-select-box'>\n        </div>\n    </div>\n</div>\n`);if("房间密码"===e){let t=$("\n<input type='text' maxlength='4' oninput = \"value=value.replace(/[^\\d]/g,'')\" name='room_pass'>\n<span>(不填视为不设置密码)</span>\n");i.find(".menu-setting-select-box").append(t)}else s.forEach(((e,s,n)=>{let a=$(`\n<input type="radio" id="${t}${s}" value='${e}' name="${t}"><label for="${t}${s}">${e}</label>\n`);0===s&&a.attr("checked","true"),i.find(".menu-setting-select-box").append(a)}));return i}}class TextureUtil{constructor(){}get_point_from(t,e,s,i){var n=t+s,a=e+i;return[t,e,n,e,t,a,t,a,n,e,n,a]}makeTextTexture(t,e){let s=document.createElement("canvas").getContext("2d"),i=(e=e||{}).fontcolor||"black",n=e.fontsize||"30px",a=e.fontfamily||"Microsoft YaHei",o=e.width||100,r=e.height||100,h=e.x||o/2,c=e.y||r/2,l=e.maxwidth||o,_=n+" "+a;return this.setCanvasSize(s.canvas,o,r),s.textAlign="center",s.textBaseline="middle",s.fillStyle=i,s.font=_,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.fillText(t,h,c,l),s.canvas}setCanvasSize(t,e,s){t.width=e,t.height=s}}class SplendorChat{constructor(t){this.playground=t,this.start()}start(){}}let last_timestamp,GAME_OBJECTS=[];class GameObject{constructor(){GAME_OBJECTS.push(this),this.is_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let e=0;e<8;e++)t+=Math.floor(10*Math.random());return t}start(){}update(){}late_update(){}on_destroy(){}destroy(){this.on_destroy();for(let t=0;t<GAME_OBJECTS.length;t++)if(GAME_OBJECTS[t]===this){GAME_OBJECTS.splice(t,1);break}}}class SplendorGameSocket{constructor(t){this.playground=t,this.start()}start(){}}class CanvasShader{constructor(t){this.shader_manager=t,this.name="CanvasShader",this.shader_manager.shader_dict[this.name]=this,console.log("loading shader",this.name),this.init()}shader_text(){this.vs="\n            attribute vec2 a_position;\n            attribute vec2 a_texCoord;\n            uniform vec2 u_resolution;\n\n            varying vec2 v_texCoord;\n\n            void main(){\n                vec2 clipSpace = a_position / u_resolution * 2.0 - 1.0;\n                gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n                v_texCoord = a_texCoord;\n            }\n        ",this.fs="\n            precision highp float;\n\n            uniform sampler2D u_canvas_tex;\n\n            varying vec2 v_texCoord;\n\n            void main(){\n                gl_FragColor = texture2D(u_canvas_tex, v_texCoord);\n            }\n        "}init(){this.shader_text();const t=this.shader_manager,e=t.gl,s=t.createProgramFromText(e,this.vs,this.fs);this.a_positionLoc=e.getAttribLocation(s,"a_position"),this.a_texCoordLoc=e.getAttribLocation(s,"a_texCoord"),this.u_resolutionLoc=e.getUniformLocation(s,"u_resolution"),this.u_canvas_texLoc=e.getUniformLocation(s,"u_canvas_tex"),this.program=s}draw(t,e,s){const i=this.shader_manager,n=i.gl;this.init_data_buffer(n,t,e,s),i.resize(n.canvas),n.viewport(0,0,n.canvas.width,n.canvas.height),n.useProgram(this.program),this.set_attrib_pointer(n),this.set_uniform(n),n.enable(n.BLEND),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA),n.drawArrays(n.TRIANGLES,0,6)}set_uniform(t){t.uniform2fv(this.u_resolutionLoc,[t.canvas.width,t.canvas.height])}set_attrib_pointer(t){t.enableVertexAttribArray(this.a_positionLoc),t.bindBuffer(t.ARRAY_BUFFER,this.a_position_buffer),t.vertexAttribPointer(this.a_positionLoc,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.a_texCoordLoc),t.bindBuffer(t.ARRAY_BUFFER,this.a_texCoord_buffer),t.vertexAttribPointer(this.a_texCoordLoc,2,t.FLOAT,!1,0,0)}init_data_buffer(t,e,s,i){this.a_position_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.a_position_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW),this.a_texCoord_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.a_texCoord_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.u_canvas_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.u_canvas_texture),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}}class ImageShader{constructor(t){this.shader_manager=t,this.name="ImageShader",console.log("loading shader",this.name),this.init()}init(){}}class RectShader{constructor(t){this.shader_manager=t,this.name="RectShader",this.shader_manager.shader_dict[this.name]=this,console.log("loading shader",this.name),this.init()}shader_text(){this.vs="\n            attribute vec2 a_position;\n            uniform vec2 u_resolution;\n\n            void main(){\n                vec2 clipSpace = a_position / u_resolution * 2.0 - 1.0;\n                gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n            }\n        ",this.fs="\n            precision mediump float;\n\n            uniform vec4 u_color;\n\n            void main(){\n                gl_FragColor = u_color;\n            }\n        "}init(){this.shader_text();const t=this.shader_manager,e=t.gl,s=t.createProgramFromText(e,this.vs,this.fs);this.a_positionLoc=e.getAttribLocation(s,"a_position"),this.u_resolutionLoc=e.getUniformLocation(s,"u_resolution"),this.u_colorLoc=e.getUniformLocation(s,"u_color"),this.program=s}init_data_buffer(t,e){this.a_position_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.a_position_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW)}draw(t,e){const s=this.shader_manager,i=s.gl;this.init_data_buffer(i,t),s.resize(i.canvas),i.viewport(0,0,i.canvas.width,i.canvas.height),i.useProgram(this.program),this.set_attrib_pointer(i),this.set_uniform(i,e),i.drawArrays(i.TRIANGLES,0,6)}set_uniform(t,e){t.uniform2fv(this.u_resolutionLoc,[t.canvas.width,t.canvas.height]),t.uniform4fv(this.u_colorLoc,e)}set_attrib_pointer(t){t.enableVertexAttribArray(this.a_positionLoc),t.bindBuffer(t.ARRAY_BUFFER,this.a_position_buffer),t.vertexAttribPointer(this.a_positionLoc,2,t.FLOAT,!1,0,0)}}class ShaderManager{constructor(t){this.playground=t,this.gl=this.playground.gl,this.shader_dict={}}get(t){return this.shader_dict[t]}resize(t){const e=t.clientWidth,s=t.clientHeight;t.width===e&&t.height===s||(t.width=e,t.height=s)}before_render(){const t=this.gl;this.resize(t.canvas),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)}createProgramFromText(t,e,s){const i=this.createShader(t,t.VERTEX_SHADER,e),n=this.createShader(t,t.FRAGMENT_SHADER,s);return this.createProgram(t,i,n)}createShader(t,e,s){var i=t.createShader(e);if(t.shaderSource(i,s),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS))return i;console.log(t.getShaderInfoLog(i)),t.deleteShader(i)}createProgram(t,e,s){var i=t.createProgram();if(t.attachShader(i,e),t.attachShader(i,s),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS))return i;console.log(t.getProgramInfoLog(i)),t.deleteProgram(i)}init(){new ImageShader(this),new CanvasShader(this),new RectShader(this)}}class TopBoard extends GameObject{constructor(t){super(),this.playground=t,this.room_id=this.playground.room_id,this.round=1,this.time=0,this.tu=this.playground.textureUtil,this.sm=this.playground.shader_manager,this.gl=this.sm.gl,this.rect_shader=this.sm.get("RectShader"),this.canvas_shader=this.sm.get("CanvasShader")}start(){}update_room(){let t=this.gl.canvas.width/5,e=this.gl.canvas.height/12;this.room_a_position_data=this.tu.get_point_from(0,0,t,e),this.room_a_texCoord_data=this.tu.get_point_from(0,0,1,1),this.room_u_canvas_data=this.tu.makeTextTexture("房 间 "+this.room_id,{fontsize:"25px",fontcolor:"AliceBlue",width:t,height:e})}update_time(){let t=this.gl.canvas.width/8,e=this.gl.canvas.height/12,s=this.gl.canvas.width/2-t/2;this.text_a_position_data=this.tu.get_point_from(s,0,t,e),this.text_a_texCoord_data=this.tu.get_point_from(0,0,1,1),this.time+=.001*this.timedelta;let i=Math.floor(this.time%60),n=Math.floor(this.time/60);i<10&&(i="0"+i),n<10&&(n="0"+n),this.text_u_canvas_data=this.tu.makeTextTexture(n+":"+i,{width:t,height:e,fontsize:"38px",x:t/2,y:e/2,fontcolor:"white"})}update_border(){this.u_color=[0,0,0,.8];let t=this.gl.canvas.width/2,e=this.gl.canvas.height/12,s=this.gl.canvas.width/2-t/2;this.a_position_data=this.tu.get_point_from(s,0,t,e)}change_round(t){this.round=t}update_round(){let t=this.gl.canvas.width/4,e=this.gl.canvas.height/12,s=this.gl.canvas.width-t;this.round_a_position_data=this.tu.get_point_from(s,0,t,e),this.round_a_texCoord_data=this.tu.get_point_from(0,0,1,1);let i="当 前 回 合 "+this.round+"  xxssssssss 进 行 行 动 !";this.round_u_canvas_data=this.tu.makeTextTexture(i,{fontsize:"30px",fontcolor:"LightPink",width:t,height:e})}update(){this.update_time(),this.update_room(),this.update_round(),this.render()}render(){this.canvas_shader.draw(this.text_a_position_data,this.text_a_texCoord_data,this.text_u_canvas_data),this.canvas_shader.draw(this.room_a_position_data,this.room_a_texCoord_data,this.room_u_canvas_data),this.canvas_shader.draw(this.round_a_position_data,this.round_a_texCoord_data,this.round_u_canvas_data)}}class SplendorPlayground{constructor(t,e,s,i,n){this.menu=t,this.config=e,this.players=s,this.me=n,this.room_id=i,this.mode=this.config.mode,this.$playground_div=$("<div class='playground'></div>"),this.menu.$menu_div.append(this.$playground_div),this.state="start",this.start()}start(){this.init_canvas_context(),this.init_shader_manager(),this.start_animation(),"单人"!==this.mode&&(this.socket=new SplendorGameSocket(this),this.chat=new SplendorChat(this)),this.top_board=new TopBoard(this)}init_canvas_context(){this.$canvas=$("<canvas></canvas>"),this.$playground_div.append(this.$canvas),this.gl=this.$canvas[0].getContext("webgl"),this.gl||alert("未支持WebGl"),this.textureUtil=new TextureUtil(this)}init_shader_manager(){this.shader_manager=new ShaderManager(this),this.shader_manager.init()}start_animation(){let t=e=>{this.shader_manager.before_render();for(let t=0;t<GAME_OBJECTS.length;t++){let s=GAME_OBJECTS[t];s.is_called_start?(s.update(),s.timedelta=e-last_timestamp):(s.start(),s.is_called_start=!0)}for(let t=0;t<GAME_OBJECTS.length;t++)GAME_OBJECTS[t].late_update();last_timestamp=e,requestAnimationFrame(t)};requestAnimationFrame(t)}close(){this.socket&&(this.socket.close(),this.socket=null),this.top_board.destroy(),this.main_screen.destroy(),this.bottom_board.destroy(),this.$playground_div.remove()}}class SplendorRoom{constructor(t){this.root=t,this.players=[],this.start()}start(){this.create_base()}add_listening_events(){this.$room_wrap.find(".room-check-button > button").on("click",(()=>{let t=this.$room_wrap.find(".room-check-input > input").val();if(""===t)return!1;this.check_pass(t)})),this.$room_wrap.find(".room-start > button:first").on("click",(()=>{if(this.is_owner){if(this.players.length<this.config.room_player_number)return!1;this.root.socket.start_game(),this.start_game()}})),this.$room_wrap.find(".room-start > button:last").on("click",(()=>{this.is_owner&&(this.root.socket.cancel_room(),this.cancel_room())})),this.$room_wrap.find(".room-start > button:nth-child(2)").on("click",(()=>{let t=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",`${BASE_URL}/splendor/page/menu/?room_id=${this.room_id}&need_pass=${this.need_pass}`),alert("复制链接成功, 分享给好友邀请加入游戏"),document.removeEventListener("copy",t)};document.addEventListener("copy",t),document.execCommand("Copy")}))}cancel_room(){window.location.href=`${BASE_URL}/splendor/`}start_game(){this.root.start_game(this.config,this.players,this.room_id)}create_base(){this.$room_wrap=$("\n<div class='room-wrap'>\n    <div class='room-check'>\n        <div class='room-check-title'>\n            <span>请输入房间密码</span>\n        </div>\n        <div class='room-check-input'>\n            <input type='text' maxlength='4' oninput= \"value = value.replace(/[^\\d]/g, '')\" name='room_pass'>\n        </div>\n        <div class='room-check-button'>\n            <button>确认</button>\n        </div>\n    </div>\n    <div class='room-box'>\n        <div class='room-title'>\n            <span></span>\n        </div>\n        <div class='room-player'>\n        </div>\n        <div class='room-start'>\n            <button>开始游戏</button>\n            <button>邀请玩家</button>\n            <button>解散房间</button>\n        </div>\n    </div>\n</div>\n"),this.$check=this.$room_wrap.find(".room-check"),this.$check.hide(),this.$box=this.$room_wrap.find(".room-box"),this.$box.hide(),this.$room_wrap.hide(),this.root.$menu_div.append(this.$room_wrap),this.add_listening_events()}show(){this.$room_wrap.show()}hide(){this.$room_wrap.hide()}create_room(t,e,s,i,n){this.room_id=e,this.is_owner=i,this.player_info=t,this.need_pass=s,this.config=n,this.$room_wrap.css("background-image","linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("+t.back+")"),i?(this.players.push(t),this.$box.find(".room-title > span").text("房间 "+this.room_id),this.padding_info(t),this.root.hide(),this.show(),this.$box.show()):(this.root.hide(),this.show(),"true"===s?this.$check.show():this.join_room(t,""))}check_pass(t){this.join_room(this.player_info,t)}join_room(t,e){setTimeout((()=>{this.root.socket.join_room(this.room_id,t,e)}),1e3)}receive_join_room(t,e){this.config=t,this.$check.hide(),this.playernumber=t.room_player_number,this.round_second=t.room_round_second,this.players=e,this.$box.find(".room-title > span").text("房间 "+this.room_id),this.$box.find(".room-player").empty();for(let t=0;t<e.length;t++)this.padding_info(e[t]);this.$box.show()}padding_info(t){let e=this.$box.find(".room-player"),s=$(`\n<div class='player-element'>\n    <div class='player-photo'>\n        <img src='${t.photo}'>\n    </div>\n    <div class='player-name'>\n        <span>${t.name}</span>\n    </div>\n</div>\n`);e.append(s)}}class SplendorRoomSocket{BASE_WSS="wss://app3774.acapp.acwing.com.cn";constructor(t){this.root=t,this.start()}start(){this.ws=new WebSocket(`${this.BASE_WSS}/wss/splendor/multiplayer/room/?token=`+localStorage.getItem("gc-access")),this.receive()}receive_create_room(t){this.root.room_id=t.room_id,this.root.need_pass=t.need_pass,this.root.receive_create_room(t.config)}create_room(t){let e={room_config:t,room_owner:this.root.player_info};this.ws.send(JSON.stringify({event:"create_room",content:e}))}cancel_room(){this.ws.send(JSON.stringify({event:"cancel_room",content:{cancel_room:"true"}}))}start_game(){this.ws.send(JSON.stringify({event:"start_game",content:{start_game:"true"}}))}join_room(t,e,s,i="false"){let n={room_id:t,pass:s,player_info:e,player_info:e,match:i};this.ws.send(JSON.stringify({event:"join_room",content:n}))}receive_join_room(t){t.players.length>=4&&this.root.start_game(t.config,t.players,t.room_id)}receive_match_success(t){this.root.match_success(t)}stop_match(t,e){let s={email:t,score:e};this.ws.send(JSON.stringify({event:"stop_match",content:s}))}match(t,e){let s={email:t,score:e};this.ws.send(JSON.stringify({event:"match",content:s}))}receive(){this.ws.onmessage=t=>{let e=JSON.parse(t.data),s=e.event,i=e.content;if("create_room"===s)this.receive_create_room(i);else if("join_room"===s)"false"===i.match?this.root.room.receive_join_room(i.config,i.players):this.receive_join_room(i);else if("match_success"===s)this.receive_match_success(i);else{if(e.email===this.root.player_info.email)return!1;"start_game"===s?this.root.room.start_game():"cancel_room"===s&&this.root.room.cancel_room()}}}}
