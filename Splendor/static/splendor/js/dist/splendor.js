const BASE_URL="https://app3774.acapp.acwing.com.cn";function refresh_tokens(){setInterval((()=>{$.ajax({url:`${BASE_URL}/gameclub/auth/jwt/token/refresh/`,type:"POST",data:{refresh:localStorage.getItem("gc-refresh")},success:e=>{localStorage.setItem("gc-access",e.access)}})}),27e4)}function clear_tokens(){localStorage.setItem("gc-access",""),localStorage.setItem("gc-refresh","")}export class SplendorLogin{constructor(e,t,s,n){this.id=e,this.os=t,this.$splendor_div=$("#"+e),localStorage.getItem("gc-access")||localStorage.setItem("gc-access",s),localStorage.getItem("gc-refresh")||localStorage.setItem("gc-refresh",n),this.start()}start(){this.$login_div=$("\n<div class='splendor-login-wrap'>\n    <div class='splendor-login-box'>\n        <div class='splendor-login-logo'>\n        </div>\n        <div class='splendor-login-content'>\n            <div class='splendor-login-title'>\n                <span>您还未登录,请前往GameClub登录</span>\n            </div>\n            <div class='splendor-login-button'>\n                <a>前往GameClub登录</a>\n            </div>\n        </div>\n    </div>\n</div>\n"),this.$login_div.hide(),this.$splendor_div.append(this.$login_div),this.add_listening_events(),this.get_info()}add_listening_events(){this.$login_div.find(".splendor-login-button").on("click",(()=>{window.location.href=`${BASE_URL}/?redirect=https://app3774.acapp.acwing.com.cn/splendor/signin/`}))}login(){this.$login_div.show()}get_info(){$.ajax({url:`${BASE_URL}/gameclub/auth/check/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},success:e=>{window.location.href=`${BASE_URL}/splendor/page/menu/`},error:e=>{this.login()}})}}export class SplendorMenu{constructor(e,t,s,n){this.id=e,this.os=t,this.room_id=s,this.need_pass=n,this.$menu_div=$("#"+this.id),this.start()}start(){this.start_ws(),this.start_room(),this.get_info(),this.create_settings()}start_ws(){this.socket=new SplendorRoomSocket(this)}start_room(){this.room=new SplendorRoom(this)}create_settings(){this.single_setting={single_mode:{name:"模式",content:["单人"]},single_player_number:{name:"人数",content:["2人","3人","4人"]},single_round_second:{name:"回合秒数",content:["10s","15s","30s","35s"]}},this.room_setting={room_mode:{name:"模式",content:["多人"]},room_player_number:{name:"人数",content:["2人","3人","4人"]},room_round_second:{name:"回合秒数",content:["10s","15s","30s","35s"]},room_pass:{name:"房间密码",content:["none"]}}}create_element(){this.$base_wrap=$("\n<div class='menu-wrap'>\n    <div class='menu-player-info'>\n        <div class='player-info'>\n            <div class='player-info-left'>\n                <span></span>\n                <span></span>\n            </div>\n            <div class='player-info-right'>\n                <img>\n            </div>\n        </div>\n    </div>\n    <div class='menu-box'>\n    </div>\n</div>\n"),this.room_id&&this.room.create_room(this.player_info,this.room_id,this.need_pass,!1,null),this.$player_name=this.$base_wrap.find(".player-info-left > span:first"),this.$player_score=this.$base_wrap.find(".player-info-left > span:last"),this.$player_photo=this.$base_wrap.find(".player-info-right > img"),this.$menu_box=this.$base_wrap.find(".menu-box"),this.$menu_div.append(this.$base_wrap),this.$base_menu=$("\n<div class='menu-list' name='base-menu'>\n    <div class='menu-element' name='single'>\n        <span>单人游戏</span>\n    </div>\n    <div class='menu-element' name='multi'>\n        <span>多人游戏</span>\n    </div>\n    <div class='menu-element' name='ranklist'>\n        <span>排行榜</span>\n    </div>\n    <div class='menu-element' name='signout'>\n        <span>退出</span>\n    </div>\n</div>\n"),this.$single=this.$base_menu.find("[name='single']"),this.$multi=this.$base_menu.find("[name='multi']"),this.$rank=this.$base_menu.find("[name='ranklist']"),this.$signout=this.$base_menu.find("[name='signout']"),this.$menu_box.append(this.$base_menu),this.$single_setting=$("\n<div class='menu-setting-wrap'>\n    <div class='menu-setting-box'>\n        <div class='menu-setting-title'>\n            <span>单人设定</span>\n        </div>\n        <div class='menu-setting-config'>\n            <div class='menu-setting-content'>\n            </div>\n        </div>\n        <div class='menu-setting-button'>\n            <button>确定</button>\n            <button>取消</button>\n        </div>\n    </div>\n</div>\n"),this.$single_setting_content=this.$single_setting.find(".menu-setting-content"),this.contain_setting(this.$single_setting_content,this.single_setting),this.$single_check_button=this.$single_setting.find("button:first"),this.$single_cancel_button=this.$single_setting.find("button:last"),this.$single_setting.hide(),this.$menu_box.append(this.$single_setting),this.$multi_list=$("\n<div class='menu-list' name='multi-menu'>\n    <div class='menu-element' name='match'>\n        <span>开始匹配</span>\n    </div>\n    <div class='menu-element' name='create_room'>\n        <span>组队房间</span>\n    </div>\n    <div class='menu-element' name='multi-last'>\n        <span>上一级</span>\n    </div>\n</div>\n"),this.$match_loading=$("\n<div class='match-loading'>\n    <div class=\"rubik-loader\"></div>\n    <div></div>\n    <button>取消匹配</button>\n</div>\n"),this.$match=this.$multi_list.find("[name='match']"),this.$create_room=this.$multi_list.find("[name='create_room']"),this.$multi_last_menu=this.$multi_list.find("[name='multi-last']"),this.$multi_list.hide(),this.$menu_box.append(this.$multi_list),this.$menu_box.append(this.$match_loading),this.$create_room_setting=$("\n<div class='menu-setting-wrap'>\n    <div class='menu-setting-box'>\n        <div class='menu-setting-title'>\n            <span>房间设定</span>\n        </div>\n        <div class='menu-setting-config'>\n            <div class='menu-setting-content'>\n            </div>\n        </div>\n        <div class='menu-setting-button'>\n            <button>创建房间</button>\n            <button>取消</button>\n        </div>\n    </div>\n</div>\n"),this.$room_setting_content=this.$create_room_setting.find(".menu-setting-content"),this.contain_setting(this.$room_setting_content,this.room_setting),this.$room_check_button=this.$create_room_setting.find("button:first"),this.$room_cancel_button=this.$create_room_setting.find("button:last"),this.$create_room_setting.hide(),this.$menu_box.append(this.$create_room_setting),this.$ranklist=$("\n<div class='menu-ranklist-wrap'>\n    <div class='menu-ranklist-box'>\n        <div class='ranklist-title'>\n            <span>排行榜</span>\n            <img src=\"/static/gameclub/images/settings/cancel.svg\">\n        </div>\n        <div class='ranklist-box'>\n            <div class=\"rubik-loader\"></div>\n            <div class=\"ranklist-content-row ranklist-content-header\">\n                <span>排名</span>\n                <span>头像</span>\n                <span>昵称</span>\n                <span>分数</span>\n            </div>\n            <div class='ranklist-content'>\n            </div>\n        </div>\n        <div class=\"ranklist-content-row ranklist-content-me\">\n        </div>\n    </div>\n</div>\n"),this.$ranklist_content=this.$ranklist.find(".ranklist-content"),this.$ranklist_cancel=this.$ranklist.find("img"),this.$rubik_loader=this.$ranklist.find(".rubik-loader"),this.$ranklist_row_me=this.$ranklist.find(".ranklist-content-me"),this.$ranklist.hide(),this.$menu_box.append(this.$ranklist),$(".menu-setting-select-box").buttonset(),this.add_listening_events()}add_listening_events(){this.$single.on("click",(()=>{this.$base_menu.hide(),this.$single_setting.show()})),this.$multi.on("click",(()=>{this.$base_menu.hide(),this.$multi_list.show()})),this.$rank.on("click",(()=>{this.$base_menu.hide(),this.show_ranklist()})),this.$signout.on("click",(()=>{clear_tokens(),window.location.reload()})),this.$single_check_button.on("click",(()=>{let e=this.get_config(this.$single_setting_content);this.start_single_game(e)})),this.$single_cancel_button.on("click",(()=>{this.$single_setting.hide(),this.$base_menu.show()})),this.$room_check_button.on("click",(()=>{let e=this.get_config(this.$room_setting_content);this.create_room(e)})),this.$room_cancel_button.on("click",(()=>{this.$create_room_setting.hide(),this.$multi_list.show()})),this.$match.on("click",(()=>{this.$multi_list.hide(),this.$match_loading.show(),this.time_func_id=this.start_match_timing(),this.match_game(this.player_info)})),this.$match_loading.find("button").on("click",(()=>{this.stop_match(),this.$multi_list.show()})),this.$create_room.on("click",(()=>{this.$multi_list.hide(),this.$create_room_setting.show()})),this.$multi_last_menu.on("click",(()=>{this.$multi_list.hide(),this.$base_menu.show()})),this.$ranklist_cancel.on("click",(()=>{this.$ranklist.hide(),this.$base_menu.show()}))}create_room(e){this.socket.create_room(e)}receive_create_room(e){this.room.create_room(this.player_info,this.room_id,this.need_pass,!0,e)}match_success(e){this.stop_match_timing(this.time_func_id),this.$match_loading.find("button").hide(),this.$match_loading.find("div:last").css("color","rgb(68, 157, 68)"),this.$match_loading.find("div:last").text("匹配成功! loading..."),this.socket.join_room(e.room_id,this.player_info,e.pass,"true"),console.log("match_success")}start_game(e,t,s){let n=null;for(let e=0;e<t.length;e++)t[e].email===this.email?(t[e].character="me",n=t[e]):t[e].character="enemy";console.log("start_game",e,t,s),this.playground=new SplendorPlayground(this,e,t,s,n),this.room.hide(),this.hide()}stop_game(){this.playground&&(this.playground.close(),this.playground=null,this.show())}stop_match_timing(e){clearInterval(e)}start_match_timing(){let e=1;return this.$match_loading.find("div:last").text(""),setInterval((()=>{let t=e,s=t%60,n=Math.floor(t/60),i="匹配中... ";n>0&&(i+=n+"m"),i+=s+"s",this.$match_loading.find("div:last").text(i),e+=1}),1e3)}stop_match(){this.stop_match_timing(this.time_func_id),this.socket.stop_match(this.email,this.score),this.$match_loading.hide(),console.log("stop_match")}match_game(e){console.log("matching...",e),this.socket.match(e.email,e.score)}show_ranklist(){this.$ranklist.show(),this.rank_list?(this.$rubik_loader.hide(),this.$ranklist_content.show(),this.$ranklist_row_me.show()):this.get_ranklist()}get_ranklist(){$.ajax({url:`${BASE_URL}/splendor/auth/get_ranklist/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},data:{range_min:1,range_max:100},success:e=>{this.padding_ranklist(e),"none"!==this.$ranklist.css("display")&&(this.$rubik_loader.hide(),this.$ranklist_content.show(),this.$ranklist_row_me.show())}})}padding_ranklist(e){let t=-1,s=e.content;this.rank_list=s;let n=s.length;s.forEach(((e,s,i)=>{let o=s+1,a=e.photo,r=e.name,c=e.score,l=e.email,d=this.create_ranklist_row(o,a,r,c);1===o&&d.addClass("ranklist-content-first"),2===o&&d.addClass("ranklist-content-second"),3===o&&d.addClass("ranklist-content-third"),o===n&&d.addClass("ranklist-content-last-row"),this.email===l&&(t=o,d.addClass("ranklist-content-box-me")),this.$ranklist_content.append(d)})),-1===t&&(t="未上榜"),this.$ranklist_row_me.append($(`\n<span>${t}</span>\n<img src='${this.photo}'>\n<span>${this.name}</span>\n<span>${this.score}</span>\n`))}create_ranklist_row(e,t,s,n){return $(`\n<div class="ranklist-content-row">\n    <span>${e}</span>\n    <img src='${t}'>\n    <span>${s}</span>\n    <span>${n}</span>\n</div>\n`)}contain_setting(e,t){for(let s in t){let n=s,i=t[n],o=i.name,a=i.content;e.append(this.create_setting_config_element(n,o,a))}}get_config(e){let t=e.children("div"),s={};for(let e=0;e<t.length;e++){let n=$(t[e]),i=n.find("input")[0].name,o="";o="room_pass"===i?n.find("input").val():n.find("input:checked").val(),s[i]=o}return s}start_single_game(e){let t=parseInt(e.single_player_number),s=parseInt(e.single_round_second);e.single_player_number=t,e.single_round_second=s;let n=[],i=this.player_info;i.game_score=0,i.character="me",n.push(i);for(let e=1;e<t;e++)n.push({email:"robot"+e,name:"robot"+e,score:this.player_info.score,photo:"/media/default/user.jpg",game_score:0,character:"robot"});console.log("start_single_game",e,n),this.playground=new SplendorPlayground(this,e,n,"splendor-room_single",i),this.room.hide(),this.hide()}padding_info(e){this.player_info=e,this.name=e.name,this.email=e.email,this.photo=e.photo,this.score=e.score,this.back=e.back,this.create_element(),this.$player_name.text(this.name),this.$player_score.text("Score: "+this.score),this.$player_photo.attr("src",this.photo),this.$base_wrap.css("background-image","linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("+this.back+")")}get_info(){$.ajax({url:`${BASE_URL}/splendor/auth/get_info/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},success:e=>{this.padding_info(e),refresh_tokens()},error:()=>{window.location.href=`${BASE_URL}`}})}show(){this.$base_wrap.show()}hide(){this.$base_wrap.hide()}create_setting_config_element(e,t,s){let n=$(`\n<div class='menu-setting-element'>\n    <div class='menu-setting-name'>\n        <span>${t}</span>\n        <span>:</span>\n    </div>\n    <div class='menu-setting-select'>\n        <div class='menu-setting-select-box'>\n        </div>\n    </div>\n</div>\n`);if("房间密码"===t){let e=$("\n<input type='text' maxlength='4' oninput = \"value=value.replace(/[^\\d]/g,'')\" name='room_pass'>\n<span>(不填视为不设置密码)</span>\n");n.find(".menu-setting-select-box").append(e)}else s.forEach(((t,s,i)=>{let o=$(`\n<input type="radio" id="${e}${s}" value='${t}' name="${e}"><label for="${e}${s}">${t}</label>\n`);0===s&&o.attr("checked","true"),n.find(".menu-setting-select-box").append(o)}));return n}}let last_timestamp,GAME_OBJECTS=[];class GameObject{constructor(){GAME_OBJECTS.push(this),this.is_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let e="";for(let t=0;t<8;t++)e+=Math.floor(10*Math.random());return e}start(){}update(){}late_update(){}on_destroy(){}destroy(){this.on_destroy();for(let e=0;e<GAME_OBJECTS.length;e++)if(GAME_OBJECTS[e]===this){GAME_OBJECTS.splice(e,1);break}}}class Card extends GameObject{constructor(e,t,s,n,i,o){super(),this.playground=e.playground,this.cm=e,this.sm=this.cm.sm,this.card_config=t,this.x=s,this.y=n,this.vx=0,this.vy=0,this.move_length=0,this.speed=1e3,this.state="board",this.role=null,this.level=i,this.location=o,this.scale=1,this.uuid=this.card_config.id}can_buy(e){let t=this.card_config.spend,s=0;for(let n in t){let i=t[n],o=i.color,a=i.need;s+=Math.max(0,a-e.cards[o]-e.tokens[o])}return s-e.tokens.O<=0}buy_by_player(e,t=!0){let s=this.card_config.spend,n={},i=0;for(let t in s){let o=s[t],a=o.color,r=o.need;n[a]=Math.max(0,r-e.cards[a]),n[a]-e.tokens[a]>0&&(i+=n[a]-e.tokens[a],n[a]=0)}n.O=i,e.email===this.playground.players_manager.get_me().email&&t&&this.playground.socket&&this.playground.socket.send_buy_card(e.email,this.uuid),this.playground.tokens_manager.used_by_player(e,n),"book"===this.state?e.update_books("buy",this):(this.change_scale(.3),this.move_to(e.x,e.y),this.change_state("on_de"),e.update_cards(this,this.card_config.gem,1),this.playground.cards_manager.next_card(this.level,this.location)),this.playground.players_manager.next_player()}can_book(e){return"board"===this.state&&(e.books.length<3||void 0)}book_by_player(e,t=!0){e.tokens_count+1<=10&&this.playground.tokens_manager.picked_by_player_from_tokens(e,{O:1}),e.email===this.playground.players_manager.get_me().email&&t&&this.playground.socket&&this.playground.socket.send_book_card(e.email,this.uuid),e.update_books("book",this),this.playground.cards_manager.next_card(this.level,this.location),this.playground.players_manager.next_player()}clicked(e,t){if("board"!==this.state&&"book"!==this.state)return!1;if("book"===this.state&&this.role!==this.playground.players_manager.get_me().email)return!1;let s=150*this.scale,n=203*this.scale;return e>=this.x&&e<=this.x+s&&t>=this.y&&t<=this.y+n&&(null===this.role||this.role===this.playground.me.email)}change_state(e){this.state=e}change_scale(e){this.scale=e}get_dist(e,t,s,n){let i=(s-e)*(s-e),o=(n-t)*(n-t);return Math.sqrt(i+o)}move_to(e,t){this.move_length=this.get_dist(e,t,this.x,this.y);let s=Math.atan2(t-this.y,e-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}update_x_y(){let e=Math.min(this.move_length,this.speed*this.timedelta*.001);this.move_length-=e,this.x+=e*this.vx,this.y+=e*this.vy}start(){}update(){"on_de"===this.state&&0===this.move_length&&this.destroy(),this.update_x_y(),this.render()}on_destroy(){for(let e in this.cm.cards.instance)this.cm.cards.instance[e]===this&&this.cm.cards.instance.splice(e,1)}render(){let e=98*this.scale,t=100*this.scale,s=[2,0,3,1],n=40*this.scale,i=15*this.scale,o=this.scale,a=50*this.scale;this.sm.shader_card_back(this.x,this.y,this.card_config.backIndex[0],this.card_config.backIndex[1],{scale:o}),this.sm.shader_top_back(this.x,this.y,[1,1,1,.5],{scale:o}),this.sm.shader_score(this.x,this.y,this.card_config.score-1,{scale:o}),this.sm.shader_gem(this.x+e,this.y,GemColor2Index[this.card_config.gem],{scale:o}),this.card_config.spend.forEach(((e,n)=>{n=s[n];let i=Math.floor(n/2),r=n%2,c=NSColor2Index[e.color],l=e.need-1;this.sm.shader_spend(this.x+r*a,this.y+t+i*a,c,l,{scale:o})})),this.card_config.spend.forEach(((e,r)=>{r=s[r];let c=Math.floor(r/2),l=r%2,d=GemColor2Index[e.color];this.sm.shader_gem(this.x+l*a+n,this.y+c*a+i+t,d,{scale_x:20,scale_y:20,scale:o})}))}}class CardsManager extends GameObject{constructor(e){super(),this.playground=e,this.sm=this.playground.shader_manager,this.cards={instance:[],count:{level1:40,level2:30,level3:20},board_cards:{level1:[null,null,null,null],level2:[null,null,null,null],level3:[null,null,null,null]},all_cards:{level1:[],level2:[],level3:[]}},this.init()}init(){this.init_cards()}get_card(e){for(let t in this.cards.instance){let s=this.cards.instance[t];if(s.uuid===e)return s}}init_cards(){"单人"!==this.playground.mode?this.init_cards_from_web():this.init_cards_from_local();for(let e=0;e<4;e++)for(let t=1;t<=3;t++)this.next_card(t,e)}init_cards_from_local(){let e=[];for(let t=0;t<this.cards.count.level1;t++)e.push(t);e.sort((()=>.5-Math.random()));let t=[];for(let e=0;e<this.cards.count.level2;e++)t.push(e);t.sort((()=>.5-Math.random()));let s=[];for(let e=0;e<this.cards.count.level3;e++)s.push(e);s.sort((()=>.5-Math.random())),this.cards.all_cards.level1=e,this.cards.all_cards.level2=t,this.cards.all_cards.level3=s}init_cards_from_web(){this.cards.all_cards.level1=this.playground.config.base_level1_list,this.cards.all_cards.level2=this.playground.config.base_level2_list,this.cards.all_cards.level3=this.playground.config.base_level3_list}next_card(e,t){console.log("next card");let s=e;e="level"+e;let n=this.cards.all_cards[e].pop();if(n>=0){let i=origin_cards[e][n];this.cards.count[e]--;let o=new Card(this,i,20,75+238*(s-1),s,t);console.log("next "+e+" card | now "+e+" cards count:"+this.cards.count[e]),this.cards.instance.push(o),this.cards.board_cards[e][t]=o,o.move_to(20+190*(t+1),75+238*(s-1))}}update(){this.render()}render(){let e=238;for(let t=1;t<=3;t++){this.sm.shader_card_back(20,75+(t-1)*e,t-1,5),this.sm.shader_top_back(20,75+(t-1)*e,[1,1,1,.5]);let s=this.cards.count["level"+t];s>0&&s<10?this.sm.shader_score(20,75+(t-1)*e,s-1):s>=10&&this.sm.shader_score(20,75+(t-1)*e,9)}}click_card(e,t){for(let s in this.cards.instance)if(this.cards.instance[s].clicked(e,t))return this.cards.instance[s];return null}}class SplendorChat{constructor(e){this.playground=e,this.start()}start(){this.$history=$('\n        <div class="chat-history">\n        \n        </div>\n        '),this.$input=$("\n        <input type='text' class=\"chat-input\">\n        \n        "),this.$chat_img=$("<div class='chat-img'></div>"),this.playground.$playground_div.append(this.$history),this.playground.$playground_div.append(this.$input),this.playground.$playground_div.append(this.$chat_img),this.add_listening_events()}to_clear(){this.$chat_img.css("background","url("+BASE_URL+"/static/splendor/images/playground/up.svg)"),this.$chat_img.css("background-size","cover")}to_has_message(){this.$chat_img.css("background","url("+BASE_URL+"/static/splendor/images/playground/up_to.svg)"),this.$chat_img.css("background-size","cover")}add_listening_events(){this.$history.on("mouseenter",(()=>{this.$history.fadeIn(),this.$history.scrollTop(this.$history[0].scrollHeight),this.$input.hide(),this.to_clear()})).on("mouseleave",(()=>{this.$history.hide(),this.$input.hide(),this.to_clear()})),this.$chat_img.on("mouseenter",(()=>{this.$history.fadeIn(),this.$history.scrollTop(this.$history[0].scrollHeight),this.$input.hide(),this.to_clear()})).on("mouseleave",(()=>{this.$history.hide(),this.$input.hide(),this.to_clear()})),this.playground.$canvas.keydown((e=>{if(13===e.which)this.$input.show(),this.$input.focus(),this.$history.fadeIn(),this.$history.scrollTop(this.$history[0].scrollHeight),this.$chat_img.hide();else if(27===e.which)return this.$input.hide(),this.$history.hide(),this.$chat_img.show(),this.playground.$canvas.focus(),!1})),this.$input.keydown((e=>{if(27===e.which)return this.$input.hide(),this.$history.hide(),this.$chat_img.show(),this.playground.$canvas.focus(),!1;if(13===e.which){let e=this.playground.players_manager.get_me().email,t=this.$input.val();return t&&(this.$input.val(""),this.send_message(e,t),this.playground.socket&&this.playground.socket.send_message(e,t)),!1}}))}send_message(e,t){this.to_has_message(),t=`[${this.playground.players_manager.get_player(e).name}] ${t}`,this.$history.append(this.render_message(t,e)),this.$history.scrollTop(this.$history[0].scrollHeight)}render_message(e,t){return t===this.playground.players_manager.get_me().email?$(`<div style="color: LightPink">${e}</div>`):$(`<div style="color: red">${e}</div>`)}}class Noble extends GameObject{constructor(e,t,s){super(),this.nm=e,this.sm=this.nm.sm,this.noble_config=t,this.state="board",this.role=null;this.x=1070,this.y=77+175*s,this.vx=0,this.vy=0,this.move_length=0,this.speed=800,this.scale=1}start(){}change_state(e){this.state=e}change_scale(e){this.scale=e}get_dist(e,t,s,n){let i=(s-e)*(s-e),o=(n-t)*(n-t);return Math.sqrt(i+o)}move_to(e,t){this.move_length=this.get_dist(e,t,this.x,this.y);let s=Math.atan2(t-this.y,e-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}update_x_y(){let e=Math.min(this.move_length,this.speed*this.timedelta*.001);this.move_length-=e,this.x+=e*this.vx,this.y+=e*this.vy}update(){this.update_x_y(),this.render()}render(){let e=90*this.scale,t=54*this.scale;this.sm.shader_noble(this.x,this.y,this.noble_config.backIndex[1],this.noble_config.backIndex[0],{scale:this.scale}),this.sm.shader_score(this.x+e,this.y,this.noble_config.score-1,{scale:this.scale}),this.sm.shader_top_back(this.x+t,this.y,[1,1,1,.2],{scale_x:140,rotation:Math.PI/2*3,scale:this.scale});let s=1,n=45*this.scale,i=10*this.scale,o=10*this.scale,a=145*this.scale;for(let e in this.noble_config.spend){let t=this.noble_config.spend[e],r=NSColor2Index[t.color],c=GemColor2Index[t.color],l=t.need-1;this.sm.shader_mini_card_back(this.x+o,this.y+a-n*s,r,{scale:this.scale}),this.sm.shader_score(this.x+o,this.y+a-n*s,l,{scale_x:35,scale_y:35,scale:this.scale}),this.sm.shader_gem(this.x+o+2.5*i,this.y+a+o-n*s,c,{scale_x:15,scale_y:15,scale:this.scale}),s++}}}class NoblesManager{constructor(e){this.playground=e,this.sm=this.playground.shader_manager,this.nobleLength=Math.min(4,this.playground.player_number+1),this.noblesIndex=[],this.nobles=[],this.start()}init_nobles(){"单人"!==this.playground.mode?this.init_nobles_from_web():this.init_nobles_from_local()}init_nobles_from_local(){let e=[];for(let t=0;t<origin_nobles.length;t++)e.push(t);e.sort((()=>.5-Math.random())),this.noblesIndex=e.slice(0,this.nobleLength)}init_nobles_from_web(){let e=this.playground.config.base_nobles;this.noblesIndex=e.slice(0,this.nobleLength)}can_get_one(e){if(!e.can_get_one())return!1;let t=-1;for(let s in this.nobles){let n=this.nobles[s].noble_config.spend,i=!0;for(let t in n){let s=n[t].color,o=n[t].need;if(e.cards[s]<o){i=!1;break}}if(i){t=s;break}}if(-1===t)return!1;let s=this.nobles[t];return this.nobles.splice(t,1),s.change_scale(.3),s.change_state("player"),s.role=e.email,s.move_to(e.x+135+20,e.y+100),e.update_nobles(s),!0}start(){this.init_nobles();for(let e=0;e<this.noblesIndex.length;e++)this.nobles.push(new Noble(this,origin_nobles[this.noblesIndex[e]],e))}}class Player extends GameObject{constructor(e,t,s){super(),this.pm=e,this.sm=this.pm.sm,this.character=t.character,this.email=t.email,this.name=t.name,this.game_score=t.game_score,this.score=t.score,this.photo=t.photo,this.tokens_count=0,this.tokens={G:0,W:0,B:0,I:0,R:0,O:0},this.cards={G:0,W:0,B:0,I:0,R:0},this.books=[],this.nobles=[],this.index=s;this.x=1285,this.y=77+160*this.index}do(){let e=this.pm.playground;for(let t in e.cards_manager.cards.instance){let s=e.cards_manager.cards.instance[t];if(("book"===s.state&&s.role===this.email||"board"===s.state)&&s.can_buy(this))return void s.buy_by_player(this,!1)}for(let t in e.tokens_manager.tokens){if("O"===t)break;if(e.tokens_manager.tokens[t].count>=4&&this.tokens_count<=8){let s={};return s[t]=2,e.tokens_manager.picked_by_player_from_tokens(this,s),void this.pm.next_player()}}let t=Math.min(3,10-this.tokens_count),s={};for(let n in e.tokens_manager.tokens){if("O"===n)break;if(e.tokens_manager.tokens[n].count>0&&t>0&&(s[n]=1,t--),!t)break}if(!$.isEmptyObject(s))return e.tokens_manager.picked_by_player_from_tokens(this,s),void this.pm.next_player();for(let t in e.cards_manager.cards.instance){let s=e.cards_manager.cards.instance[t];if("board"===s.state&&s.can_book(this))return void s.book_by_player(this,!1)}this.pass(!0)}add_pass_count(){this.pass_count++,this.pass_count>=3&&(this.state="offline")}pass(e=!1){e||this.pm.playground.socket&&this.pm.playground.socket.send_pass(this.email),this.pm.next_player()}getIndex(){return this.index}update_score(e){let t=this.pm.playground;this.game_score+=e,console.log(this.game_score),t.top_board.change_game_score(this,this.game_score),this.game_score>=15&&"round"===t.state&&(t.state="last_round")}update_tokens(e,t){this.tokens[e]+=t,this.tokens_count+=t}update_cards(e,t,s){this.cards[t]+=s,this.update_score(e.card_config.score)}update_books(e,t){if("buy"===e){this.update_cards(t,t.card_config.gem,1);for(let e in this.books)this.books[e]===t&&this.books.splice(e,1);t.destroy()}else{let e=5,s=45;t.change_state("book"),t.move_to(this.x+e*(this.books.length+1)+s*this.books.length,this.y+90),t.change_scale(.3),t.role=this.email,this.books.push(t)}}can_get_one(){return!(this.nobles.length>=3)}update_nobles(e){this.nobles.length<3&&(this.nobles.push(e),this.update_score(e.noble_config.score))}update(){this.render()}render_photo(){this.sm.shader_player_photo(this.email,this.x+10,this.y+10)}render_cards(){let e=1;for(let t in this.cards){let s=NSColor2Index[t],n=GemColor2Index[t],i=this.cards[t];this.sm.shader_mini_card_back(this.x+35*e+10,this.y+10,s),this.sm.shader_gem(this.x+35*e+10+25,this.y+10-5,n,{scale_x:10,scale_y:10}),i>0&&this.sm.shader_score(this.x+35*e+10,this.y+10,Math.min(9,i-1),{scale_x:35,scale_y:35}),e++}}render_tokens(){let e=0;for(let t in this.tokens){let s=TokenColor2Index[t],n=this.tokens[t];this.sm.shader_token(this.x+42*e+5,this.y+50,s,{scale_x:35,scale_y:35}),n>0&&this.sm.shader_score(this.x+42*e+5,this.y+50-3,n-1,{scale_x:35,scale_y:35}),e++}}render_books(){for(let e in this.books)this.books[e].update()}render_nobles(){for(let e in this.nobles)this.nobles[e].update();this.nobles.length>0&&this.sm.shader_score(this.x+135+20,this.y+100,this.nobles.length-1,{scale_x:40,scale_y:40})}render(){this.sm.shader_top_back(this.x,this.y,[0,0,0,.5],{scale_x:260,scale_y:150}),this.render_photo(),this.render_cards(),this.render_tokens(),this.render_books(),this.render_nobles()}}class PlayersManager{constructor(e){this.playground=e,this.sm=this.playground.shader_manager,this.number=this.playground.player_number,this.players_config=[],this.players=[],this.roundi=-1,this.round=0,this.start()}start(){for(let e in this.playground.players){let t=this.playground.players[e];this.players_config.push({index:e,email:t.email,name:t.name,photo:t.photo,character:t.character,game_score:t.game_score,score:t.score})}for(let e=0;e<this.number;e++){let t=new Player(this,this.players_config[e],e);"me"===this.players_config[e].character&&(this.me=t),this.players.push(t)}}get_me(){return this.me}get_player(e){for(let t in this.players){let s=this.players[t];if(s.email===e)return s}}is_me_round(){return this.roundi===this.get_me().getIndex()}next_player(){if(this.roundi>=0&&this.playground.nobles_manager.can_get_one(this.players[this.roundi]),this.playground.top_board.clear_interval("tick"),this.playground.top_board.$token_click.hide(),this.playground.top_board.$click_card.hide(),this.playground.tokens_manager.select_tokens.length>0&&this.playground.tokens_manager.unselect_by_player(),"last_round"===this.playground.state&&this.roundi===this.number-1&&this.playground.statistics(this.players),"round"===this.playground.state||"last_round"===this.playground.state){this.roundi=(this.roundi+1)%this.number;let e=this.players[this.roundi];this.playground.top_board.add_tick(e),0===this.roundi&&this.round++,"round"===this.playground.state?console.log("round "+this.round+" | now: "+this.players[this.roundi].name):"last_round"===this.playground.state&&console.log("last round  | now: "+this.players[this.roundi].name)}}}class Token extends GameObject{constructor(e,t,s,n){super(),this.tm=e,this.sm=this.tm.sm,this.color=t,this.x=s,this.y=n,this.vx=0,this.vy=0,this.move_length=0,this.speed=800,this.state="board"}get_dist(e,t,s,n){let i=(s-e)*(s-e),o=(n-t)*(n-t);return Math.sqrt(i+o)}move_to(e,t){this.move_length=this.get_dist(e,t,this.x,this.y);let s=Math.atan2(t-this.y,e-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}update_x_y(){let e=Math.min(this.move_length,this.speed*this.timedelta*.001);this.move_length-=e,this.x+=e*this.vx,this.y+=e*this.vy}start(){}change_state(e){this.state=e}update(){"unshow"!==this.state&&(this.update_x_y(),this.render()),"on_de"===this.state&&0===this.move_length&&this.destroy()}render(){this.sm.shader_token(this.x,this.y,TokenColor2Index[this.color])}}class TokensManager extends GameObject{constructor(e){super(),this.playground=e,this.sm=this.playground.shader_manager;let t=0;switch(this.playground.player_number){case 2:t=4;break;case 3:t=5;break;default:t=7}this.tokens={G:{count:t,instance:[],offset:[970,100]},W:{count:t,instance:[],offset:[970,215]},B:{count:t,instance:[],offset:[970,330]},I:{count:t,instance:[],offset:[970,445]},R:{count:t,instance:[],offset:[970,560]},O:{count:5,instance:[],offset:[970,675]}},this.select_tokens=[],this.offset_x=970,this.offset_y=100,this.y_step=115,this.t_step=5,this.width=70,this.height=70}click_token(e,t){for(let s in this.tokens){let n=this.tokens[s].offset;if(e>=n[0]&&t>=n[1]&&e<=n[0]+this.width&&t<=n[1]+this.height)return"O"===s||this.tokens[s].count<=0||this.playground.players_manager.get_me().tokens_count>=10?null:s}return null}select_by_player(e){if(0===this.select_tokens.length&&this.tokens[e].count>0)this.playground.top_board.add_token_click();else if(1===this.select_tokens.length){if(this.select_tokens[0].color===e&&this.tokens[e].count<3)return!1}else if(2===this.select_tokens.length){if(this.select_tokens[0].color===this.select_tokens[1].color)return!1;for(let t in this.select_tokens)if(this.select_tokens[t].color===e)return!1}else if(3===this.select_tokens.length)return!1;if(this.select_tokens.length+this.playground.players_manager.get_me().tokens_count+1>10)return!1;if(this.tokens[e].count>0){this.tokens[e].count--;let t=this.tokens[e].offset,s=new Token(this,e,t[0],t[1]);return this.select_tokens.push(s),s.move_to(900+this.select_tokens.length*this.width,5),!0}return!1}unselect_by_player(){for(let e in this.select_tokens){let t=this.tokens[this.select_tokens[e].color].offset;this.tokens[this.select_tokens[e].color].count++,this.select_tokens[e].move_to(t[0],t[1])}for(let e in this.select_tokens)this.select_tokens[e].change_state("on_de");this.select_tokens=[]}picked_by_player_from_tokens(e,t){for(let s in t)if(this.tokens[s].count>=t[s]){this.tokens[s].count-=t[s];let n=this.tokens[s].offset;for(let i=0;i<t[s];i++){let t=new Token(this,s,n[0],n[1]);t.move_to(e.x,e.y),t.change_state("on_de"),e.update_tokens(s,1)}}}picked_by_me(){let e=this.playground.players_manager.get_me(),t={};for(let s in this.select_tokens)this.select_tokens[s].move_to(e.x,e.y),e.update_tokens(this.select_tokens[s].color,1),t[this.select_tokens[s].color]?t[this.select_tokens[s].color]++:t[this.select_tokens[s].color]=1,this.select_tokens[s].change_state("on_de");this.select_tokens=[],this.playground.socket&&this.playground.socket.send_get_tokens(e.email,t),this.playground.players_manager.next_player()}used_by_player(e,t){for(let s in t){let n=t[s];e.update_tokens(s,-n);for(let t=0;t<n;t++){let t=this.tokens[s].offset,n=new Token(this,s,e.x,e.y);n.move_to(t[0],t[1]),n.change_state("on_de"),this.tokens[s].count++}}}start(){let e=0,t=this.offset_x,s=this.offset_y,n=this.y_step,i=this.t_step;for(let o in this.tokens){for(let a=0;a<3;a++)this.tokens[o].instance.push(new Token(this,o,t,s+e*n-i*a));e++}}update(){for(let e in this.tokens){for(let t=0;t<Math.min(3,this.tokens[e].count);t++)this.tokens[e].instance[t].change_state("board");for(let t=Math.min(3,this.tokens[e].count);t<3;t++)this.tokens[e].instance[t].change_state("unshow")}}late_update(){let e=0,t=this.offset_x,s=this.offset_y,n=this.y_step;for(let i in this.tokens)this.tokens[i].count>0&&this.render(this.tokens[i].count,t-15,s+e*n-15),e++}render(e,t,s){this.sm.shader_score(t,s,e-1,{scale_x:40,scale_y:40})}}class TopBoard{constructor(e){this.playground=e,this.room_id=this.playground.room_id,this.time=0,this.player_time=this.playground.round_second,this.$top_board=$("\n<div class='top-board'>\n    <div class='top-board-center'>\n    <span>00:00</span>\n    </div>\n    <div class='top-board-out'>\n        <button>退出游戏</button>\n    </div>\n</div>        \n"),this.$token_click=$("\n<div class='token-click'>\n        <button class='pick'>确定</button>\n        <button class='cancel'>取消</button>\n</div>        \n"),this.$click_card=$("\n<div class='card-click'>\n    <div class='element buy'>\n    购买\n    </div>        \n    <div class='element book'>\n    预定\n    </div>\n    <div class='element cancle'>\n    取消\n    </div>\n</div>\n"),this.$error_message=$("\n<div class='error-message'>\n</div>        \n"),this.$game_score=$("\n<div class='game-score-list'>\n</div>\n"),this.$player_tick=$("\n<div class='player-tick'>\n</div>\n"),this.$pass_click=$("\n<div class='pass-click'>\n跳过\n</div>\n");for(let e in this.playground.players){let t=this.playground.players[e];this.$game_score.append(`<div class='game-score' name=${t.email}>\n            0\n            </div>`)}this.playground.$playground_div.append(this.$top_board),this.playground.$playground_div.append(this.$click_card),this.playground.$playground_div.append(this.$error_message),this.playground.$playground_div.append(this.$token_click),this.playground.$playground_div.append(this.$game_score),this.playground.$playground_div.append(this.$player_tick),this.playground.$playground_div.append(this.$pass_click),this.start()}add_listening_events(){this.time_func=setInterval((()=>{this.time++;let e=Math.floor(this.time/60),t=this.time%60;t<10&&(t="0"+t),e<10&&(e="0"+e),this.$top_board.find(".top-board-center > span").text(e+":"+t)}),1e3),this.$top_board.find(".top-board-out").on("click",(()=>{window.location.reload()})),this.$token_click.find(".cancel").on("click",(()=>{this.playground.tokens_manager.unselect_by_player(),this.click_card_remove_no_click(),this.click_card_remove_scale(),this.$token_click.hide()})),this.$token_click.find(".pick").on("click",(()=>{this.playground.tokens_manager.picked_by_me(),this.click_card_remove_no_click(),this.click_card_remove_scale(),this.$token_click.hide()})),this.$click_card.find(".cancle").on("click",(()=>{this.click_card_remove_no_click(),this.click_card_remove_scale(),this.$click_card.hide()})),this.$click_card.find(".book").on("click",(()=>{if(this.$click_card.find(".book").hasClass("no-click"))return!1;let e=this.playground.players_manager.get_me();this.card.book_by_player(e),this.$click_card.hide()})),this.$click_card.find(".buy").on("click",(()=>{if(this.$click_card.find(".buy").hasClass("no-click"))return!1;let e=this.playground.players_manager.get_me();this.card.buy_by_player(e),this.$click_card.hide()})),this.$pass_click.on("click",(()=>{let e=this.playground.players_manager.is_me_round(),t=this.playground.players_manager.get_me();e&&t.pass()}))}is_show(e){return"click_card"===e?"block"===this.$click_card.css("display"):"token_click"===e?"block"===this.$token_click.css("display"):void 0}add_tick(e){this.clear_interval("tick"),this.$player_tick.css("top",10.5*e.index+8+"vw"),this.$player_tick.show(),"me"===e.character&&this.$pass_click.show(),"robot"===e.character&&(e.timeout_func=setTimeout((()=>{e.do()}),3e3)),this.$player_tick.text(this.player_time),this.tick_func=setInterval((()=>{this.player_time--,this.$player_tick.text(this.player_time),0===this.player_time&&(this.clear_interval("tick"),e.do())}),1e3)}clear_interval(e="time"){"time"===e?clearInterval(this.time_func):"tick"===e&&(this.$pass_click.hide(),this.$player_tick.empty(),this.$player_tick.hide(),this.player_time=this.playground.round_second,this.tick_func&&clearInterval(this.tick_func))}click_card_add_scale(){this.$click_card.find(".book").addClass("element-book"),this.$click_card.find(".buy").addClass("element-book"),this.$click_card.find(".cancle").addClass("element-book")}click_card_remove_scale(){this.$click_card.find(".buy").hasClass("element-book")&&this.$click_card.find(".buy").removeClass("element-book"),this.$click_card.find(".book").hasClass("element-book")&&this.$click_card.find(".book").removeClass("element-book"),this.$click_card.find(".cancle").hasClass("element-book")&&this.$click_card.find(".cancle").removeClass("element-book")}click_card_remove_no_click(){this.$click_card.find(".book").hasClass("no-click")&&this.$click_card.find(".book").removeClass("no-click"),this.$click_card.find(".buy").hasClass("no-click")&&this.$click_card.find(".buy").removeClass("no-click")}click_card(e){let t=this.playground.players_manager.get_me();this.card=e,this.card.can_book(t)||this.$click_card.find(".book").addClass("no-click"),this.card.can_buy(t)||this.$click_card.find(".buy").addClass("no-click"),"book"===this.card.state?(this.click_card_add_scale(),this.$click_card.css({left:e.x+150*e.scale,top:e.y-90})):this.$click_card.css({left:e.x+150*e.scale,top:e.y}),this.$click_card.fadeIn()}add_error_message(e,t,s){this.$error_message.css({left:t,top:s}),this.$error_message.text(e),this.$error_message.show(),this.$error_message.animate({top:s-50+"px"},"normal","linear"),this.$error_message.fadeOut()}add_token_click(){this.$token_click.show()}change_game_score(e,t){let s=e.email;this.$game_score.find(`[name='${s}']`).text(t)}start(){this.add_listening_events()}}let m3={projection:function(e,t){return[2/e,0,0,0,-2/t,0,-1,1,1]},identity:function(){return[1,0,0,0,1,0,0,0,1]},translation:function(e,t){return[1,0,0,0,1,0,e,t,1]},rotation:function(e){var t=Math.cos(e),s=Math.sin(e);return[t,-s,0,s,t,0,0,0,1]},scaling:function(e,t){return[e,0,0,0,t,0,0,0,1]},multiply:function(e,t){var s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],r=e[5],c=e[6],l=e[7],d=e[8],h=t[0],_=t[1],m=t[2],g=t[3],p=t[4],u=t[5],k=t[6],b=t[7],y=t[8];return[h*s+_*o+m*c,h*n+_*a+m*l,h*i+_*r+m*d,g*s+p*o+u*c,g*n+p*a+u*l,g*i+p*r+u*d,k*s+b*o+y*c,k*n+b*a+y*l,k*i+b*r+y*d]}};function get_matrix(e,t,s,n,i){let o=m3.identity();return i||(o=m3.projection(e.canvas.clientWidth,e.canvas.clientHeight)),o=m3.multiply(o,m3.translation(t[0],t[1])),o=m3.multiply(o,m3.rotation(s)),o=m3.multiply(o,m3.scaling(n[0],n[1])),o}let W="W",B="B",I="I",R="R",G="G",O="O",GemColor2Index={W:0,B:1,I:2,R:3,G:4},NSColor2Index={W:1,B:2,I:0,R:4,G:3},TokenColor2Index={W:1,B:2,I:3,R:4,G:0,O:5},origin_nobles=[{id:41,score:3,backIndex:[0,0],spend:[{color:"I",need:4},{color:"R",need:4}]},{id:42,score:3,backIndex:[0,1],spend:[{color:"R",need:4},{color:"G",need:4}]},{id:43,score:3,backIndex:[0,2],spend:[{color:"G",need:4},{color:"B",need:4}]},{id:44,score:3,backIndex:[0,3],spend:[{color:"B",need:4},{color:"W",need:4}]},{id:45,score:3,backIndex:[0,4],spend:[{color:"W",need:4},{color:"I",need:4}]},{id:46,score:3,backIndex:[1,0],spend:[{color:"I",need:3},{color:"R",need:3},{color:"G",need:3}]},{id:47,score:3,backIndex:[1,1],spend:[{color:"R",need:3},{color:"G",need:3},{color:"B",need:3}]},{id:48,score:3,backIndex:[1,2],spend:[{color:"G",need:3},{color:"B",need:3},{color:"W",need:3}]},{id:49,score:3,backIndex:[1,3],spend:[{color:"B",need:3},{color:"W",need:3},{color:"I",need:3}]},{id:410,score:3,backIndex:[1,4],spend:[{color:"W",need:3},{color:"I",need:3},{color:"R",need:3}]}],origin_cards={level1:[{id:11,score:1,gem:"I",backIndex:[1,3],spend:[{color:"B",need:4}]},{id:12,score:1,gem:"R",backIndex:[2,2],spend:[{color:"W",need:4}]},{id:13,score:1,gem:"G",backIndex:[4,1],spend:[{color:"I",need:4}]},{id:14,score:1,gem:"B",backIndex:[4,1],spend:[{color:"R",need:4}]},{id:15,score:1,gem:"W",backIndex:[4,2],spend:[{color:"G",need:4}]},{id:16,score:0,gem:"G",backIndex:[4,2],spend:[{color:"B",need:3},{color:"G",need:1},{color:"W",need:1}]},{id:17,score:0,gem:"B",backIndex:[3,3],spend:[{color:"G",need:3},{color:"B",need:1},{color:"R",need:1}]},{id:18,score:0,gem:"W",backIndex:[1,3],spend:[{color:"W",need:3},{color:"I",need:1},{color:"B",need:1}]},{id:19,score:0,gem:"I",backIndex:[1,2],spend:[{color:"R",need:3},{color:"I",need:1},{color:"G",need:1}]},{id:110,score:0,gem:"R",backIndex:[2,3],spend:[{color:"I",need:3},{color:"R",need:1},{color:"W",need:1}]},{id:111,score:0,gem:"I",backIndex:[3,3],spend:[{color:"B",need:2},{color:"W",need:2},{color:"R",need:1}]},{id:112,score:0,gem:"R",backIndex:[2,2],spend:[{color:"W",need:2},{color:"I",need:2},{color:"G",need:1}]},{id:113,score:0,gem:"G",backIndex:[2,2],spend:[{color:"I",need:2},{color:"R",need:2},{color:"B",need:1}]},{id:114,score:0,gem:"B",backIndex:[3,1],spend:[{color:"R",need:2},{color:"G",need:2},{color:"W",need:1}]},{id:115,score:0,gem:"W",backIndex:[3,0],spend:[{color:"G",need:2},{color:"B",need:2},{color:"I",need:1}]},{id:116,score:0,gem:"I",backIndex:[1,4],spend:[{color:"B",need:2},{color:"W",need:1},{color:"R",need:1},{color:"G",need:1}]},{id:117,score:0,gem:"R",backIndex:[0,0],spend:[{color:"W",need:2},{color:"I",need:1},{color:"G",need:1},{color:"B",need:1}]},{id:118,score:0,gem:"G",backIndex:[4,1],spend:[{color:"I",need:2},{color:"R",need:1},{color:"B",need:1},{color:"W",need:1}]},{id:119,score:0,gem:"B",backIndex:[3,3],spend:[{color:"R",need:2},{color:"G",need:1},{color:"W",need:1},{color:"I",need:1}]},{id:120,score:0,gem:"W",backIndex:[0,1],spend:[{color:"G",need:2},{color:"B",need:1},{color:"I",need:1},{color:"R",need:1}]},{id:121,score:0,gem:"G",backIndex:[2,0],spend:[{color:"B",need:2},{color:"R",need:2}]},{id:122,score:0,gem:"B",backIndex:[3,2],spend:[{color:"I",need:2},{color:"G",need:2}]},{id:123,score:0,gem:"W",backIndex:[1,0],spend:[{color:"I",need:2},{color:"B",need:2}]},{id:124,score:0,gem:"I",backIndex:[1,1],spend:[{color:"G",need:2},{color:"W",need:2}]},{id:125,score:0,gem:"R",backIndex:[3,1],spend:[{color:"R",need:2},{color:"W",need:2}]},{id:126,score:0,gem:"I",backIndex:[1,1],spend:[{color:"R",need:1},{color:"G",need:1},{color:"W",need:1},{color:"B",need:1}]},{id:127,score:0,gem:"R",backIndex:[2,4],spend:[{color:"G",need:1},{color:"B",need:1},{color:"I",need:1},{color:"W",need:1}]},{id:128,score:0,gem:"G",backIndex:[3,1],spend:[{color:"B",need:1},{color:"W",need:1},{color:"R",need:1},{color:"I",need:1}]},{id:129,score:0,gem:"B",backIndex:[1,0],spend:[{color:"W",need:1},{color:"I",need:1},{color:"G",need:1},{color:"R",need:1}]},{id:130,score:0,gem:"W",backIndex:[0,2],spend:[{color:"I",need:1},{color:"R",need:1},{color:"B",need:1},{color:"G",need:1}]},{id:131,score:0,gem:"G",backIndex:[2,3],spend:[{color:"R",need:3}]},{id:132,score:0,gem:"B",backIndex:[2,0],spend:[{color:"I",need:3}]},{id:133,score:0,gem:"W",backIndex:[1,0],spend:[{color:"B",need:3}]},{id:134,score:0,gem:"I",backIndex:[0,2],spend:[{color:"G",need:3}]},{id:135,score:0,gem:"R",backIndex:[1,2],spend:[{color:"W",need:3}]},{id:136,score:0,gem:"I",backIndex:[4,2],spend:[{color:"G",need:2},{color:"R",need:1}]},{id:137,score:0,gem:"R",backIndex:[2,0],spend:[{color:"B",need:2},{color:"G",need:1}]},{id:138,score:0,gem:"G",backIndex:[2,1],spend:[{color:"W",need:2},{color:"B",need:1}]},{id:139,score:0,gem:"B",backIndex:[1,1],spend:[{color:"I",need:2},{color:"W",need:1}]},{id:140,score:0,gem:"W",backIndex:[0,0],spend:[{color:"R",need:2},{color:"I",need:1}]}],level2:[{id:21,score:3,gem:"I",backIndex:[2,3],spend:[{color:"I",need:6}]},{id:22,score:3,gem:"R",backIndex:[1,0],spend:[{color:"R",need:6}]},{id:23,score:3,gem:"G",backIndex:[0,3],spend:[{color:"G",need:6}]},{id:24,score:3,gem:"B",backIndex:[3,3],spend:[{color:"B",need:6}]},{id:25,score:3,gem:"W",backIndex:[1,1],spend:[{color:"W",need:6}]},{id:26,score:2,gem:"G",backIndex:[0,3],spend:[{color:"G",need:3},{color:"B",need:5}]},{id:27,score:2,gem:"B",backIndex:[4,3],spend:[{color:"B",need:3},{color:"W",need:5}]},{id:28,score:2,gem:"W",backIndex:[1,1],spend:[{color:"I",need:3},{color:"R",need:5}]},{id:29,score:2,gem:"I",backIndex:[1,0],spend:[{color:"R",need:3},{color:"G",need:5}]},{id:210,score:2,gem:"R",backIndex:[4,4],spend:[{color:"W",need:3},{color:"I",need:5}]},{id:211,score:2,gem:"G",backIndex:[3,1],spend:[{color:"G",need:5}]},{id:212,score:2,gem:"B",backIndex:[4,2],spend:[{color:"B",need:5}]},{id:213,score:2,gem:"W",backIndex:[2,0],spend:[{color:"R",need:5}]},{id:214,score:2,gem:"I",backIndex:[0,2],spend:[{color:"W",need:5}]},{id:215,score:2,gem:"R",backIndex:[0,2],spend:[{color:"I",need:5}]},{id:216,score:2,gem:"I",backIndex:[4,1],spend:[{color:"G",need:4},{color:"R",need:2},{color:"B",need:1}]},{id:217,score:2,gem:"R",backIndex:[3,4],spend:[{color:"B",need:4},{color:"G",need:2},{color:"W",need:1}]},{id:218,score:2,gem:"G",backIndex:[2,4],spend:[{color:"W",need:4},{color:"B",need:2},{color:"I",need:1}]},{id:219,score:2,gem:"B",backIndex:[0,2],spend:[{color:"I",need:4},{color:"W",need:2},{color:"R",need:1}]},{id:220,score:2,gem:"W",backIndex:[1,0],spend:[{color:"R",need:4},{color:"I",need:2},{color:"G",need:1}]},{id:221,score:1,gem:"I",backIndex:[4,2],spend:[{color:"G",need:3},{color:"W",need:3},{color:"I",need:2}]},{id:222,score:1,gem:"R",backIndex:[0,0],spend:[{color:"B",need:3},{color:"I",need:3},{color:"R",need:2}]},{id:223,score:1,gem:"G",backIndex:[4,1],spend:[{color:"W",need:3},{color:"R",need:3},{color:"G",need:2}]},{id:224,score:1,gem:"B",backIndex:[3,1],spend:[{color:"I",need:3},{color:"G",need:3},{color:"B",need:2}]},{id:225,score:1,gem:"W",backIndex:[4,1],spend:[{color:"R",need:3},{color:"B",need:3},{color:"W",need:2}]},{id:226,score:1,gem:"G",backIndex:[3,4],spend:[{color:"B",need:3},{color:"W",need:2},{color:"I",need:2}]},{id:227,score:1,gem:"B",backIndex:[2,1],spend:[{color:"R",need:3},{color:"G",need:2},{color:"B",need:2}]},{id:228,score:1,gem:"W",backIndex:[2,2],spend:[{color:"G",need:3},{color:"I",need:2},{color:"R",need:2}]},{id:229,score:1,gem:"I",backIndex:[1,3],spend:[{color:"W",need:3},{color:"G",need:2},{color:"B",need:2}]},{id:230,score:1,gem:"R",backIndex:[4,2],spend:[{color:"I",need:3},{color:"W",need:2},{color:"R",need:2}]}],level3:[{id:31,score:5,gem:"I",backIndex:[2,4],spend:[{color:"I",need:3},{color:"R",need:7}]},{id:32,score:5,gem:"R",backIndex:[3,4],spend:[{color:"R",need:3},{color:"G",need:7}]},{id:33,score:5,gem:"G",backIndex:[2,1],spend:[{color:"G",need:3},{color:"B",need:7}]},{id:34,score:5,gem:"B",backIndex:[0,2],spend:[{color:"B",need:3},{color:"W",need:7}]},{id:35,score:5,gem:"W",backIndex:[1,2],spend:[{color:"W",need:3},{color:"I",need:7}]},{id:36,score:4,gem:"I",backIndex:[0,0],spend:[{color:"I",need:7}]},{id:37,score:4,gem:"R",backIndex:[1,4],spend:[{color:"R",need:7}]},{id:38,score:4,gem:"G",backIndex:[4,4],spend:[{color:"G",need:7}]},{id:39,score:4,gem:"B",backIndex:[2,4],spend:[{color:"B",need:7}]},{id:310,score:4,gem:"W",backIndex:[3,3],spend:[{color:"W",need:7}]},{id:311,score:4,gem:"I",backIndex:[4,4],spend:[{color:"I",need:3},{color:"R",need:6},{color:"G",need:3}]},{id:312,score:4,gem:"R",backIndex:[3,3],spend:[{color:"R",need:3},{color:"G",need:6},{color:"B",need:3}]},{id:313,score:4,gem:"G",backIndex:[4,4],spend:[{color:"G",need:3},{color:"B",need:6},{color:"W",need:3}]},{id:314,score:4,gem:"B",backIndex:[4,4],spend:[{color:"B",need:3},{color:"W",need:6},{color:"I",need:3}]},{id:315,score:4,gem:"W",backIndex:[2,1],spend:[{color:"W",need:3},{color:"I",need:6},{color:"R",need:3}]},{id:316,score:3,gem:"I",backIndex:[0,3],spend:[{color:"G",need:5},{color:"R",need:3},{color:"W",need:3},{color:"B",need:3}]},{id:317,score:3,gem:"R",backIndex:[3,3],spend:[{color:"B",need:5},{color:"G",need:3},{color:"I",need:3},{color:"W",need:3}]},{id:318,score:3,gem:"G",backIndex:[1,2],spend:[{color:"W",need:5},{color:"B",need:3},{color:"R",need:3},{color:"I",need:3}]},{id:319,score:3,gem:"B",backIndex:[2,1],spend:[{color:"I",need:5},{color:"W",need:3},{color:"G",need:3},{color:"R",need:3}]},{id:320,score:3,gem:"W",backIndex:[0,4],spend:[{color:"R",need:5},{color:"I",need:3},{color:"B",need:3},{color:"G",need:3}]}]};class ImageShader{constructor(e){this.sm=e,this.gl=this.sm.gl,this.name="ImageShader",this.sm.shader_dict[this.name]=this,console.log("loading shader",this.name),this.init()}shader_text(){this.vs="\n        attribute vec2 a_position;\n        attribute vec2 a_texCoord;\n\n        uniform mat3 u_position_matrix;\n        uniform mat3 u_texCoord_matrix;\n        \n        varying vec2 v_texCoord;\n        \n        void main() {\n            gl_Position = vec4((u_position_matrix * vec3(a_position, 1)).xy, 0, 1);\n            v_texCoord = (u_texCoord_matrix * vec3(a_texCoord, 1)).xy;\n        }\n        ",this.fs="\n        precision mediump float;\n        \n        uniform sampler2D u_image;\n        \n        varying vec2 v_texCoord;\n        \n        void main() {\n            gl_FragColor = texture2D(u_image, v_texCoord);\n        }\n        "}init(){const e=this.gl,t=this.sm;this.shader_text();let s=t.createProgramFromText(e,this.vs,this.fs),n=e.getAttribLocation(s,"a_position"),i=e.getAttribLocation(s,"a_texCoord"),o=e.getUniformLocation(s,"u_resolution"),a=e.getUniformLocation(s,"u_position_matrix"),r=e.getUniformLocation(s,"u_texCoord_matrix"),c=e.getUniformLocation(s,"u_image");const l=new Float32Array(t.get_point_from(0,0,1,1)),d=new Float32Array(t.get_point_from(0,0,1,1)),h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,l,e.STATIC_DRAW);const _=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,_),e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW);let m={program:s,a_position:{loc:n,buffer:h},a_texCoord:{loc:i,buffer:_},u_resolution:o,u_image:c,u_position_matrix:a,u_texCoord_matrix:r};this.programInfo=m}draw(e,t,s){const n=this.gl,i=this.sm;let o=this.programInfo;i.resize(n),n.viewport(0,0,n.canvas.width,n.canvas.height),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.useProgram(o.program),this.set_pointer(o),this.set_uniform(o,e,t,s),n.drawArrays(n.TRIANGLES,0,6)}set_pointer(e){const t=this.gl,s=e.a_position.loc,n=e.a_position.buffer;t.enableVertexAttribArray(s),t.bindBuffer(t.ARRAY_BUFFER,n),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0);const i=e.a_texCoord.loc,o=e.a_texCoord.buffer;t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0)}set_uniform(e,t,s,n){const i=this.gl;i.uniform2fv(e.u_resolution,[i.canvas.width,i.canvas.height]),i.uniformMatrix3fv(e.u_position_matrix,!1,s),i.uniformMatrix3fv(e.u_texCoord_matrix,!1,n);i.activeTexture(i.TEXTURE0+2),i.bindTexture(i.TEXTURE_2D,t),i.uniform1i(e.u_image,2)}}class PreProcessTexture{constructor(e){this.sm=e,this.base_url=`${BASE_URL}/static/splendor/assets`,this.texture_dict={cards:null,gems:null,nobles:null,tokens:null,numbers_sheet:null},this.start()}start(){this.preProcess()}init_texture(e){const t=this.sm.gl,s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s}preProcess(){this.texture_dict.players={};for(let e in this.texture_dict){let t=new Image;t.src=`${this.base_url}/${e}.jpg`,t.onload=()=>{this.texture_dict[e]=this.init_texture(t)}}for(let e in this.sm.playground.players){let t=this.sm.playground.players[e].photo,s=this.sm.playground.players[e].email,n=new Image;n.src=t,n.onload=()=>{this.texture_dict.players[s]=this.init_texture(n)}}}get(e){return this.texture_dict[e]}}class RectShader{constructor(e){this.sm=e,this.gl=this.sm.gl,this.name="RectShader",this.sm.shader_dict[this.name]=this,console.log("loading shader",this.name),this.init()}shader_text(){this.vs="\n            attribute vec2 a_position;\n\n            uniform mat3 u_position_matrix;\n\n            void main(){\n                gl_Position = vec4((u_position_matrix * vec3(a_position, 1)).xy, 0, 1);\n            }\n        ",this.fs="\n            precision mediump float;\n\n            uniform vec4 u_color;\n\n            void main(){\n                gl_FragColor = u_color;\n            }\n        "}init(){const e=this.gl,t=this.sm;this.shader_text();let s=t.createProgramFromText(e,this.vs,this.fs),n=e.getAttribLocation(s,"a_position"),i=e.getUniformLocation(s,"u_position_matrix"),o=e.getUniformLocation(s,"u_color");const a=new Float32Array(t.get_point_from(0,0,1,1)),r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW);let c={program:s,a_position:{loc:n,buffer:r},u_position_matrix:i,u_color:o};this.programInfo=c}draw(e,t){const s=this.gl,n=this.sm;let i=this.programInfo;n.resize(s),s.viewport(0,0,s.canvas.width,s.canvas.height),s.useProgram(i.program),this.set_pointer(i),this.set_uniform(i,e,t),s.drawArrays(s.TRIANGLES,0,6)}set_pointer(e){const t=this.gl,s=e.a_position.loc,n=e.a_position.buffer;t.enableVertexAttribArray(s),t.bindBuffer(t.ARRAY_BUFFER,n),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0)}set_uniform(e,t,s){const n=this.gl;n.uniformMatrix3fv(e.u_position_matrix,!1,t),n.uniform4fv(e.u_color,s)}}class ShaderManager{constructor(e){this.playground=e,this.gl=this.playground.gl,this.shader_dict={}}shader_player_photo(e,t,s,n){let i=this.get("ImageShader"),o=this.tm.get("players")[e],a=(n=n||{}).scale_x||30,r=n.scale_y||30,c=n.scale||1,l=n.rotation||0,d=get_matrix(this.gl,[t,s],l,[a*c,r*c],!1),h=get_matrix(this.gl,[0,0],0,[1,1],!0);i.draw(o,d,h)}shader_card_back(e,t,s,n,i){let o=this.get("ImageShader"),a=this.tm.get("cards"),r=(i=i||{}).scale_x||150,c=i.scale_y||203,l=i.rotation||0,d=i.scale||1,h=get_matrix(this.gl,[e,t],l,[r*d,c*d],!1),_=get_matrix(this.gl,[.2*s,.1666*n],0,[.1998,.1665],!0);o.draw(a,h,_)}shader_top_back(e,t,s,n){let i=this.get("RectShader"),o=(n=n||{}).rotation||0,a=n.scale_x||150,r=n.scale_y||54,c=n.scale||1,l=get_matrix(this.gl,[e,t],o,[a*c,r*c],!1);i.draw(l,s)}shader_score(e,t,s,n){let i=this.get("ImageShader"),o=this.tm.get("numbers_sheet"),a=(n=n||{}).rotation||0,r=n.scale_x||50,c=n.scale_y||50,l=n.scale||1,d=get_matrix(this.gl,[e,t],a,[r*l,c*l],!1),h=get_matrix(this.gl,[.1*s,.6666],0,[.1,.3333],!0);i.draw(o,d,h)}shader_mini_card_back(e,t,s,n){let i=this.get("ImageShader"),o=this.tm.get("numbers_sheet"),a=(n=n||{}).rotation||0,r=n.scale_x||35,c=n.scale_y||35,l=n.scale||1,d=get_matrix(this.gl,[e,t],a,[r*l,c*l],!1),h=get_matrix(this.gl,[.1*s,0],0,[.1,.3333],!0);i.draw(o,d,h)}shader_gem(e,t,s,n){let i=this.get("ImageShader"),o=this.tm.get("gems"),a=(n=n||{}).rotation||0,r=n.scale_x||45,c=n.scale_y||45,l=n.scale||1,d=get_matrix(this.gl,[e+2.5,t+2.5],a,[r*l,c*l],!1),h=get_matrix(this.gl,[.2*s,0],0,[.2,1],!0);i.draw(o,d,h)}shader_spend(e,t,s,n,i){let o=this.get("ImageShader"),a=this.tm.get("numbers_sheet"),r=(i=i||{}).scale||1,c=get_matrix(this.gl,[e,t],0,[50*r,50*r],!1),l=get_matrix(this.gl,[.1*s,.3333],0,[.1,.3333],!0);o.draw(a,c,l),this.shader_score(e,t,n,i)}shader_token(e,t,s,n){let i=this.get("ImageShader"),o=this.tm.get("tokens"),a=(n=n||{}).rotation||0,r=n.scale_x||70,c=n.scale_y||70,l=n.scale||1,d=get_matrix(this.gl,[e,t],a,[r*l,c*l],!1),h=get_matrix(this.gl,[.16666*s,0],0,[.16667,1],!0);i.draw(o,d,h)}shader_noble(e,t,s,n,i){let o=this.get("ImageShader"),a=this.tm.get("nobles"),r=(i=i||{}).rotation||0,c=i.scale_x||140,l=i.scale_y||140,d=i.scale||1,h=get_matrix(this.gl,[e,t],r,[c*d,l*d],!1),_=get_matrix(this.gl,[.2*s,.5*n],0,[.2,.5],!0);o.draw(a,h,_)}get(e){return this.shader_dict[e]}resize(e){const t=e.clientWidth,s=e.clientHeight;e.width===t&&e.height===s||(e.width=t,e.height=s)}before_render(){const e=this.gl;this.resize(e.canvas),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT)}createProgramFromText(e,t,s){const n=this.createShader(e,e.VERTEX_SHADER,t),i=this.createShader(e,e.FRAGMENT_SHADER,s);return this.createProgram(e,n,i)}createShader(e,t,s){let n=e.createShader(t);if(e.shaderSource(n,s),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS))return n;console.log(e.getShaderInfoLog(n)),e.deleteShader(n)}createProgram(e,t,s){let n=e.createProgram();if(e.attachShader(n,t),e.attachShader(n,s),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS))return n;console.log(e.getProgramInfoLog(n)),e.deleteProgram(n)}get_point_from(e,t,s,n){let i=e+s,o=t+n;return[e,t,i,t,e,o,e,o,i,t,i,o]}randomint_from_xy(e,t){return Math.floor(e+Math.random()*(t-e))}init(){new ImageShader(this),new RectShader(this),this.tm=new PreProcessTexture(this)}}class SplendorGameSocket{BASE_WSS="wss://app3774.acapp.acwing.com.cn";constructor(e){this.playground=e,this.start()}start(){this.ws=this.playground.menu.socket.ws,console.log(this.ws)}get_player(e){return this.playground.players_manager.get_player(e)}get_card(e){return this.playground.cards_manager.get_card(e)}send_stat(e){this.ws.send(JSON.stringify({event:"send_stat",content:e}))}send_message(e,t){let s={email:e,message:t};this.ws.send(JSON.stringify({event:"send_message",content:s}))}send_get_tokens(e,t){let s={email:e,tokens_config:t};this.ws.send(JSON.stringify({event:"send_get_tokens",content:s}))}send_book_card(e,t){let s={email:e,card_uuid:t};this.ws.send(JSON.stringify({event:"send_book_card",content:s}))}send_buy_card(e,t){let s={email:e,card_uuid:t};this.ws.send(JSON.stringify({event:"send_buy_card",content:s}))}send_pass(e){let t={email:e};this.ws.send(JSON.stringify({event:"send_pass",content:t}))}receive_pass(e){let t=e.email;this.get_player(t).pass(!0)}recevie_message(e){let t=e.message,s=e.email;this.playground.chat.send_message(s,t)}recevie_get_tokens(e){let t=e.email,s=e.tokens_config,n=this.get_player(t);this.playground.tokens_manager.picked_by_player_from_tokens(n,s),this.playground.players_manager.next_player()}recevie_book_card(e){let t=e.email,s=e.card_uuid,n=this.get_player(t);this.get_card(s).book_by_player(n)}receive_buy_card(e){let t=e.email,s=e.card_uuid,n=this.get_player(t);this.get_card(s).buy_by_player(n)}}class SplendorPlayground{constructor(e,t,s,n,i){this.menu=e,this.config=t,this.players=s,this.me=i,this.room_id=n,this.mode=this.config.single_mode||this.config.room_mode,this.player_number=this.config.single_player_number||this.config.room_player_number,this.round_second=this.config.room_round_second||this.config.single_round_second,this.$playground_div=$("<div class='playground'></div>"),this.menu.$menu_div.append(this.$playground_div),this.state="start",this.start()}start(){this.init_canvas_context(),this.init_shader_manager(),this.start_animation(),"单人"!==this.mode&&(this.socket=new SplendorGameSocket(this),this.chat=new SplendorChat(this)),this.top_board=new TopBoard(this),this.cards_manager=new CardsManager(this),this.tokens_manager=new TokensManager(this),this.nobles_manager=new NoblesManager(this),this.players_manager=new PlayersManager(this),this.state="round",this.players_manager.next_player()}init_canvas_context(){this.$canvas=$("<canvas tabindex=1></canvas>"),this.$playground_div.append(this.$canvas),this.gl=this.$canvas[0].getContext("webgl"),this.gl||alert("未支持WebGl"),this.$canvas.on("click",(e=>{this.process_mouse_event(e)}))}init_shader_manager(){this.shader_manager=new ShaderManager(this),this.shader_manager.init()}start_animation(){let e=t=>{this.shader_manager.before_render();for(let e=0;e<GAME_OBJECTS.length;e++){let s=GAME_OBJECTS[e];s.is_called_start?(s.update(),s.timedelta=t-last_timestamp):(s.start(),s.is_called_start=!0)}for(let e=0;e<GAME_OBJECTS.length;e++)GAME_OBJECTS[e].late_update();last_timestamp=t,requestAnimationFrame(e)};requestAnimationFrame(e)}statistics(e){this.state="end",this.top_board.clear_interval(),this.top_board.clear_interval("tick");let t=this.top_board.time,s=Math.floor(t/60),n=t%60;n<10&&(n="0"+n),s<10&&(s="0"+s);let i=s+":"+n;this.$statistics=$(`\n<div class='statistics-wrap'>\n    <div class='statistics-box'>\n        <div class='statistics-title'>\n            <span>结算统计</span>\n            <span>对局时间 ${i}</span>\n        </div>\n        <div class='statistics-header'>\n            <span>排名</span>\n            <span>头像</span>\n            <span>昵称</span>\n            <span>游戏分数</span>\n            <span>排位分数</span>\n            <span>分数改变</span>\n        </div>\n        <div class='statistics-content'>\n\n        </div>\n        <div class='statistics-click'>\n            <button>退出</button>\n        </div>\n    </div>\n</div>        \n`),this.players_stat=[];for(let t in e){let s=e[t];this.players_stat.push({email:s.email,name:s.name,photo:s.photo,game_score:s.game_score,score:s.score})}this.players_stat.sort(((e,t)=>t.game_score-e.game_score));for(let e in this.players_stat){let t=0;"单人"!==this.mode&&(1===e&&(t+=10),this.players_stat[e].game_score>=15?t+=10:t-=10),this.players_stat[e].score_change=t}this.socket&&this.socket.send_stat(this.players_stat);let o=this.$statistics.find(".statistics-content");for(let e in this.players_stat){let t=parseInt(e)+1,s=this.players_stat[e],n=s.score_change<0?"statistics-change-red":"statistics-change-green",i=s.score_change<0?s.score_change:"+"+s.score_change,a=$(`\n<div class='statistics-element'>\n    <span>${t}</span>\n    <img src='${s.photo}'>\n    <span>${s.name}</span>\n    <span>${s.game_score}</span>\n    <span>${s.score}</span>\n    <span class='${n}'>${i}</span>\n</div>\n`);o.append(a)}return this.$statistics.find(".statistics-click").on("click",(()=>{window.location.reload()})),this.$playground_div.append(this.$statistics),0}process_mouse_event(e){if(!this.players_manager.is_me_round())return!1;if("round"!==this.state&&"last_round"!==this.state)return!1;let t=e.clientX,s=e.clientY,n=this.cards_manager.click_card(t,s);if(null!==n)return this.top_board.click_card(n),!0;let i=this.tokens_manager.click_token(t,s);if(null!==i){this.tokens_manager.select_by_player(i)||this.top_board.add_error_message("不能这样操作",t,s)}}}class SplendorRoom{constructor(e){this.root=e,this.players=[],this.start()}start(){this.create_base()}add_listening_events(){this.$room_wrap.find(".room-check-button > button").on("click",(()=>{let e=this.$room_wrap.find(".room-check-input > input").val();if(""===e)return!1;this.check_pass(e)})),this.$room_wrap.find(".room-start > button:first").on("click",(()=>{if(this.is_owner){if(this.players.length<this.config.room_player_number)return!1;this.root.socket.start_game(),this.start_game()}})),this.$room_wrap.find(".room-start > button:last").on("click",(()=>{this.is_owner&&(this.root.socket.cancel_room(),this.cancel_room())})),this.$room_wrap.find(".room-start > button:nth-child(2)").on("click",(()=>{let e=t=>{t.preventDefault(),t.clipboardData.setData("text/plain",`${BASE_URL}/splendor/page/menu/?room_id=${this.room_id}&need_pass=${this.need_pass}`),alert("复制链接成功, 分享给好友邀请加入游戏"),document.removeEventListener("copy",e)};document.addEventListener("copy",e),document.execCommand("Copy")}))}cancel_room(){window.location.href=`${BASE_URL}/splendor/`}start_game(){this.root.start_game(this.config,this.players,this.room_id)}create_base(){this.$room_wrap=$("\n<div class='room-wrap'>\n    <div class='room-check'>\n        <div class='room-check-title'>\n            <span>请输入房间密码</span>\n        </div>\n        <div class='room-check-input'>\n            <input type='text' maxlength='4' oninput= \"value = value.replace(/[^\\d]/g, '')\" name='room_pass'>\n        </div>\n        <div class='room-check-button'>\n            <button>确认</button>\n        </div>\n    </div>\n    <div class='room-box'>\n        <div class='room-title'>\n            <span></span>\n        </div>\n        <div class='room-player'>\n        </div>\n        <div class='room-start'>\n            <button>开始游戏</button>\n            <button>邀请玩家</button>\n            <button>解散房间</button>\n        </div>\n    </div>\n</div>\n"),this.$check=this.$room_wrap.find(".room-check"),this.$check.hide(),this.$box=this.$room_wrap.find(".room-box"),this.$box.hide(),this.$room_wrap.hide(),this.root.$menu_div.append(this.$room_wrap),this.add_listening_events()}show(){this.$room_wrap.show()}hide(){this.$room_wrap.hide()}create_room(e,t,s,n,i){this.room_id=t,this.is_owner=n,this.player_info=e,this.need_pass=s,this.config=i,this.$room_wrap.css("background-image","linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("+e.back+")"),n?(this.players.push(e),this.$box.find(".room-title > span").text("房间 "+this.room_id),this.padding_info(e),this.root.hide(),this.show(),this.$box.show()):(this.root.hide(),this.show(),"true"===s?this.$check.show():this.join_room(e,""))}check_pass(e){this.join_room(this.player_info,e)}join_room(e,t){setTimeout((()=>{this.root.socket.join_room(this.room_id,e,t)}),1e3)}receive_join_room(e,t){this.config=e,this.$check.hide(),this.playernumber=e.room_player_number,this.round_second=e.room_round_second,this.players=t,this.$box.find(".room-title > span").text("房间 "+this.room_id),this.$box.find(".room-player").empty();for(let e=0;e<t.length;e++)this.padding_info(t[e]);this.$box.show()}padding_info(e){let t=this.$box.find(".room-player"),s=$(`\n<div class='player-element'>\n    <div class='player-photo'>\n        <img src='${e.photo}'>\n    </div>\n    <div class='player-name'>\n        <span>${e.name}</span>\n    </div>\n</div>\n`);t.append(s)}}class SplendorRoomSocket{BASE_WSS="wss://app3774.acapp.acwing.com.cn";constructor(e){this.root=e,this.start()}start(){this.ws=new WebSocket(`${this.BASE_WSS}/wss/splendor/multiplayer/room/?token=`+localStorage.getItem("gc-access")),this.receive()}receive_create_room(e){this.root.room_id=e.room_id,this.root.need_pass=e.need_pass,this.root.receive_create_room(e.config)}create_room(e){let t={room_config:e,room_owner:this.root.player_info};this.ws.send(JSON.stringify({event:"create_room",content:t}))}cancel_room(){this.ws.send(JSON.stringify({event:"cancel_room",content:{cancel_room:"true"}}))}start_game(){this.ws.send(JSON.stringify({event:"start_game",content:{start_game:"true"}}))}join_room(e,t,s,n="false"){let i={room_id:e,pass:s,player_info:t,match:n};this.ws.send(JSON.stringify({event:"join_room",content:i}))}receive_join_room(e){e.players.length>=4&&this.root.start_game(e.config,e.players,e.room_id)}receive_match_success(e){this.root.match_success(e)}stop_match(e,t){let s={email:e,score:t};this.ws.send(JSON.stringify({event:"stop_match",content:s}))}match(e,t){let s={email:e,score:t};this.ws.send(JSON.stringify({event:"match",content:s}))}receive(){this.ws.onmessage=e=>{let t=JSON.parse(e.data),s=t.event,n=t.content;if("create_room"===s)this.receive_create_room(n);else if("join_room"===s)"false"===n.match?this.root.room.receive_join_room(n.config,n.players):this.receive_join_room(n);else if("match_success"===s)this.receive_match_success(n);else{if(t.email===this.root.player_info.email)return!1;"start_game"===s?this.root.room.start_game():"cancel_room"===s?this.root.room.cancel_room():"send_message"===s?this.root.playground.socket.recevie_message(n):"send_get_tokens"===s?this.root.playground.socket.recevie_get_tokens(n):"send_book_card"===s?this.root.playground.socket.recevie_book_card(n):"send_buy_card"===s?this.root.playground.socket.receive_buy_card(n):"send_pass"===s&&this.root.playground.socket.receive_pass(n)}}}}
