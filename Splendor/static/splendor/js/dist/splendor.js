const BASE_URL="https://app3774.acapp.acwing.com.cn";function requestCORSIfNotSameOrigin(e,t){new URL(t,window.location.href).origin!==window.location.origin&&(e.crossOrigin="")}function refresh_(){$.ajax({url:`${BASE_URL}/gameclub/auth/jwt/token/refresh/`,type:"POST",data:{refresh:localStorage.getItem("gc-refresh")},success:e=>{localStorage.setItem("gc-access",e.access)}})}function refresh_tokens(){setInterval((()=>{$.ajax({url:`${BASE_URL}/gameclub/auth/jwt/token/refresh/`,type:"POST",data:{refresh:localStorage.getItem("gc-refresh")},success:e=>{localStorage.setItem("gc-access",e.access)}})}),354e4)}function clear_tokens(){localStorage.setItem("gc-access",""),localStorage.setItem("gc-refresh","")}function fix(e,t,s,i){let n=e.canvas.clientWidth;if(s||(n=e.canvas.clientHeight),i){let e=i.pre_size,n=e[0],o=e[1];t=s?t/n:t/o}return t*n}const base_width=1536,base_height=760,token_offset_x=970/1536,token_offset_y=100/760,token_offset_y_step=115/760,token_offset_y_t_step=5/760,token_width=70/1536,token_height=60/760,token_move_length=900/1536,token_dis_top=5/760,token_score_t_step_x=15/1536,token_score_t_step_y=15/760,token_score_scale_x=40/1536,token_score_scale_y=40/760,token_speed=800/1536,player_y_step=160/760,player_x=1285/1536,player_y=77/760,player_book_x_step=5/1536,player_book_card_step=45/1536,player_book_y_fix_step=90/760,player_photo_x_step=10/1536,player_photo_y_step=10/760,player_card_x_step=10/1536,player_card_y_step=10/760,player_card_card_x_step=35/1536,player_card_fix_x_step=25/1536,player_card_fix_y_step=5/760,player_card_gem_scale_x=10/1536,player_card_gem_scale_y=10/760,player_card_score_scale_x=35/1536,player_card_score_scale_y=35/760,player_token_x_step=42/1536,player_token_y_step=50/760,player_token_x_fix_step=5/1536,player_token_y_fix_step=3/760,player_noble_x_step=155/1536,player_noble_y_step=100/760,player_noble_scale_x=40/1536,player_noble_scale_y=40/760,player_top_back_x=260/1536,player_top_back_y=150/760,noble_move_x_step=155/1536,noble_move_y_step=100/760,noble_offset_x=1070/1536,noble_offset_y=75/760,noble_y_step=175/760,noble_speed=800/1536,noble_score_x_step=90/1536,noble_top_back_x_step=54/1536,noble_top_back_scale_x=140/760,noble_top_back_scale_y=54/1536,noble_t_step=45/760,noble_fix_step=10/1536,noble_x_fix_step=10/1536,noble_y_fix_step=145/760,noble_score_scale_x=35/1536,noble_score_scale_y=35/760,noble_gem_scale_x=15/1536,noble_gem_scale_y=15/760,card_next_card_offset_x=20/1536,card_next_card_offset_y=75/760,card_next_card_x_step=190/1536,card_next_card_y_step=238/760,card_speed=1e3/1536,card_width=150/1536,card_height=203/760,card_gem_step=98/1536,card_spend_step=100/760,card_gem_step_x=40/1536,card_gem_step_y=15/760,card_fix_step_x=50/1536,card_fix_step_y=50/760,card_gem_scale_x=20/1536,card_gem_scale_y=20/760,card_click_fix_x=180/1536,card_click_fix_y=90/760,shader_player_photo_scale_x=30/1536,shader_player_photo_scale_y=30/760,shader_card_back_scale_x=150/1536,shader_card_back_scale_y=203/760,shader_top_back_scale_x=150/1536,shader_top_back_scale_y=54/760,shader_score_scale_x=50/1536,shader_score_scale_y=50/760,shader_mini_card_back_scale_x=35/1536,shader_mini_card_back_scale_y=35/760,shader_gem_scale_x=45/1536,shader_gem_scale_y=45/760,shader_gem_fix_x_step=2.5/1536,shader_gem_fix_y_step=2.5/760,shader_spend_scale_x=50/1536,shader_spend_scale_y=50/760,shader_token_scale_x=70/1536,shader_token_scale_y=70/760,shader_noble_scale_x=140/1536,shader_noble_scale_y=140/760;class Loading{constructor(e){this.load_total=13,this.loaded=0,this.menu=e,this.loading_page(),this.loading_start()}loading_page(){this.$script=$(`\n<script src="${BASE_URL}/static/gameclub/js/dist/howler.min.js"><\/script>\n        `),this.menu.os&&this.menu.$menu_div.append(this.$script),this.$loading_assets_page=$(`\n<div class='loading_assets'>\n    <div class='rubik-loader'>\n    </div>\n    <div class='loading-span'>\n        <span>Loading assets... <span class='loading-stat'>${this.loaded}/${this.load_total}</span></span>\n    </div>\n</div>\n        `),this.menu.$menu_div.append(this.$loading_assets_page)}loading_start(){this.change_loaded(-this.loaded);try{this.loading_audio(),this.loading_image()}catch(e){setTimeout((()=>{this.loading_start()}),1e3)}}change_loaded(e){this.loaded+=e,this.$loading_assets_page.find(".loading-stat").text(`${this.loaded}/${this.load_total}`),this.loaded===this.load_total&&(this.$loading_assets_page.fadeOut(),this.menu.start())}loading_audio(){let e={base_url:`${BASE_URL}/static/splendor/assets`,setting:{},action_sound:[],loading_setting:()=>{let t=localStorage.getItem("splendor_game_setting");e.setting=t?JSON.parse(t):{action_volume:.5,back_volume:.2}},get_setting:t=>e.setting[t],save_setting:(t,s)=>{e.setting[t]=s,localStorage.setItem("splendor_game_setting",JSON.stringify(e.setting)),e.change_setting(t,s)},change_setting:(t,s)=>{if("back_volume"===t)e.back.volume(s);else if("action_volume"===t)for(let t in e.action_sound)e.action_sound[t].volume(s)},pre_load_source:()=>{e.loading_setting();let t=e.setting.back_volume,s=e.setting.action_volume;e.back=new Howl({src:[e.base_url+"/back_sound.mp3"],volume:t,onload:()=>{this.change_loaded(1)}}),e.get_use_token=new Howl({src:[e.base_url+"/get_use_token.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.move=new Howl({src:[e.base_url+"/move.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.move=new Howl({src:[e.base_url+"/move.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.select_token=new Howl({src:[e.base_url+"/select_token.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.splendor_buynoble=new Howl({src:[e.base_url+"/splendor_buynoble.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.splendor_ping=new Howl({src:[e.base_url+"/splendor_ping.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.tac=new Howl({src:[e.base_url+"/tac.ogg"],volume:s,onload:()=>{this.change_loaded(1)}}),e.action_sound.push(e.get_use_token),e.action_sound.push(e.move),e.action_sound.push(e.select_token),e.action_sound.push(e.splendor_buynoble),e.action_sound.push(e.splendor_ping),e.action_sound.push(e.tac),e.play_func={back:()=>{e.back.loop(!0),e.play(e.back)},get_use_token:()=>{e.play(e.get_use_token)},move:()=>{e.play(e.move)},select_token:()=>{e.play(e.select_token)},splendor_buynoble:()=>{e.play(e.splendor_buynoble)},splendor_ping:()=>{e.play(e.splendor_ping)},tac:()=>{e.play(e.tac)}}},play:t=>{e.loaded(t)&&t.play()},loaded:e=>!(!e||"loaded"!==e.state()),pause:()=>{e.back.pause();for(let t=0;t<e.action_sound.length;t++)e.action_sound[t].splice(t,1)}};this.audio_assets=e,this.audio_assets.pre_load_source()}loading_image(){let e={base_url:`${BASE_URL}/static/splendor/assets`,texture_dict:{cards:null,gems:null,nobles:null,tokens:null,numbers_sheet:null},texture_image:{},pre_load:()=>{for(let t in e.texture_dict){let s=new Image,i=`${e.base_url}/${t}.jpg`;requestCORSIfNotSameOrigin(s,i),s.src=i,s.onload=()=>{this.change_loaded(1)},e.texture_image[t]=s}}};this.image_assets=e,this.image_assets.pre_load()}}export class SplendorLogin{constructor(e,t,s,i){this.id=e,this.os=t,this.$splendor_div=$("#"+e),localStorage.getItem("gc-access")||localStorage.setItem("gc-access",s),localStorage.getItem("gc-refresh")||localStorage.setItem("gc-refresh",i),refresh_(),this.start()}start(){this.$login_div=$("\n<div class='splendor-login-wrap'>\n    <div class='splendor-login-box'>\n        <div class='splendor-login-logo'>\n        </div>\n        <div class='splendor-login-content'>\n            <div class='splendor-login-title'>\n                <span>您还未登录,请前往GameClub登录</span>\n            </div>\n            <div class='splendor-login-button'>\n                <a>前往GameClub登录</a>\n            </div>\n        </div>\n    </div>\n</div>\n"),this.$login_div.hide(),this.$splendor_div.append(this.$login_div),this.add_listening_events(),this.get_info()}add_listening_events(){this.$login_div.find(".splendor-login-button").on("click",(()=>{window.location.href=`${BASE_URL}/?redirect=https://app3774.acapp.acwing.com.cn/splendor/`}))}login(){this.$login_div.show()}get_info(){$.ajax({url:`${BASE_URL}/gameclub/auth/check/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},success:e=>{window.location.href=`${BASE_URL}/splendor/page/menu/`},error:e=>{this.login()}})}}export class SplendorMenu{constructor(e,t,s,i){this.id=e,this.os=t,console.log(this.os),this.room_id=s,this.need_pass=i,this.$menu_div=$("#"+this.id),this.os&&(this.os.api.window.resize(76,83),this.os.api.window.on_close((()=>{this.destory()}))),this.loading_assets()}destory(){try{this.loading.audio_assets.pause(),this.$menu_div.empty(),this.playground.destory()}catch(e){window.location.reload()}}loading_assets(){this.loading=new Loading(this)}start(){this.os?this.getinfo_acwing():(this.start_ws(),this.start_room(),this.get_info(),this.create_settings())}start_ws(){this.socket=new SplendorRoomSocket(this)}start_room(){this.room=new SplendorRoom(this)}create_settings(){this.single_setting={single_mode:{name:"模式",content:["单人"]},single_player_number:{name:"人数",content:["2人","3人","4人"]},single_round_second:{name:"回合秒数",content:["10s","15s","30s","35s"]}},this.room_setting={room_mode:{name:"模式",content:["多人"]},room_player_number:{name:"人数",content:["2人","3人","4人"]},room_round_second:{name:"回合秒数",content:["10s","15s","30s","35s","45s","60s"]},room_pass:{name:"房间密码",content:["none"]}}}create_element(){this.$base_wrap=$("\n<div class='menu-wrap'>\n    <div class='menu-player-info'>\n        <div class='player-info'>\n            <div class='player-info-left'>\n                <span></span>\n                <span></span>\n            </div>\n            <div class='player-info-right'>\n                <img>\n            </div>\n        </div>\n    </div>\n    <div class='menu-box'>\n    </div>\n</div>\n"),this.room_id&&this.room.create_room(this.player_info,this.room_id,this.need_pass,!1,null),this.$player_name=this.$base_wrap.find(".player-info-left > span:first"),this.$player_score=this.$base_wrap.find(".player-info-left > span:last"),this.$player_photo=this.$base_wrap.find(".player-info-right > img"),this.$menu_box=this.$base_wrap.find(".menu-box"),this.$menu_div.append(this.$base_wrap),this.$base_menu=$("\n<div class='menu-list' name='base-menu'>\n    <div class='menu-element' name='single'>\n        <span>单人游戏</span>\n    </div>\n    <div class='menu-element' name='multi'>\n        <span>多人游戏</span>\n    </div>\n    <div class='menu-element' name='ranklist'>\n        <span>排行榜</span>\n    </div>\n    <div class='menu-element' name='rule'>\n        <span>中文规则书</span>\n    </div>\n    <div class='menu-element' name='gameclub'>\n        <span>前往GameClub</span>\n    </div>\n    <div class='menu-element' name='signout'>\n        <span>退出</span>\n    </div>\n</div>\n"),this.$single=this.$base_menu.find("[name='single']"),this.$multi=this.$base_menu.find("[name='multi']"),this.$rank=this.$base_menu.find("[name='ranklist']"),this.$signout=this.$base_menu.find("[name='signout']"),this.$rule=this.$base_menu.find("[name='rule']"),this.$gameclub=this.$base_menu.find("[name='gameclub']"),this.os&&(this.$gameclub.hide(),this.$rule.hide()),this.$menu_box.append(this.$base_menu),this.$single_setting=$("\n<div class='menu-setting-wrap'>\n    <div class='menu-setting-box'>\n        <div class='menu-setting-title'>\n            <span>单人设定</span>\n        </div>\n        <div class='menu-setting-config'>\n            <div class='menu-setting-content'>\n            </div>\n        </div>\n        <div class='menu-setting-button'>\n            <button>确定</button>\n            <button>取消</button>\n        </div>\n    </div>\n</div>\n"),this.$single_setting_content=this.$single_setting.find(".menu-setting-content"),this.contain_setting(this.$single_setting_content,this.single_setting),this.$single_check_button=this.$single_setting.find("button:first"),this.$single_cancel_button=this.$single_setting.find("button:last"),this.$single_setting.hide(),this.$menu_box.append(this.$single_setting),this.$multi_list=$("\n<div class='menu-list' name='multi-menu'>\n    <div class='menu-element' name='match'>\n        <span>开始匹配</span>\n    </div>\n    <div class='menu-element' name='create_room'>\n        <span>组队房间</span>\n    </div>\n    <div class='menu-element' name='multi-last'>\n        <span>上一级</span>\n    </div>\n</div>\n"),this.$match_loading=$("\n<div class='match-loading'>\n    <div class=\"rubik-loader\"></div>\n    <div></div>\n    <button>取消匹配</button>\n</div>\n"),this.$match=this.$multi_list.find("[name='match']"),this.$create_room=this.$multi_list.find("[name='create_room']"),this.$multi_last_menu=this.$multi_list.find("[name='multi-last']"),this.$multi_list.hide(),this.$menu_box.append(this.$multi_list),this.$menu_box.append(this.$match_loading),this.$create_room_setting=$("\n<div class='menu-setting-wrap'>\n    <div class='menu-setting-box'>\n        <div class='menu-setting-title'>\n            <span>房间设定</span>\n        </div>\n        <div class='menu-setting-config'>\n            <div class='menu-setting-content'>\n            </div>\n        </div>\n        <div class='menu-setting-button'>\n            <button>创建房间</button>\n            <button>取消</button>\n        </div>\n    </div>\n</div>\n"),this.$room_setting_content=this.$create_room_setting.find(".menu-setting-content"),this.contain_setting(this.$room_setting_content,this.room_setting),this.$room_check_button=this.$create_room_setting.find("button:first"),this.$room_cancel_button=this.$create_room_setting.find("button:last"),this.$create_room_setting.hide(),this.$menu_box.append(this.$create_room_setting),this.$ranklist=$(`\n<div class='menu-ranklist-wrap'>\n    <div class='menu-ranklist-box'>\n        <div class='ranklist-title'>\n            <span>排行榜</span>\n            <img src="${BASE_URL}/static/gameclub/images/settings/cancel.svg">\n        </div>\n        <div class='ranklist-box'>\n            <div class="rubik-loader"></div>\n            <div class="ranklist-content-row ranklist-content-header">\n                <span>排名</span>\n                <span>头像</span>\n                <span>昵称</span>\n                <span>分数</span>\n            </div>\n            <div class='ranklist-content'>\n            </div>\n        </div>\n        <div class="ranklist-content-row ranklist-content-me">\n        </div>\n    </div>\n</div>\n`),this.$ranklist_content=this.$ranklist.find(".ranklist-content"),this.$ranklist_cancel=this.$ranklist.find("img"),this.$rubik_loader=this.$ranklist.find(".rubik-loader"),this.$ranklist_row_me=this.$ranklist.find(".ranklist-content-me"),this.$ranklist.hide(),this.$menu_box.append(this.$ranklist),$(".menu-setting-select-box").buttonset(),this.add_listening_events()}add_listening_events(){this.$single.on("click",(()=>{this.$base_menu.hide(),this.$single_setting.show()})),this.$multi.on("click",(()=>{this.$base_menu.hide(),this.$multi_list.show()})),this.$rank.on("click",(()=>{this.$base_menu.hide(),this.show_ranklist()})),this.$rule.on("click",(()=>{window.location.href="https://www.gstonegames.com/game/doc-517.html"})),this.$gameclub.on("click",(()=>{window.location.href="https://app3774.acapp.acwing.com.cn/"})),this.$signout.on("click",(()=>{if(this.os)return this.os.api.window.close(),!1;clear_tokens(),window.location.reload()})),this.$single_check_button.on("click",(()=>{let e=this.get_config(this.$single_setting_content);this.start_single_game(e)})),this.$single_cancel_button.on("click",(()=>{this.$single_setting.hide(),this.$base_menu.show()})),this.$room_check_button.on("click",(()=>{let e=this.get_config(this.$room_setting_content);this.create_room(e)})),this.$room_cancel_button.on("click",(()=>{this.$create_room_setting.hide(),this.$multi_list.show()})),this.$match.on("click",(()=>{this.$multi_list.hide(),this.$match_loading.show(),this.time_func_id=this.start_match_timing(),this.match_game(this.player_info)})),this.$match_loading.find("button").on("click",(()=>{this.stop_match(),this.$multi_list.show()})),this.$create_room.on("click",(()=>{this.$multi_list.hide(),this.$create_room_setting.show()})),this.$multi_last_menu.on("click",(()=>{this.$multi_list.hide(),this.$base_menu.show()})),this.$ranklist_cancel.on("click",(()=>{this.$ranklist.hide(),this.$base_menu.show()}))}create_room(e){this.socket.create_room(e)}receive_create_room(e){this.room.create_room(this.player_info,this.room_id,this.need_pass,!0,e)}match_success(e){this.stop_match_timing(this.time_func_id),this.$match_loading.find("button").hide(),this.$match_loading.find("div:last").css("color","rgb(68, 157, 68)"),this.$match_loading.find("div:last").text("匹配成功! loading..."),this.socket.join_room(e.room_id,this.player_info,e.pass,"true"),console.log("match_success")}start_game(e,t,s){let i=null;for(let e=0;e<t.length;e++)t[e].email===this.email?(t[e].character="me",i=t[e]):t[e].character="enemy";this.playground=new SplendorPlayground(this,e,t,s,i),this.room.hide(),this.hide()}stop_game(){this.playground&&(this.playground.close(),this.playground=null,this.show())}stop_match_timing(e){clearInterval(e)}start_match_timing(){let e=1;return this.$match_loading.find("div:last").text(""),setInterval((()=>{let t=e,s=t%60,i=Math.floor(t/60),n="匹配中... ";i>0&&(n+=i+"m"),n+=s+"s",this.$match_loading.find("div:last").text(n),e+=1}),1e3)}stop_match(){this.stop_match_timing(this.time_func_id),this.socket.stop_match(this.email,this.score),this.$match_loading.hide(),console.log("stop_match")}match_game(e){this.socket.match(e.email,e.score)}show_ranklist(){this.$ranklist.show(),this.rank_list?(this.$rubik_loader.hide(),this.$ranklist_content.show(),this.$ranklist_row_me.show()):this.get_ranklist()}get_ranklist(){$.ajax({url:`${BASE_URL}/splendor/auth/get_ranklist/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},data:{range_min:1,range_max:100},success:e=>{this.padding_ranklist(e),"none"!==this.$ranklist.css("display")&&(this.$rubik_loader.hide(),this.$ranklist_content.show(),this.$ranklist_row_me.show())}})}padding_ranklist(e){let t=-1,s=e.content;this.rank_list=s;let i=s.length;s.forEach(((e,s,n)=>{let o=s+1,a=e.photo,r=e.name,l=e.score,c=e.email,d=this.create_ranklist_row(o,a,r,l);1===o&&d.addClass("ranklist-content-first"),2===o&&d.addClass("ranklist-content-second"),3===o&&d.addClass("ranklist-content-third"),o===i&&d.addClass("ranklist-content-last-row"),this.email===c&&(t=o,d.addClass("ranklist-content-box-me")),this.$ranklist_content.append(d)})),-1===t&&(t="未上榜"),this.$ranklist_row_me.append($(`\n<span>${t}</span>\n<img src='${BASE_URL}${this.photo}'>\n<span>${this.name}</span>\n<span>${this.score}</span>\n`))}create_ranklist_row(e,t,s,i){return $(`\n<div class="ranklist-content-row">\n    <span>${e}</span>\n    <img src='${BASE_URL}${t}'>\n    <span>${s}</span>\n    <span>${i}</span>\n</div>\n`)}contain_setting(e,t){for(let s in t){let i=s,n=t[i],o=n.name,a=n.content;e.append(this.create_setting_config_element(i,o,a))}}get_config(e){let t=e.children("div"),s={};for(let e=0;e<t.length;e++){let i=$(t[e]),n=i.find("input")[0].name,o="";o="room_pass"===n?i.find("input").val():i.find("input:checked").val(),s[n]=o}return s}start_single_game(e){let t=parseInt(e.single_player_number),s=parseInt(e.single_round_second);e.single_player_number=t,e.single_round_second=s;let i=[],n=this.player_info;n.game_score=0,n.character="me",i.push(n);for(let e=1;e<t;e++)i.push({email:"robot"+e,name:"robot"+e,score:this.player_info.score,photo:"/media/default/user.jpg",game_score:0,character:"robot"});this.playground=new SplendorPlayground(this,e,i,"splendor-room_single",n),this.room.hide(),this.hide()}padding_info(e){this.player_info=e,this.name=e.name,this.email=e.email,this.photo=e.photo,this.score=e.score,this.back=e.back,this.create_element(),this.$player_name.text(this.name),this.$player_score.text("Score: "+this.score),this.$player_photo.attr("src",BASE_URL+this.photo),this.$base_wrap.css("background-image","linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("+BASE_URL+this.back+")")}login_acwing(e){let t=e.appid,s=e.redirect_uri,i=e.scope,n=e.state;this.os.api.oauth2.authorize(t,s,i,n,(e=>{localStorage.setItem("gc-access",e.access_token),localStorage.setItem("gc-refresh",e.refresh_token),this.start_ws(),this.start_room(),this.get_info(),this.create_settings()}))}getinfo_acwing(){$.ajax({url:`${BASE_URL}/splendor/auth/apply_code/`,type:"get",success:e=>{"success"===e.result&&this.login_acwing(e)}})}get_info(){$.ajax({url:`${BASE_URL}/splendor/auth/get_info/`,type:"post",headers:{Authorization:"Bearer "+localStorage.getItem("gc-access")},success:e=>{this.padding_info(e),refresh_tokens()},error:()=>{window.location.href=`${BASE_URL}`}})}show(){this.$base_wrap.show()}hide(){this.$base_wrap.hide()}create_setting_config_element(e,t,s){let i=$(`\n<div class='menu-setting-element'>\n    <div class='menu-setting-name'>\n        <span>${t}</span>\n        <span>:</span>\n    </div>\n    <div class='menu-setting-select'>\n        <div class='menu-setting-select-box'>\n        </div>\n    </div>\n</div>\n`);if("房间密码"===t){let e=$("\n<input type='text' maxlength='4' oninput = \"value=value.replace(/[^\\d]/g,'')\" name='room_pass'>\n<span>(不填视为不设置密码)</span>\n");i.find(".menu-setting-select-box").append(e)}else s.forEach(((t,s,n)=>{let o=$(`\n<input type="radio" id="${e}${s}" value='${t}' name="${e}"><label for="${e}${s}">${t}</label>\n`);0===s&&o.attr("checked","true"),i.find(".menu-setting-select-box").append(o)}));return i}}class AudioManager{constructor(e){this.playground=e,this.base_url="/static/splendor/assets",this.audio_assets=this.playground.menu.loading.audio_assets,this.create_setting_element(),this.play_func=this.audio_assets.play_func,this.play_func.back()}create_setting_element(){this.$playgound_setting=$(`\n<div class='playground-setting'>\n    <div class='playground-icon'></div>\n    <div class='playground-setting-wrap'>\n        <div class='playground-setting-box'>\n            <div class='title'>\n                <span>游戏设置</span>\n                <img src='${BASE_URL}/static/gameclub/images/settings/cancel.svg'>\n            </div>\n            <div class='slider-box'>\n                <div class='action-slider'>\n                    <div class='name'>音乐设置</div>\n                    <div id="backslider"></div>\n                </div>\n                <div class='action-slider'>\n                    <div class='name'>音效设置</div>\n                    <div id="actionslider"></div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n        `),this.$setting_icon=this.$playgound_setting.find(".playground-icon"),this.$setting_wrap=this.$playgound_setting.find(".playground-setting-wrap"),this.$setting_wrap.hide(),this.playground.$playground_div.append(this.$playgound_setting),this.add_listening_event()}add_listening_event(){this.$setting_icon.on("click",(()=>{this.$setting_wrap.show()})),this.$setting_wrap.find(".title > img").on("click",(()=>{this.$setting_wrap.hide()})),this.$setting_wrap.find("#backslider").slider({value:this.get_setting("back_volume"),min:0,max:1,step:.01,range:"min",slider:()=>{let e=this.$setting_wrap.find("#backslider").slider("value");this.save_setting("back_volume",e)},change:()=>{let e=this.$setting_wrap.find("#backslider").slider("value");this.save_setting("back_volume",e)}}),this.$setting_wrap.find("#actionslider").slider({value:this.get_setting("action_volume"),min:0,max:1,step:.01,range:"min",slider:()=>{let e=this.$setting_wrap.find("#actionslider").slider("value");this.save_setting("action_volume",e)},change:()=>{let e=this.$setting_wrap.find("#actionslider").slider("value");this.save_setting("action_volume",e),this.play_func.tac()}})}get_setting(e){return this.audio_assets.get_setting(e)}save_setting(e,t){this.audio_assets.save_setting(e,t)}change_setting(e,t){this.audio_assets.change_setting(e,t)}}let last_timestamp,GAME_OBJECTS=[];class GameObject{constructor(){GAME_OBJECTS.push(this),this.is_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let e="";for(let t=0;t<8;t++)e+=Math.floor(10*Math.random());return e}start(){}update(){}late_update(){}on_destroy(){}update_offset(){}destroy(){this.on_destroy();for(let e=0;e<GAME_OBJECTS.length;e++)if(GAME_OBJECTS[e]===this){GAME_OBJECTS.splice(e,1);break}}}class Card extends GameObject{constructor(e,t,s,i,n,o){super(),this.playground=e.playground,this.gl=this.playground.gl,this.cm=e,this.sm=this.cm.sm,this.am=this.cm.playground.am,this.card_config=t,this.x=s,this.y=i,this.vx=0,this.vy=0,this.move_length=0;const a=this.gl;this.speed=fix(a,card_speed,!0),this.state="board",this.clicked_state=!1,this.role=null,this.level=n,this.location=o,this.scale=1,this.uuid=this.card_config.id,this.change_speed=1.5,this.scale_change_flag=1,this.scale_change=0}can_buy(e){let t=this.card_config.spend,s=0;for(let i in t){let n=t[i],o=n.color,a=n.need;s+=Math.max(0,a-e.cards[o]-e.tokens[o])}return s-e.tokens.O<=0}buy_by_player(e,t=!0){this.clicked_state=!1;let s=this.card_config.spend,i={},n=0;for(let t in s){let o=s[t],a=o.color,r=o.need;i[a]=Math.max(0,r-e.cards[a]),i[a]-e.tokens[a]>0&&(n+=i[a]-e.tokens[a],i[a]=e.tokens[a])}i.O=n,e.email===this.playground.players_manager.get_me().email&&t&&this.playground.socket&&this.playground.socket.send_buy_card(e.email,this.uuid),this.playground.tokens_manager.used_by_player(e,i),"book"===this.state?e.update_books("buy",this):(this.change_scale(.3),this.move_to(e.x,e.y),this.change_state("on_de"),e.update_cards(this,this.card_config.gem,1),this.playground.cards_manager.next_card(this.level,this.location)),this.am.play_func.splendor_ping(),this.playground.players_manager.next_player()}can_book(e){return"board"===this.state&&(e.books.length<3||void 0)}book_by_player(e,t=!0){this.clicked_state=!1,e.tokens_count+1<=10&&this.playground.tokens_manager.picked_by_player_from_tokens(e,{O:1}),e.email===this.playground.players_manager.get_me().email&&t&&this.playground.socket&&this.playground.socket.send_book_card(e.email,this.uuid),e.update_books("book",this),this.playground.cards_manager.next_card(this.level,this.location),this.am.play_func.splendor_ping(),this.playground.players_manager.next_player()}clicked(e,t){const s=this.gl;if("board"!==this.state&&"book"!==this.state)return!1;if("book"===this.state&&this.role!==this.playground.players_manager.get_me().email)return!1;let i=fix(s,.09765625,!0)*this.scale,n=fix(s,card_height,!1)*this.scale;return e>=this.x&&e<=this.x+i&&t>=this.y&&t<=this.y+n&&(null===this.role||this.role===this.playground.me.email)&&(this.clicked_state=!0,!0)}change_state(e){this.state=e}change_scale(e){this.scale_change_flag=e>this.scale?1:-1,this.scale_change=Math.abs(e-this.scale)}change_big(){return"book"===this.state?(this.change_scale(.6),.6):(this.change_scale(1.1),1.1)}change_back(){"book"===this.state?this.change_scale(.3):this.change_scale(1),this.clicked_state=!1}get_dist(e,t,s,i){let n=(s-e)*(s-e),o=(i-t)*(i-t);return Math.sqrt(n+o)}move_to(e,t){this.move_length=this.get_dist(e,t,this.x,this.y);let s=Math.atan2(t-this.y,e-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s),this.am.play_func.move()}update_x_y(){let e=Math.min(this.move_length,this.speed*this.timedelta*.001);this.move_length-=e,this.x+=e*this.vx,this.y+=e*this.vy}update_scale(){let e=Math.min(this.scale_change,this.change_speed*this.timedelta*.001);this.scale_change-=e,this.scale+=this.scale_change_flag*e}update_offset(){const e=this.gl;this.x=fix(e,this.x,!0,{pre_size:this.playground.pre_size}),this.y=fix(e,this.y,!1,{pre_size:this.playground.pre_size}),this.speed=fix(e,card_speed,!0)}start(){}update(){"on_de"===this.state&&0===this.move_length&&this.destroy(),this.update_x_y(),this.update_scale(),this.render()}late_update(){this.clicked_state&&(this.update_x_y(),this.update_scale(),this.render())}on_destroy(){for(let e in this.cm.cards.instance)this.cm.cards.instance[e]===this&&this.cm.cards.instance.splice(e,1)}render(){const e=this.gl;let t=fix(e,card_gem_step,!0)*this.scale,s=fix(e,card_spend_step,!1)*this.scale,i=[2,0,3,1],n=fix(e,card_gem_step_x,!0)*this.scale,o=fix(e,card_gem_step_y,!1)*this.scale,a=this.scale,r=fix(e,card_fix_step_x,!0)*this.scale,l=fix(e,card_fix_step_y,!1)*this.scale;this.sm.shader_card_back(this.x,this.y,this.card_config.backIndex[0],this.card_config.backIndex[1],{scale:a}),this.sm.shader_top_back(this.x,this.y,[1,1,1,.5],{scale:a}),this.sm.shader_score(this.x,this.y,this.card_config.score-1,{scale:a}),this.sm.shader_gem(this.x+t,this.y,GemColor2Index[this.card_config.gem],{scale:a}),this.card_config.spend.forEach(((e,t)=>{t=i[t];let n=Math.floor(t/2),o=t%2,c=NSColor2Index[e.color],d=e.need-1;this.sm.shader_spend(this.x+o*r,this.y+s+n*l,c,d,{scale:a})})),this.card_config.spend.forEach(((t,c)=>{c=i[c];let d=Math.floor(c/2),h=c%2,_=GemColor2Index[t.color];this.sm.shader_gem(this.x+h*r+n,this.y+d*l+o+s,_,{scale_x:fix(e,card_gem_scale_x,!0),scale_y:fix(e,card_gem_scale_y,!1),scale:a})}))}}class CardsManager extends GameObject{constructor(e){super(),this.playground=e,this.sm=this.playground.shader_manager,this.gl=this.playground.gl,this.cards={instance:[],count:{level1:40,level2:30,level3:20},board_cards:{level1:[null,null,null,null],level2:[null,null,null,null],level3:[null,null,null,null]},all_cards:{level1:[],level2:[],level3:[]}},this.init()}init(){this.init_cards()}get_card(e){for(let t in this.cards.instance){let s=this.cards.instance[t];if(s.uuid===e)return s}}init_cards(){"单人"!==this.playground.mode?this.init_cards_from_web():this.init_cards_from_local();for(let e=0;e<4;e++)for(let t=1;t<=3;t++)this.next_card(t,e)}init_cards_from_local(){let e=[];for(let t=0;t<this.cards.count.level1;t++)e.push(t);e.sort((()=>.5-Math.random()));let t=[];for(let e=0;e<this.cards.count.level2;e++)t.push(e);t.sort((()=>.5-Math.random()));let s=[];for(let e=0;e<this.cards.count.level3;e++)s.push(e);s.sort((()=>.5-Math.random())),this.cards.all_cards.level1=e,this.cards.all_cards.level2=t,this.cards.all_cards.level3=s}init_cards_from_web(){this.cards.all_cards.level1=this.playground.config.base_level1_list,this.cards.all_cards.level2=this.playground.config.base_level2_list,this.cards.all_cards.level3=this.playground.config.base_level3_list}next_card(e,t){const s=this.gl;let i=fix(s,.013020833333333334,!0),n=fix(s,.09868421052631579,!1),o=fix(s,.12369791666666667,!0),a=fix(s,.3131578947368421,!1),r=e;e="level"+e;let l=this.cards.all_cards[e].pop();if(l>=0){let s=origin_cards[e][l];this.cards.count[e]--;let c=new Card(this,s,i,n+(r-1)*a,r,t);console.log("next "+e+" card | now "+e+" cards count:"+this.cards.count[e]),this.cards.instance.push(c),this.cards.board_cards[e][t]=c,c.move_to(i+(t+1)*o,n+(r-1)*a)}}update(){this.render()}render(){const e=this.gl;let t=fix(e,.013020833333333334,!0),s=fix(e,.09868421052631579,!1),i=(fix(e,.12369791666666667,!0),fix(e,.3131578947368421,!1));for(let e=1;e<=3;e++){this.sm.shader_card_back(t,s+(e-1)*i,e-1,5),this.sm.shader_top_back(t,s+(e-1)*i,[1,1,1,.5]);let n=this.cards.count["level"+e];n>0&&n<10?this.sm.shader_score(t,s+(e-1)*i,n-1):n>=10&&this.sm.shader_score(t,s+(e-1)*i,9)}}click_card(e,t){for(let s in this.cards.instance)if(this.cards.instance[s].clicked(e,t))return this.cards.instance[s];return null}}class SplendorChat{constructor(e){this.playground=e,this.am=this.playground.am,this.chat_state=!1,this.start()}start(){this.$history=$('\n        <div class="chat-history">\n        \n        </div>\n        '),this.$input=$("\n        <input type='text' class=\"chat-input\">\n        \n        "),this.$chat_img=$("<div class='chat-img'></div>"),this.playground.$playground_div.append(this.$history),this.playground.$playground_div.append(this.$input),this.playground.$playground_div.append(this.$chat_img),this.add_listening_events()}to_clear(){this.$chat_img.css("background","url("+BASE_URL+"/static/splendor/images/playground/up.svg)"),this.$chat_img.css("background-size","cover")}to_has_message(){if("block"===this.$history.css("display"))return!1;this.$chat_img.css("background","url("+BASE_URL+"/static/splendor/images/playground/up_to.svg)"),this.$chat_img.css("background-size","cover")}add_listening_events(){this.$chat_img.on("click",(()=>(this.chat_state?(this.chat_state=!1,this.$history.hide(),this.$chat_img.removeClass("chat-img-rotate"),this.to_clear()):(this.chat_state=!0,this.$history.fadeIn(),this.$history.scrollTop(this.$history[0].scrollHeight),this.$chat_img.addClass("chat-img-rotate"),this.to_clear()),!1))),this.playground.$canvas.keydown((e=>{if(13===e.which)return this.$input.focus(),!1})),this.$input.keydown((e=>{if(27===e.which)return this.playground.$canvas.focus(),!1;if(13===e.which){let e=this.playground.players_manager.get_me().email,t=this.$input.val();return t&&(this.$input.val(""),this.send_message(e,t),this.playground.socket&&this.playground.socket.send_message(e,t)),!1}})),this.playground.$canvas.focus((()=>(this.focus_canvas(),!1))),this.$input.focus((()=>(this.focus_input(),!1))).blur((()=>(this.playground.$canvas.focus(),!1)))}focus_input(){this.$history.fadeIn(),this.$history.scrollTop(this.$history[0].scrollHeight)}focus_canvas(){this.$history.hide()}send_message(e,t){this.to_has_message(),t=`[${this.playground.players_manager.get_player(e).name}] ${t}`,this.$history.append(this.render_message(t,e)),this.$history.scrollTop(this.$history[0].scrollHeight),e!==this.playground.players_manager.get_me().email&&this.am.play_func.tac()}render_message(e,t){return t===this.playground.players_manager.get_me().email?$(`<div style="color: LightPink;white-space: break-spaces;">${e}</div>`):$(`<div style="color: red">${e}</div>`)}}class Noble extends GameObject{constructor(e,t,s){super(),this.nm=e,this.playground=this.nm.playground,this.sm=this.nm.sm,this.am=this.nm.am,this.gl=this.nm.gl,this.noble_config=t,this.state="board",this.role=null;const i=this.gl;let n=fix(i,noble_offset_x,!0),o=fix(i,noble_offset_y,!1),a=fix(i,noble_y_step,!1);this.index=s,this.x=n,this.y=o+s*a,this.vx=0,this.vy=0,this.move_length=0,this.speed=fix(i,noble_speed,!0),this.scale=1,this.change_speed=.6,this.scale_change_flag=1,this.scale_change=0}start(){}change_state(e){this.state=e}change_scale(e){this.scale_change_flag=e>this.scale?1:-1,this.scale_change=Math.abs(e-this.scale)}get_dist(e,t,s,i){let n=(s-e)*(s-e),o=(i-t)*(i-t);return Math.sqrt(n+o)}move_to(e,t){this.move_length=this.get_dist(e,t,this.x,this.y);let s=Math.atan2(t-this.y,e-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s),this.am.play_func.move()}update_x_y(){let e=Math.min(this.move_length,this.speed*this.timedelta*.001);this.move_length-=e,this.x+=e*this.vx,this.y+=e*this.vy}update_scale(){let e=Math.min(this.scale_change,this.change_speed*this.timedelta*.001);this.scale_change-=e,this.scale+=this.scale_change_flag*e}update_offset(){const e=this.gl;this.x=fix(e,this.x,!0,{pre_size:this.playground.pre_size}),this.y=fix(e,this.y,!1,{pre_size:this.playground.pre_size}),this.speed=fix(e,noble_speed,!0)}update(){this.update_x_y(),this.update_scale(),this.render()}render(){const e=this.gl;let t=fix(e,.05859375,!0)*this.scale,s=fix(e,.03515625,!0)*this.scale;this.sm.shader_noble(this.x,this.y,this.noble_config.backIndex[1],this.noble_config.backIndex[0],{scale:this.scale}),this.sm.shader_score(this.x+t,this.y,this.noble_config.score-1,{scale:this.scale}),this.sm.shader_top_back(this.x+s,this.y,[1,1,1,.2],{scale_x:fix(e,.18421052631578946,!1),scale_y:fix(e,.03515625,!0),rotation:Math.PI/2*3,scale:this.scale});let i=1,n=fix(e,noble_t_step,!1)*this.scale,o=fix(e,noble_fix_step,!0)*this.scale,a=fix(e,noble_x_fix_step,!0)*this.scale,r=fix(e,noble_y_fix_step,!1)*this.scale;for(let t in this.noble_config.spend){let s=this.noble_config.spend[t],l=NSColor2Index[s.color],c=GemColor2Index[s.color],d=s.need-1;this.sm.shader_mini_card_back(this.x+a,this.y+r-n*i,l,{scale:this.scale}),this.sm.shader_score(this.x+a,this.y+r-n*i,d,{scale_x:fix(e,noble_score_scale_x,!0),scale_y:fix(e,noble_score_scale_y,!1),scale:this.scale}),this.sm.shader_gem(this.x+a+2.5*o,this.y+r-n*i,c,{scale_x:fix(e,.009765625,!0),scale_y:fix(e,noble_gem_scale_y,!1),scale:this.scale}),i++}}}class NoblesManager{constructor(e){this.playground=e,this.sm=this.playground.shader_manager,this.am=this.playground.am,this.gl=this.playground.gl,this.nobleLength=Math.min(4,this.playground.players_manager.number+1),this.noblesIndex=[],this.nobles=[],this.start()}init_nobles(){"单人"!==this.playground.mode?this.init_nobles_from_web():this.init_nobles_from_local()}init_nobles_from_local(){let e=[];for(let t=0;t<origin_nobles.length;t++)e.push(t);e.sort((()=>.5-Math.random())),this.noblesIndex=e.slice(0,this.nobleLength)}init_nobles_from_web(){let e=this.playground.config.base_nobles;this.noblesIndex=e.slice(0,this.nobleLength)}can_get_one(e){if(!e.can_get_one())return!1;let t=-1;for(let s in this.nobles){let i=this.nobles[s].noble_config.spend,n=!0;for(let t in i){let s=i[t].color,o=i[t].need;if(e.cards[s]<o){n=!1;break}}if(n){t=s;break}}if(-1===t)return!1;let s=this.nobles[t];this.nobles.splice(t,1),s.change_scale(.3),s.change_state("player"),s.role=e.email;const i=this.gl;let n=fix(i,noble_move_x_step,!0),o=fix(i,noble_move_y_step,!1);return s.move_to(e.x+n,e.y+o),this.am.play_func.splendor_buynoble(),e.update_nobles(s),!0}start(){this.init_nobles();for(let e=0;e<this.noblesIndex.length;e++)this.nobles.push(new Noble(this,origin_nobles[this.noblesIndex[e]],e))}}class Player extends GameObject{constructor(e,t,s){super(),this.pm=e,this.sm=this.pm.sm,this.character=t.character,this.gl=this.pm.gl,this.email=t.email,this.name=t.name,this.game_score=t.game_score,this.score=t.score,this.photo=t.photo,this.tokens_count=0,this.tokens={G:0,W:0,B:0,I:0,R:0,O:0},this.cards={G:0,W:0,B:0,I:0,R:0},this.cards_count=0,this.books=[],this.nobles=[],this.index=s;const i=this.gl;let n=fix(i,player_y_step,!1);this.x=fix(i,player_x,!0),this.y=fix(i,player_y,!1)+this.index*n}do(){let e=this.pm.playground;for(let t in e.cards_manager.cards.instance){let s=e.cards_manager.cards.instance[t];if(("book"===s.state&&s.role===this.email||"board"===s.state)&&s.can_buy(this))return void s.buy_by_player(this,!1)}for(let t in e.tokens_manager.tokens){if("O"===t)break;if(e.tokens_manager.tokens[t].count>=4&&this.tokens_count<=8){let s={};return s[t]=2,e.tokens_manager.picked_by_player_from_tokens(this,s),void this.pm.next_player()}}let t=Math.min(3,10-this.tokens_count),s={};for(let i in e.tokens_manager.tokens){if("O"===i)break;if(e.tokens_manager.tokens[i].count>0&&t>0&&(s[i]=1,t--),!t)break}if(!$.isEmptyObject(s))return e.tokens_manager.picked_by_player_from_tokens(this,s),void this.pm.next_player();for(let t in e.cards_manager.cards.instance){let s=e.cards_manager.cards.instance[t];if("board"===s.state&&s.can_book(this))return void s.book_by_player(this,!1)}this.pass(!0)}add_pass_count(){this.pass_count++,this.pass_count>=3&&(this.state="offline")}pass(e=!1){e||this.pm.playground.socket&&this.pm.playground.socket.send_pass(this.email),this.pm.next_player()}getIndex(){return this.index}update_score(e){let t=this.pm.playground;this.game_score+=e,t.top_board.change_game_score(this,this.game_score),this.game_score>=15&&"round"===t.state&&(t.state="last_round")}update_tokens(e,t){this.tokens[e]+=t,this.tokens_count+=t}update_cards(e,t,s){this.cards[t]+=s,this.cards_count+=s,this.update_score(e.card_config.score)}update_books(e,t){const s=this.gl;let i=fix(s,player_book_x_step,!0),n=fix(s,.029296875,!0),o=fix(s,.11842105263157894,!1);if("buy"===e){this.update_cards(t,t.card_config.gem,1);for(let e in this.books)this.books[e]===t&&this.books.splice(e,1);t.destroy();for(let e in this.books)this.books[e].move_to(this.x+i*(parseInt(e)+1)+n*parseInt(e),this.y+o)}else t.change_state("book"),t.move_to(this.x+i*(this.books.length+1)+n*this.books.length,this.y+o),t.change_scale(.3),t.role=this.email,this.books.push(t)}can_get_one(){return!(this.nobles.length>=3)}update_nobles(e){this.nobles.length<3&&(this.nobles.push(e),this.update_score(e.noble_config.score))}update_offset(){const e=this.gl;let t=fix(e,player_y_step,!1);this.x=fix(e,player_x,!0),this.y=fix(e,player_y,!1)+this.index*t}update(){this.render()}late_update(){this.render_nobles()}render_photo(){const e=this.gl;let t=fix(e,player_photo_x_step,!0),s=fix(e,player_photo_y_step,!1);this.sm.shader_player_photo(this.email,this.x+t,this.y+s)}render_cards(){const e=this.gl;let t=fix(e,player_card_x_step,!0),s=fix(e,player_card_y_step,!1),i=fix(e,.022786458333333332,!0),n=fix(e,.016276041666666668,!0),o=fix(e,.006578947368421052,!1),a=1;for(let r in this.cards){let l=NSColor2Index[r],c=GemColor2Index[r],d=this.cards[r];this.sm.shader_mini_card_back(this.x+a*i+t,this.y+s,l),this.sm.shader_gem(this.x+a*i+t+n,this.y+s-o,c,{scale_x:fix(e,.006510416666666667,!0),scale_y:fix(e,.013157894736842105,!1)}),d>0&&this.sm.shader_score(this.x+a*i+t,this.y+s,Math.min(9,d-1),{scale_x:fix(e,.022786458333333332,!0),scale_y:fix(e,.046052631578947366,!1)}),a++}}render_tokens(){const e=this.gl;let t=fix(e,.02734375,!0),s=fix(e,.06578947368421052,!1),i=fix(e,.0032552083333333335,!0),n=fix(e,.003947368421052632,!1),o=0;for(let a in this.tokens){let r=TokenColor2Index[a],l=this.tokens[a];this.sm.shader_token(this.x+o*t+i,this.y+s,r,{scale_x:fix(e,.022786458333333332,!0),scale_y:fix(e,.046052631578947366,!1)}),l>0&&this.sm.shader_score(this.x+o*t+i,this.y+s-n,l-1,{scale_x:fix(e,.022786458333333332,!0),scale_y:fix(e,.046052631578947366,!1)}),o++}}render_nobles(){const e=this.gl;let t=fix(e,.10091145833333333,!0),s=fix(e,.13157894736842105,!1);this.nobles.length>0&&this.sm.shader_score(this.x+t,this.y+s,this.nobles.length-1,{scale_x:fix(e,.026041666666666668,!0),scale_y:fix(e,.05263157894736842,!1)})}render(){const e=this.gl;this.sm.shader_top_back(this.x,this.y,[0,0,0,.5],{scale_x:fix(e,player_top_back_x,!0),scale_y:fix(e,player_top_back_y,!1)}),this.render_photo(),this.render_cards(),this.render_tokens()}}class PlayersManager{constructor(e){this.playground=e,this.am=this.playground.am,this.sm=this.playground.shader_manager,this.gl=this.playground.gl,this.number=Math.min(this.playground.player_number,this.playground.players.length),this.players_config=[],this.players=[],this.start_i=this.playground.roundi,this.roundi=this.start_i-1,this.round=0,this.start()}start(){for(let e in this.playground.players){let t=this.playground.players[e];this.players_config.push({index:e,email:t.email,name:t.name,photo:t.photo,character:t.character,game_score:t.game_score,score:t.score})}for(let e=0;e<this.number;e++){let t=new Player(this,this.players_config[e],e);"me"===this.players_config[e].character&&(this.me=t),this.players.push(t)}}get_me(){return this.me}get_player(e){for(let t in this.players){let s=this.players[t];if(s.email===e)return s}}is_me_round(){return this.roundi===this.get_me().getIndex()}clean(){for(let e in this.playground.cards_manager.cards.instance){this.playground.cards_manager.cards.instance[e].clicked_state&&this.playground.top_board.$click_card.find(".cancle").click()}}next_player(){if(this.clean(),this.roundi>=0&&this.playground.nobles_manager.can_get_one(this.players[this.roundi]),this.playground.top_board.clear_interval("tick"),this.playground.top_board.$token_click.hide(),this.playground.top_board.$click_card.hide(),this.playground.tokens_manager.select_tokens.length>0&&this.playground.tokens_manager.unselect_by_player(),"last_round"===this.playground.state&&this.roundi===(this.number-1+this.start_i)%this.number&&this.playground.statistics(this.players),"round"===this.playground.state||"last_round"===this.playground.state){this.roundi=(this.roundi+1)%this.number;let e=this.players[this.roundi];this.playground.top_board.add_tick(e),this.roundi===this.start_i&&this.round++,"round"===this.playground.state?console.log("round "+this.round+" | now: "+this.players[this.roundi].name):"last_round"===this.playground.state&&console.log("last round  | now: "+this.players[this.roundi].name)}this.am.play_func.tac()}}class Token extends GameObject{constructor(e,t,s,i){super(),this.tm=e,this.playground=this.tm.playground,this.sm=this.tm.sm,this.gl=this.tm.gl,this.color=t,this.x=s,this.y=i,this.vx=0,this.vy=0;const n=this.gl;this.move_length=0,this.speed=fix(n,token_speed,!0),this.state="board"}get_dist(e,t,s,i){let n=(s-e)*(s-e),o=(i-t)*(i-t);return Math.sqrt(n+o)}move_to(e,t){this.move_length=this.get_dist(e,t,this.x,this.y);let s=Math.atan2(t-this.y,e-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}update_x_y(){let e=Math.min(this.move_length,this.speed*this.timedelta*.001);this.move_length-=e,this.x+=e*this.vx,this.y+=e*this.vy}start(){}change_state(e){this.state=e}update_offset(){const e=this.gl;this.speed=fix(e,token_speed,!0),this.x=fix(e,this.x,!0,{pre_size:this.playground.pre_size}),this.y=fix(e,this.y,!1,{pre_size:this.playground.pre_size})}update(){"unshow"!==this.state&&(this.update_x_y(),this.render()),"on_de"===this.state&&0===this.move_length&&this.destroy()}render(){this.sm.shader_token(this.x,this.y,TokenColor2Index[this.color])}}class TokensManager extends GameObject{constructor(e){super(),this.playground=e,this.sm=this.playground.shader_manager,this.am=this.playground.am,this.gl=this.playground.gl;let t=0;switch(this.playground.players_manager.number){case 1:case 2:t=4;break;case 3:t=5;break;default:t=7}const s=this.gl;this.tokens={G:{count:t,instance:[],offset:[fix(s,token_offset_x,!0),fix(s,token_offset_y+0,!1)]},W:{count:t,instance:[],offset:[fix(s,token_offset_x,!0),fix(s,.28289473684210525,!1)]},B:{count:t,instance:[],offset:[fix(s,token_offset_x,!0),fix(s,.4342105263157895,!1)]},I:{count:t,instance:[],offset:[fix(s,token_offset_x,!0),fix(s,.5855263157894737,!1)]},R:{count:t,instance:[],offset:[fix(s,token_offset_x,!0),fix(s,.7368421052631579,!1)]},O:{count:5,instance:[],offset:[fix(s,token_offset_x,!0),fix(s,.888157894736842,!1)]}},this.select_tokens=[],this.offset_x=fix(s,token_offset_x,!0),this.offset_y=fix(s,token_offset_y,!1),this.y_step=fix(s,.1513157894736842,!1),this.t_step=fix(s,.006578947368421052,!1),this.width=fix(s,token_width,!0),this.height=fix(s,token_height,!0)}update_offset(){const e=this.gl;this.offset_x=fix(e,token_offset_x,!0),this.offset_y=fix(e,token_offset_y,!1),this.y_step=fix(e,.1513157894736842,!1),this.t_step=fix(e,.006578947368421052,!1),this.width=fix(e,token_width,!0),this.height=fix(e,token_height,!0);let t=0;for(let s in this.tokens){this.tokens[s].offset=[fix(e,token_offset_x,!0),fix(e,token_offset_y+.1513157894736842*t,!1)],t++}}click_token(e,t){const s=this.gl;let i=fix(s,.009765625,!0),n=fix(s,.019736842105263157,!1);for(let s in this.tokens){let o=this.tokens[s].offset,a=o[0]-i,r=o[1]-n,l=a+this.width,c=r+this.height;if(e>=a&&t>=r&&e<=l&&t<=c)return"O"===s||this.tokens[s].count<=0||this.playground.players_manager.get_me().tokens_count>=10?null:s}return null}select_by_player(e){const t=this.gl;if(0===this.select_tokens.length&&this.tokens[e].count>0)this.playground.top_board.add_token_click();else if(1===this.select_tokens.length){if(this.select_tokens[0].color===e&&this.tokens[e].count<3)return!1}else if(2===this.select_tokens.length){if(this.select_tokens[0].color===this.select_tokens[1].color)return!1;for(let t in this.select_tokens)if(this.select_tokens[t].color===e)return!1}else if(3===this.select_tokens.length)return!1;if(this.select_tokens.length+this.playground.players_manager.get_me().tokens_count+1>10)return!1;if(this.tokens[e].count>0){this.tokens[e].count--;let s=this.tokens[e].offset,i=new Token(this,e,s[0],s[1]);return this.select_tokens.push(i),i.move_to(fix(t,.5859375,!0)+this.select_tokens.length*this.width,fix(t,token_dis_top,!1)),this.am.play_func.select_token(),!0}return!1}unselect_by_player(){for(let e in this.select_tokens){let t=this.tokens[this.select_tokens[e].color].offset;this.tokens[this.select_tokens[e].color].count++,this.select_tokens[e].move_to(t[0],t[1])}for(let e in this.select_tokens)this.select_tokens[e].change_state("on_de");this.am.play_func.get_use_token(),this.select_tokens=[]}picked_by_player_from_tokens(e,t){for(let s in t)if(this.tokens[s].count>=t[s]){this.tokens[s].count-=t[s];let i=this.tokens[s].offset;for(let n=0;n<t[s];n++){let t=new Token(this,s,i[0],i[1]);t.move_to(e.x,e.y),t.change_state("on_de"),e.update_tokens(s,1)}}this.am.play_func.get_use_token()}picked_by_me(){let e=this.playground.players_manager.get_me(),t={};for(let s in this.select_tokens)this.select_tokens[s].move_to(e.x,e.y),e.update_tokens(this.select_tokens[s].color,1),t[this.select_tokens[s].color]?t[this.select_tokens[s].color]++:t[this.select_tokens[s].color]=1,this.select_tokens[s].change_state("on_de");this.select_tokens=[],this.playground.socket&&this.playground.socket.send_get_tokens(e.email,t),this.am.play_func.get_use_token(),this.playground.players_manager.next_player()}used_by_player(e,t){for(let s in t){let i=t[s];e.update_tokens(s,-i);for(let t=0;t<i;t++){let t=this.tokens[s].offset,i=new Token(this,s,e.x,e.y);i.move_to(t[0],t[1]),i.change_state("on_de"),this.tokens[s].count++}}this.am.play_func.get_use_token()}start(){let e=0,t=this.offset_x,s=this.offset_y,i=this.y_step,n=this.t_step;for(let o in this.tokens){for(let a=0;a<3;a++)this.tokens[o].instance.push(new Token(this,o,t,s+e*i-n*a));e++}}update_token_state(){for(let e in this.tokens){for(let t=0;t<Math.min(3,this.tokens[e].count);t++)this.tokens[e].instance[t].change_state("board");for(let t=Math.min(3,this.tokens[e].count);t<3;t++)this.tokens[e].instance[t].change_state("unshow")}}update(){this.update_token_state()}late_update(){let e=0;const t=this.gl;let s=this.offset_x,i=this.offset_y,n=this.y_step,o=fix(t,.009765625,!0),a=fix(t,.019736842105263157,!1);for(let t in this.tokens)this.tokens[t].count>0&&this.render(this.tokens[t].count,s-o,i+e*n-a),e++}render(e,t,s){const i=this.gl;this.sm.shader_score(t,s,e-1,{scale_x:fix(i,token_score_scale_x,!0),scale_y:fix(i,.05263157894736842,!1)})}}class TopBoard{constructor(e){this.playground=e,this.room_id=this.playground.room_id,this.time=0,this.player_time=this.playground.round_second,this.$top_board=$("\n<div class='top-board'>\n    <div class='top-board-center'>\n    <span>00:00</span>\n    </div>\n    <div class='top-board-out'>\n        <button>退出游戏</button>\n    </div>\n</div>        \n"),this.$token_click=$("\n<div class='token-click'>\n        <button class='pick'>确定</button>\n        <button class='cancel'>取消</button>\n</div>        \n"),this.$click_card=$("\n<div class='card-click'>\n    <div class='element buy'>\n    购买\n    </div>        \n    <div class='element book'>\n    预定\n    </div>\n    <div class='element cancle'>\n    取消\n    </div>\n</div>\n"),this.$error_message=$("\n<div class='error-message'>\n</div>        \n"),this.$game_score=$("\n<div class='game-score-list'>\n</div>\n"),this.$player_tick=$("\n<div class='player-tick'>\n</div>\n"),this.$pass_click=$("\n<div class='pass-click'>\n跳过\n</div>\n");for(let e in this.playground.players){let t=this.playground.players[e];this.$game_score.append(`<div class='game-score' name=${t.email} style="top:${22*e+10}%">\n            0\n            </div>`)}this.playground.$playground_div.append(this.$top_board),this.playground.$playground_div.append(this.$click_card),this.playground.$playground_div.append(this.$error_message),this.playground.$playground_div.append(this.$token_click),this.playground.$playground_div.append(this.$game_score),this.playground.$playground_div.append(this.$player_tick),this.playground.$playground_div.append(this.$pass_click),this.start()}add_listening_events(){this.time_func=setInterval((()=>{this.time++;let e=Math.floor(this.time/60),t=this.time%60;t<10&&(t="0"+t),e<10&&(e="0"+e),this.$top_board.find(".top-board-center > span").text(e+":"+t)}),1e3),this.$top_board.find(".top-board-out").on("click",(()=>{if(this.playground.menu.os)return this.playground.menu.os.api.window.close(),!1;window.location.href=`${BASE_URL}/splendor/`})),this.$token_click.find(".cancel").on("click",(()=>{this.playground.tokens_manager.unselect_by_player(),this.click_card_remove_no_click(),this.click_card_remove_scale(),this.$token_click.hide()})),this.$token_click.find(".pick").on("click",(()=>{this.playground.tokens_manager.picked_by_me(),this.click_card_remove_no_click(),this.click_card_remove_scale(),this.$token_click.hide()})),this.$click_card.find(".cancle").on("click",(()=>{this.click_card_remove_no_click(),this.click_card_remove_scale(),this.card&&this.card.change_back(),this.$click_card.hide()})),this.$click_card.find(".book").on("click",(()=>{if(this.$click_card.find(".book").hasClass("no-click"))return!1;let e=this.playground.players_manager.get_me();this.card.book_by_player(e),this.$click_card.hide()})),this.$click_card.find(".buy").on("click",(()=>{if(this.$click_card.find(".buy").hasClass("no-click"))return!1;let e=this.playground.players_manager.get_me();this.card.buy_by_player(e),this.$click_card.hide()})),this.$pass_click.on("click",(()=>{let e=this.playground.players_manager.is_me_round(),t=this.playground.players_manager.get_me();e&&t.pass()}))}is_show(e){return"click_card"===e?"block"===this.$click_card.css("display"):"token_click"===e?"block"===this.$token_click.css("display"):void 0}add_tick(e){this.clear_interval("tick"),this.$player_tick.css("top",22*e.index+10+"%"),this.$player_tick.show(),"me"===e.character&&this.$pass_click.show(),"robot"===e.character&&(e.timeout_func=setTimeout((()=>{e.do()}),3e3)),this.$player_tick.text(this.player_time),this.tick_func=setInterval((()=>{this.player_time--,this.$player_tick.text(this.player_time),0===this.player_time&&(this.clear_interval("tick"),e.do())}),1e3)}clear_interval(e="time"){"time"===e?clearInterval(this.time_func):"tick"===e&&(this.$pass_click.hide(),this.$player_tick.empty(),this.$player_tick.hide(),this.player_time=this.playground.round_second,this.tick_func&&clearInterval(this.tick_func))}click_card_add_scale(){this.$click_card.find(".book").addClass("element-book"),this.$click_card.find(".buy").addClass("element-book"),this.$click_card.find(".cancle").addClass("element-book")}click_card_remove_scale(){this.$click_card.find(".buy").hasClass("element-book")&&this.$click_card.find(".buy").removeClass("element-book"),this.$click_card.find(".book").hasClass("element-book")&&this.$click_card.find(".book").removeClass("element-book"),this.$click_card.find(".cancle").hasClass("element-book")&&this.$click_card.find(".cancle").removeClass("element-book")}click_card_remove_no_click(){this.$click_card.find(".book").hasClass("no-click")&&this.$click_card.find(".book").removeClass("no-click"),this.$click_card.find(".buy").hasClass("no-click")&&this.$click_card.find(".buy").removeClass("no-click")}click_card(e){const t=this.playground.gl;this.playground.players_manager.clean();let s=this.playground.players_manager.get_me();this.card=e,this.card.clicked_state=!0,this.card.can_book(s)||this.$click_card.find(".book").addClass("no-click"),this.card.can_buy(s)||this.$click_card.find(".buy").addClass("no-click");let i=e.change_big();"book"===this.card.state?(this.click_card_add_scale(),this.$click_card.css({left:e.x-fix(t,.1171875,!0)*i,top:e.y-fix(t,card_click_fix_y,!1)})):this.$click_card.css({left:e.x+fix(t,.09765625,!0)*i,top:e.y}),this.$click_card.fadeIn(),e.late_update()}add_error_message(e,t,s){this.$error_message.css({left:t,top:s}),this.$error_message.text(e),this.$error_message.show(),this.$error_message.animate({top:s-50+"px"},"normal","linear"),this.$error_message.fadeOut()}add_token_click(){this.$token_click.show()}change_game_score(e,t){let s=e.email;this.$game_score.find(`[name='${s}']`).text(t)}start(){this.add_listening_events()}}let m3={projection:function(e,t){return[2/e,0,0,0,-2/t,0,-1,1,1]},identity:function(){return[1,0,0,0,1,0,0,0,1]},translation:function(e,t){return[1,0,0,0,1,0,e,t,1]},rotation:function(e){var t=Math.cos(e),s=Math.sin(e);return[t,-s,0,s,t,0,0,0,1]},scaling:function(e,t){return[e,0,0,0,t,0,0,0,1]},multiply:function(e,t){var s=e[0],i=e[1],n=e[2],o=e[3],a=e[4],r=e[5],l=e[6],c=e[7],d=e[8],h=t[0],_=t[1],g=t[2],p=t[3],m=t[4],u=t[5],f=t[6],y=t[7],k=t[8];return[h*s+_*o+g*l,h*i+_*a+g*c,h*n+_*r+g*d,p*s+m*o+u*l,p*i+m*a+u*c,p*n+m*r+u*d,f*s+y*o+k*l,f*i+y*a+k*c,f*n+y*r+k*d]}};function get_matrix(e,t,s,i,n){let o=m3.identity();return n||(o=m3.projection(e.canvas.clientWidth,e.canvas.clientHeight)),o=m3.multiply(o,m3.translation(t[0],t[1])),o=m3.multiply(o,m3.rotation(s)),o=m3.multiply(o,m3.scaling(i[0],i[1])),o}let W="W",B="B",I="I",R="R",G="G",O="O",GemColor2Index={W:0,B:1,I:2,R:3,G:4},NSColor2Index={W:1,B:2,I:0,R:4,G:3},TokenColor2Index={W:1,B:2,I:3,R:4,G:0,O:5},origin_nobles=[{id:41,score:3,backIndex:[0,0],spend:[{color:"I",need:4},{color:"R",need:4}]},{id:42,score:3,backIndex:[0,1],spend:[{color:"R",need:4},{color:"G",need:4}]},{id:43,score:3,backIndex:[0,2],spend:[{color:"G",need:4},{color:"B",need:4}]},{id:44,score:3,backIndex:[0,3],spend:[{color:"B",need:4},{color:"W",need:4}]},{id:45,score:3,backIndex:[0,4],spend:[{color:"W",need:4},{color:"I",need:4}]},{id:46,score:3,backIndex:[1,0],spend:[{color:"I",need:3},{color:"R",need:3},{color:"G",need:3}]},{id:47,score:3,backIndex:[1,1],spend:[{color:"R",need:3},{color:"G",need:3},{color:"B",need:3}]},{id:48,score:3,backIndex:[1,2],spend:[{color:"G",need:3},{color:"B",need:3},{color:"W",need:3}]},{id:49,score:3,backIndex:[1,3],spend:[{color:"B",need:3},{color:"W",need:3},{color:"I",need:3}]},{id:410,score:3,backIndex:[1,4],spend:[{color:"W",need:3},{color:"I",need:3},{color:"R",need:3}]}],origin_cards={level1:[{id:11,score:1,gem:"I",backIndex:[1,3],spend:[{color:"B",need:4}]},{id:12,score:1,gem:"R",backIndex:[2,2],spend:[{color:"W",need:4}]},{id:13,score:1,gem:"G",backIndex:[4,1],spend:[{color:"I",need:4}]},{id:14,score:1,gem:"B",backIndex:[4,1],spend:[{color:"R",need:4}]},{id:15,score:1,gem:"W",backIndex:[4,2],spend:[{color:"G",need:4}]},{id:16,score:0,gem:"G",backIndex:[4,2],spend:[{color:"B",need:3},{color:"G",need:1},{color:"W",need:1}]},{id:17,score:0,gem:"B",backIndex:[3,3],spend:[{color:"G",need:3},{color:"B",need:1},{color:"R",need:1}]},{id:18,score:0,gem:"W",backIndex:[1,3],spend:[{color:"W",need:3},{color:"I",need:1},{color:"B",need:1}]},{id:19,score:0,gem:"I",backIndex:[1,2],spend:[{color:"R",need:3},{color:"I",need:1},{color:"G",need:1}]},{id:110,score:0,gem:"R",backIndex:[2,3],spend:[{color:"I",need:3},{color:"R",need:1},{color:"W",need:1}]},{id:111,score:0,gem:"I",backIndex:[3,3],spend:[{color:"B",need:2},{color:"W",need:2},{color:"R",need:1}]},{id:112,score:0,gem:"R",backIndex:[2,2],spend:[{color:"W",need:2},{color:"I",need:2},{color:"G",need:1}]},{id:113,score:0,gem:"G",backIndex:[2,2],spend:[{color:"I",need:2},{color:"R",need:2},{color:"B",need:1}]},{id:114,score:0,gem:"B",backIndex:[3,1],spend:[{color:"R",need:2},{color:"G",need:2},{color:"W",need:1}]},{id:115,score:0,gem:"W",backIndex:[3,0],spend:[{color:"G",need:2},{color:"B",need:2},{color:"I",need:1}]},{id:116,score:0,gem:"I",backIndex:[1,4],spend:[{color:"B",need:2},{color:"W",need:1},{color:"R",need:1},{color:"G",need:1}]},{id:117,score:0,gem:"R",backIndex:[0,0],spend:[{color:"W",need:2},{color:"I",need:1},{color:"G",need:1},{color:"B",need:1}]},{id:118,score:0,gem:"G",backIndex:[4,1],spend:[{color:"I",need:2},{color:"R",need:1},{color:"B",need:1},{color:"W",need:1}]},{id:119,score:0,gem:"B",backIndex:[3,3],spend:[{color:"R",need:2},{color:"G",need:1},{color:"W",need:1},{color:"I",need:1}]},{id:120,score:0,gem:"W",backIndex:[0,1],spend:[{color:"G",need:2},{color:"B",need:1},{color:"I",need:1},{color:"R",need:1}]},{id:121,score:0,gem:"G",backIndex:[2,0],spend:[{color:"B",need:2},{color:"R",need:2}]},{id:122,score:0,gem:"B",backIndex:[3,2],spend:[{color:"I",need:2},{color:"G",need:2}]},{id:123,score:0,gem:"W",backIndex:[1,0],spend:[{color:"I",need:2},{color:"B",need:2}]},{id:124,score:0,gem:"I",backIndex:[1,1],spend:[{color:"G",need:2},{color:"W",need:2}]},{id:125,score:0,gem:"R",backIndex:[3,1],spend:[{color:"R",need:2},{color:"W",need:2}]},{id:126,score:0,gem:"I",backIndex:[1,1],spend:[{color:"R",need:1},{color:"G",need:1},{color:"W",need:1},{color:"B",need:1}]},{id:127,score:0,gem:"R",backIndex:[2,4],spend:[{color:"G",need:1},{color:"B",need:1},{color:"I",need:1},{color:"W",need:1}]},{id:128,score:0,gem:"G",backIndex:[3,1],spend:[{color:"B",need:1},{color:"W",need:1},{color:"R",need:1},{color:"I",need:1}]},{id:129,score:0,gem:"B",backIndex:[1,0],spend:[{color:"W",need:1},{color:"I",need:1},{color:"G",need:1},{color:"R",need:1}]},{id:130,score:0,gem:"W",backIndex:[0,2],spend:[{color:"I",need:1},{color:"R",need:1},{color:"B",need:1},{color:"G",need:1}]},{id:131,score:0,gem:"G",backIndex:[2,3],spend:[{color:"R",need:3}]},{id:132,score:0,gem:"B",backIndex:[2,0],spend:[{color:"I",need:3}]},{id:133,score:0,gem:"W",backIndex:[1,0],spend:[{color:"B",need:3}]},{id:134,score:0,gem:"I",backIndex:[0,2],spend:[{color:"G",need:3}]},{id:135,score:0,gem:"R",backIndex:[1,2],spend:[{color:"W",need:3}]},{id:136,score:0,gem:"I",backIndex:[4,2],spend:[{color:"G",need:2},{color:"R",need:1}]},{id:137,score:0,gem:"R",backIndex:[2,0],spend:[{color:"B",need:2},{color:"G",need:1}]},{id:138,score:0,gem:"G",backIndex:[2,1],spend:[{color:"W",need:2},{color:"B",need:1}]},{id:139,score:0,gem:"B",backIndex:[1,1],spend:[{color:"I",need:2},{color:"W",need:1}]},{id:140,score:0,gem:"W",backIndex:[0,0],spend:[{color:"R",need:2},{color:"I",need:1}]}],level2:[{id:21,score:3,gem:"I",backIndex:[2,3],spend:[{color:"I",need:6}]},{id:22,score:3,gem:"R",backIndex:[1,0],spend:[{color:"R",need:6}]},{id:23,score:3,gem:"G",backIndex:[0,3],spend:[{color:"G",need:6}]},{id:24,score:3,gem:"B",backIndex:[3,3],spend:[{color:"B",need:6}]},{id:25,score:3,gem:"W",backIndex:[1,1],spend:[{color:"W",need:6}]},{id:26,score:2,gem:"G",backIndex:[0,3],spend:[{color:"G",need:3},{color:"B",need:5}]},{id:27,score:2,gem:"B",backIndex:[4,3],spend:[{color:"B",need:3},{color:"W",need:5}]},{id:28,score:2,gem:"W",backIndex:[1,1],spend:[{color:"I",need:3},{color:"R",need:5}]},{id:29,score:2,gem:"I",backIndex:[1,0],spend:[{color:"R",need:3},{color:"G",need:5}]},{id:210,score:2,gem:"R",backIndex:[4,4],spend:[{color:"W",need:3},{color:"I",need:5}]},{id:211,score:2,gem:"G",backIndex:[3,1],spend:[{color:"G",need:5}]},{id:212,score:2,gem:"B",backIndex:[4,2],spend:[{color:"B",need:5}]},{id:213,score:2,gem:"W",backIndex:[2,0],spend:[{color:"R",need:5}]},{id:214,score:2,gem:"I",backIndex:[0,2],spend:[{color:"W",need:5}]},{id:215,score:2,gem:"R",backIndex:[0,2],spend:[{color:"I",need:5}]},{id:216,score:2,gem:"I",backIndex:[4,1],spend:[{color:"G",need:4},{color:"R",need:2},{color:"B",need:1}]},{id:217,score:2,gem:"R",backIndex:[3,4],spend:[{color:"B",need:4},{color:"G",need:2},{color:"W",need:1}]},{id:218,score:2,gem:"G",backIndex:[2,4],spend:[{color:"W",need:4},{color:"B",need:2},{color:"I",need:1}]},{id:219,score:2,gem:"B",backIndex:[0,2],spend:[{color:"I",need:4},{color:"W",need:2},{color:"R",need:1}]},{id:220,score:2,gem:"W",backIndex:[1,0],spend:[{color:"R",need:4},{color:"I",need:2},{color:"G",need:1}]},{id:221,score:1,gem:"I",backIndex:[4,2],spend:[{color:"G",need:3},{color:"W",need:3},{color:"I",need:2}]},{id:222,score:1,gem:"R",backIndex:[0,0],spend:[{color:"B",need:3},{color:"I",need:3},{color:"R",need:2}]},{id:223,score:1,gem:"G",backIndex:[4,1],spend:[{color:"W",need:3},{color:"R",need:3},{color:"G",need:2}]},{id:224,score:1,gem:"B",backIndex:[3,1],spend:[{color:"I",need:3},{color:"G",need:3},{color:"B",need:2}]},{id:225,score:1,gem:"W",backIndex:[4,1],spend:[{color:"R",need:3},{color:"B",need:3},{color:"W",need:2}]},{id:226,score:1,gem:"G",backIndex:[3,4],spend:[{color:"B",need:3},{color:"W",need:2},{color:"I",need:2}]},{id:227,score:1,gem:"B",backIndex:[2,1],spend:[{color:"R",need:3},{color:"G",need:2},{color:"B",need:2}]},{id:228,score:1,gem:"W",backIndex:[2,2],spend:[{color:"G",need:3},{color:"I",need:2},{color:"R",need:2}]},{id:229,score:1,gem:"I",backIndex:[1,3],spend:[{color:"W",need:3},{color:"G",need:2},{color:"B",need:2}]},{id:230,score:1,gem:"R",backIndex:[4,2],spend:[{color:"I",need:3},{color:"W",need:2},{color:"R",need:2}]}],level3:[{id:31,score:5,gem:"I",backIndex:[2,4],spend:[{color:"I",need:3},{color:"R",need:7}]},{id:32,score:5,gem:"R",backIndex:[3,4],spend:[{color:"R",need:3},{color:"G",need:7}]},{id:33,score:5,gem:"G",backIndex:[2,1],spend:[{color:"G",need:3},{color:"B",need:7}]},{id:34,score:5,gem:"B",backIndex:[0,2],spend:[{color:"B",need:3},{color:"W",need:7}]},{id:35,score:5,gem:"W",backIndex:[1,2],spend:[{color:"W",need:3},{color:"I",need:7}]},{id:36,score:4,gem:"I",backIndex:[0,0],spend:[{color:"I",need:7}]},{id:37,score:4,gem:"R",backIndex:[1,4],spend:[{color:"R",need:7}]},{id:38,score:4,gem:"G",backIndex:[4,4],spend:[{color:"G",need:7}]},{id:39,score:4,gem:"B",backIndex:[2,4],spend:[{color:"B",need:7}]},{id:310,score:4,gem:"W",backIndex:[3,3],spend:[{color:"W",need:7}]},{id:311,score:4,gem:"I",backIndex:[4,4],spend:[{color:"I",need:3},{color:"R",need:6},{color:"G",need:3}]},{id:312,score:4,gem:"R",backIndex:[3,3],spend:[{color:"R",need:3},{color:"G",need:6},{color:"B",need:3}]},{id:313,score:4,gem:"G",backIndex:[4,4],spend:[{color:"G",need:3},{color:"B",need:6},{color:"W",need:3}]},{id:314,score:4,gem:"B",backIndex:[4,4],spend:[{color:"B",need:3},{color:"W",need:6},{color:"I",need:3}]},{id:315,score:4,gem:"W",backIndex:[2,1],spend:[{color:"W",need:3},{color:"I",need:6},{color:"R",need:3}]},{id:316,score:3,gem:"I",backIndex:[0,3],spend:[{color:"G",need:5},{color:"R",need:3},{color:"W",need:3},{color:"B",need:3}]},{id:317,score:3,gem:"R",backIndex:[3,3],spend:[{color:"B",need:5},{color:"G",need:3},{color:"I",need:3},{color:"W",need:3}]},{id:318,score:3,gem:"G",backIndex:[1,2],spend:[{color:"W",need:5},{color:"B",need:3},{color:"R",need:3},{color:"I",need:3}]},{id:319,score:3,gem:"B",backIndex:[2,1],spend:[{color:"I",need:5},{color:"W",need:3},{color:"G",need:3},{color:"R",need:3}]},{id:320,score:3,gem:"W",backIndex:[0,4],spend:[{color:"R",need:5},{color:"I",need:3},{color:"B",need:3},{color:"G",need:3}]}]};class ImageShader{constructor(e){this.sm=e,this.gl=this.sm.gl,this.name="ImageShader",this.sm.shader_dict[this.name]=this,console.log("loading shader",this.name),this.init()}shader_text(){this.vs="\n        attribute vec2 a_position;\n        attribute vec2 a_texCoord;\n\n        uniform mat3 u_position_matrix;\n        uniform mat3 u_texCoord_matrix;\n        \n        varying vec2 v_texCoord;\n        \n        void main() {\n            gl_Position = vec4((u_position_matrix * vec3(a_position, 1)).xy, 0, 1);\n            v_texCoord = (u_texCoord_matrix * vec3(a_texCoord, 1)).xy;\n        }\n        ",this.fs="\n        precision highp float;\n        \n        uniform sampler2D u_image;\n        \n        varying vec2 v_texCoord;\n        \n        void main() {\n            gl_FragColor = texture2D(u_image, v_texCoord);\n        }\n        "}init(){const e=this.gl,t=this.sm;this.shader_text();let s=t.createProgramFromText(e,this.vs,this.fs),i=e.getAttribLocation(s,"a_position"),n=e.getAttribLocation(s,"a_texCoord"),o=e.getUniformLocation(s,"u_resolution"),a=e.getUniformLocation(s,"u_position_matrix"),r=e.getUniformLocation(s,"u_texCoord_matrix"),l=e.getUniformLocation(s,"u_image");const c=new Float32Array(t.get_point_from(0,0,1,1)),d=new Float32Array(t.get_point_from(0,0,1,1)),h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,c,e.STATIC_DRAW);const _=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,_),e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW);let g={program:s,a_position:{loc:i,buffer:h},a_texCoord:{loc:n,buffer:_},u_resolution:o,u_image:l,u_position_matrix:a,u_texCoord_matrix:r};this.programInfo=g}draw(e,t,s){const i=this.gl,n=this.sm;let o=this.programInfo;n.resize(i),i.viewport(0,0,i.canvas.width,i.canvas.height),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.useProgram(o.program),this.set_pointer(o),this.set_uniform(o,e,t,s),i.drawArrays(i.TRIANGLES,0,6)}set_pointer(e){const t=this.gl,s=e.a_position.loc,i=e.a_position.buffer;t.enableVertexAttribArray(s),t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0);const n=e.a_texCoord.loc,o=e.a_texCoord.buffer;t.enableVertexAttribArray(n),t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0)}set_uniform(e,t,s,i){const n=this.gl;n.uniform2fv(e.u_resolution,[n.canvas.width,n.canvas.height]),n.uniformMatrix3fv(e.u_position_matrix,!1,s),n.uniformMatrix3fv(e.u_texCoord_matrix,!1,i);n.activeTexture(n.TEXTURE0+2),n.bindTexture(n.TEXTURE_2D,t),n.uniform1i(e.u_image,2)}}class PreProcessTexture{constructor(e){this.sm=e,this.texture_dict={cards:null,gems:null,nobles:null,tokens:null,numbers_sheet:null},this.texture_image=this.sm.playground.menu.loading.image_assets.texture_image,this.start()}start(){this.preProcess()}init_texture(e){const t=this.sm.gl,s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s}preProcess(){console.log(this.texture_image);for(let e in this.texture_image){let t=this.texture_image[e];this.texture_dict[e]=this.init_texture(t)}this.texture_dict.players={};for(let e in this.sm.playground.players){let t=BASE_URL+this.sm.playground.players[e].photo,s=this.sm.playground.players[e].email,i=new Image,n=t;requestCORSIfNotSameOrigin(i,n),i.src=n,i.onload=()=>{this.texture_dict.players[s]=this.init_texture(i)}}}get(e){return this.texture_dict[e]}}class RectShader{constructor(e){this.sm=e,this.gl=this.sm.gl,this.name="RectShader",this.sm.shader_dict[this.name]=this,console.log("loading shader",this.name),this.init()}shader_text(){this.vs="\n            attribute vec2 a_position;\n\n            uniform mat3 u_position_matrix;\n\n            void main(){\n                gl_Position = vec4((u_position_matrix * vec3(a_position, 1)).xy, 0, 1);\n            }\n        ",this.fs="\n            precision highp float;\n\n            uniform vec4 u_color;\n\n            void main(){\n                gl_FragColor = u_color;\n            }\n        "}init(){const e=this.gl,t=this.sm;this.shader_text();let s=t.createProgramFromText(e,this.vs,this.fs),i=e.getAttribLocation(s,"a_position"),n=e.getUniformLocation(s,"u_position_matrix"),o=e.getUniformLocation(s,"u_color");const a=new Float32Array(t.get_point_from(0,0,1,1)),r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW);let l={program:s,a_position:{loc:i,buffer:r},u_position_matrix:n,u_color:o};this.programInfo=l}draw(e,t){const s=this.gl,i=this.sm;let n=this.programInfo;i.resize(s),s.viewport(0,0,s.canvas.width,s.canvas.height),s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.useProgram(n.program),this.set_pointer(n),this.set_uniform(n,e,t),s.drawArrays(s.TRIANGLES,0,6)}set_pointer(e){const t=this.gl,s=e.a_position.loc,i=e.a_position.buffer;t.enableVertexAttribArray(s),t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0)}set_uniform(e,t,s){const i=this.gl;i.uniformMatrix3fv(e.u_position_matrix,!1,t),i.uniform4fv(e.u_color,s)}}class ShaderManager{constructor(e){this.playground=e,this.gl=this.playground.gl,this.shader_dict={}}shader_player_photo(e,t,s,i){let n=this.get("ImageShader"),o=this.tm.get("players")[e],a=(i=i||{}).scale_x||fix(this.gl,.01953125,!0),r=i.scale_y||fix(this.gl,.039473684210526314,!1),l=i.scale||1,c=i.rotation||0,d=get_matrix(this.gl,[t,s],c,[a*l,r*l],!1),h=get_matrix(this.gl,[0,0],0,[1,1],!0);n.draw(o,d,h)}shader_card_back(e,t,s,i,n){let o=this.get("ImageShader"),a=this.tm.get("cards"),r=(n=n||{}).scale_x||fix(this.gl,.09765625,!0),l=n.scale_y||fix(this.gl,.26710526315789473,!1),c=n.rotation||0,d=n.scale||1,h=get_matrix(this.gl,[e,t],c,[r*d,l*d],!1),_=get_matrix(this.gl,[.2*s,.1666*i],0,[.1998,.1665],!0);o.draw(a,h,_)}shader_top_back(e,t,s,i){let n=this.get("RectShader"),o=(i=i||{}).rotation||0,a=i.scale_x||fix(this.gl,.09765625,!0),r=i.scale_y||fix(this.gl,.07105263157894737,!1),l=i.scale||1,c=get_matrix(this.gl,[e,t],o,[a*l,r*l],!1);n.draw(c,s)}shader_score(e,t,s,i){let n=this.get("ImageShader"),o=this.tm.get("numbers_sheet"),a=(i=i||{}).rotation||0,r=i.scale_x||fix(this.gl,.032552083333333336,!0),l=i.scale_y||fix(this.gl,.06578947368421052,!1),c=i.scale||1,d=get_matrix(this.gl,[e,t],a,[r*c,l*c],!1),h=get_matrix(this.gl,[.1*s,.6666],0,[.1,.3333],!0);n.draw(o,d,h)}shader_mini_card_back(e,t,s,i){let n=this.get("ImageShader"),o=this.tm.get("numbers_sheet"),a=(i=i||{}).rotation||0,r=i.scale_x||fix(this.gl,.022786458333333332,!0),l=i.scale_y||fix(this.gl,.046052631578947366,!1),c=i.scale||1,d=get_matrix(this.gl,[e,t],a,[r*c,l*c],!1),h=get_matrix(this.gl,[.1*s,0],0,[.1,.3333],!0);n.draw(o,d,h)}shader_gem(e,t,s,i){let n=this.get("ImageShader"),o=this.tm.get("gems"),a=(i=i||{}).rotation||0,r=i.scale_x||fix(this.gl,.029296875,!0),l=i.scale_y||fix(this.gl,shader_gem_scale_y,!1),c=fix(this.gl,.0016276041666666667,!0),d=fix(this.gl,.003289473684210526,!0),h=i.scale||1,_=get_matrix(this.gl,[e+c,t+d],a,[r*h,l*h],!1),g=get_matrix(this.gl,[.2*s,0],0,[.2,1],!0);n.draw(o,_,g)}shader_spend(e,t,s,i,n){let o=this.get("ImageShader"),a=this.tm.get("numbers_sheet"),r=fix(this.gl,.032552083333333336,!0),l=fix(this.gl,.06578947368421052,!1),c=(n=n||{}).scale||1,d=get_matrix(this.gl,[e,t],0,[r*c,l*c],!1),h=get_matrix(this.gl,[.1*s,.3333],0,[.1,.3333],!0);o.draw(a,d,h),this.shader_score(e,t,i,n)}shader_token(e,t,s,i){let n=this.get("ImageShader"),o=this.tm.get("tokens"),a=(i=i||{}).rotation||0,r=i.scale_x||fix(this.gl,.045572916666666664,!0),l=i.scale_y||fix(this.gl,.09210526315789473,!1),c=i.scale||1,d=get_matrix(this.gl,[e,t],a,[r*c,l*c],!1),h=get_matrix(this.gl,[.16666*s,0],0,[.16667,1],!0);n.draw(o,d,h)}shader_noble(e,t,s,i,n){let o=this.get("ImageShader"),a=this.tm.get("nobles"),r=(n=n||{}).rotation||0,l=n.scale_x||fix(this.gl,.09114583333333333,!0),c=n.scale_y||fix(this.gl,.18421052631578946,!1),d=n.scale||1,h=get_matrix(this.gl,[e,t],r,[l*d,c*d],!1),_=get_matrix(this.gl,[.2*s,.5*i],0,[.2,.5],!0);o.draw(a,h,_)}get(e){return this.shader_dict[e]}resize(e){const t=e.canvas,s=t.clientWidth,i=t.clientHeight,n=t.width!==s||t.height!==i;return n&&(t.width=s,t.height=i),n}before_render(){const e=this.gl;this.resize(e),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT)}createProgramFromText(e,t,s){const i=this.createShader(e,e.VERTEX_SHADER,t),n=this.createShader(e,e.FRAGMENT_SHADER,s);return this.createProgram(e,i,n)}createShader(e,t,s){let i=e.createShader(t);if(e.shaderSource(i,s),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS))return i;console.log(e.getShaderInfoLog(i)),e.deleteShader(i)}createProgram(e,t,s){let i=e.createProgram();if(e.attachShader(i,t),e.attachShader(i,s),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS))return i;console.log(e.getProgramInfoLog(i)),e.deleteProgram(i)}get_point_from(e,t,s,i){let n=e+s,o=t+i;return[e,t,n,t,e,o,e,o,n,t,n,o]}randomint_from_xy(e,t){return Math.floor(e+Math.random()*(t-e))}init(){new ImageShader(this),new RectShader(this),this.tm=new PreProcessTexture(this)}}class SplendorGameSocket{BASE_WSS="wss://app3774.acapp.acwing.com.cn";constructor(e){this.playground=e,this.start()}start(){this.ws=this.playground.menu.socket.ws}get_player(e){return this.playground.players_manager.get_player(e)}get_card(e){return this.playground.cards_manager.get_card(e)}send_stat(e){this.ws.send(JSON.stringify({event:"send_stat",content:e}))}send_message(e,t){let s={email:e,message:t};this.ws.send(JSON.stringify({event:"send_message",content:s}))}send_get_tokens(e,t){let s={email:e,tokens_config:t};this.ws.send(JSON.stringify({event:"send_get_tokens",content:s}))}send_book_card(e,t){let s={email:e,card_uuid:t};this.ws.send(JSON.stringify({event:"send_book_card",content:s}))}send_buy_card(e,t){let s={email:e,card_uuid:t};this.ws.send(JSON.stringify({event:"send_buy_card",content:s}))}send_pass(e){let t={email:e};this.ws.send(JSON.stringify({event:"send_pass",content:t}))}receive_pass(e){let t=e.email;this.get_player(t).pass(!0)}recevie_message(e){let t=e.message,s=e.email;this.playground.chat.send_message(s,t)}recevie_get_tokens(e){let t=e.email,s=e.tokens_config,i=this.get_player(t);this.playground.tokens_manager.picked_by_player_from_tokens(i,s),this.playground.players_manager.next_player()}recevie_book_card(e){let t=e.email,s=e.card_uuid,i=this.get_player(t);this.get_card(s).book_by_player(i)}receive_buy_card(e){let t=e.email,s=e.card_uuid,i=this.get_player(t);this.get_card(s).buy_by_player(i)}}class SplendorPlayground{constructor(e,t,s,i,n){this.menu=e,this.config=t,this.players=s,this.me=n,this.room_id=i,this.mode=this.config.single_mode||this.config.room_mode,this.player_number=this.config.single_player_number||this.config.room_player_number,this.round_second=this.config.room_round_second||this.config.single_round_second,this.roundi=this.config.roundi||0,this.$playground_div=$("<div class='playground'></div>"),this.menu.$menu_div.append(this.$playground_div),this.state="start",this.start()}destroy(){for(let e=0;e<GAME_OBJECTS.length;e++)GAME_OBJECTS[e].splice(i,1)}start(){this.init_canvas_context(),this.init_shader_manager(),this.init_audio_manager(),this.start_animation(),"单人"!==this.mode&&(this.socket=new SplendorGameSocket(this),this.chat=new SplendorChat(this)),this.top_board=new TopBoard(this),this.players_manager=new PlayersManager(this),this.cards_manager=new CardsManager(this),this.tokens_manager=new TokensManager(this),this.nobles_manager=new NoblesManager(this),this.state="round",setTimeout((()=>{this.players_manager.next_player()}),1e3)}init_audio_manager(){this.am=new AudioManager(this)}init_canvas_context(){this.$canvas=$("<canvas tabindex=1></canvas>"),this.$playground_div.append(this.$canvas),this.gl=this.$canvas[0].getContext("webgl"),this.gl||alert("未支持WebGl"),this.$canvas.on("click",(e=>{this.process_mouse_event(e)})),this.resize(),$(window).resize((()=>{this.resize()}))}resize(){this.now_size?this.pre_size=this.now_size:this.pre_size=[this.gl.canvas.clientWidth,this.gl.canvas.clientHeight],this.shader_manager&&this.shader_manager.before_render(),this.now_size=[this.gl.canvas.clientWidth,this.gl.canvas.clientHeight];for(let e=0;e<GAME_OBJECTS.length;e++){GAME_OBJECTS[e].update_offset()}}init_shader_manager(){this.shader_manager=new ShaderManager(this),this.shader_manager.init()}start_animation(){let e=t=>{this.shader_manager.before_render();for(let e=0;e<GAME_OBJECTS.length;e++){let s=GAME_OBJECTS[e];s.is_called_start?(s.update(),s.timedelta=t-last_timestamp):(s.start(),s.is_called_start=!0)}for(let e=0;e<GAME_OBJECTS.length;e++)GAME_OBJECTS[e].late_update();last_timestamp=t,requestAnimationFrame(e)};requestAnimationFrame(e)}statistics(e){this.state="end",this.top_board.clear_interval(),this.top_board.clear_interval("tick");let t=this.top_board.time,s=Math.floor(t/60),i=t%60;i<10&&(i="0"+i),s<10&&(s="0"+s);let n=s+":"+i;this.$statistics=$(`\n<div class='statistics-wrap'>\n    <div class='statistics-box'>\n        <div class='statistics-title'>\n            <span>结算统计</span>\n            <span>对局时间 ${n}</span>\n        </div>\n        <div class='statistics-header'>\n            <span>排名</span>\n            <span>头像</span>\n            <span>昵称</span>\n            <span>游戏分数</span>\n            <span>排位分数</span>\n            <span>分数改变</span>\n        </div>\n        <div class='statistics-content'>\n\n        </div>\n        <div class='statistics-click'>\n            <button>退出</button>\n        </div>\n    </div>\n</div>        \n`),this.players_stat=[];for(let t in e){let s=e[t];this.players_stat.push({email:s.email,name:s.name,photo:s.photo,game_score:s.game_score,score:s.score,cards_count:this.players_manager.get_player(s.email).cards_count})}this.players_stat.sort(((e,t)=>t.game_score===e.game_score?e.cards_count-t.cards_count:t.game_score-e.game_score));for(let e in this.players_stat){let t=0;"单人"!==this.mode&&(0===parseInt(e)&&(t+=10),this.players_stat[e].game_score>=15?t+=10:t-=10),this.players_stat[e].score_change=t}this.socket&&this.socket.send_stat(this.players_stat);let o=this.$statistics.find(".statistics-content");for(let e in this.players_stat){let t=parseInt(e)+1,s=this.players_stat[e],i=s.score_change<0?"statistics-change-red":"statistics-change-green",n=s.score_change<0?s.score_change:"+"+s.score_change,a=$(`\n<div class='statistics-element'>\n    <span>${t}</span>\n    <img src='${BASE_URL}${s.photo}'>\n    <span>${s.name}</span>\n    <span>${s.game_score}</span>\n    <span>${s.score}</span>\n    <span class='${i}'>${n}</span>\n</div>\n`);o.append(a)}return this.$statistics.find(".statistics-click").on("click",(()=>{if(this.menu.os)return this.menu.os.api.window.close(),!1;window.location.href=`${BASE_URL}/splendor/`})),this.$playground_div.append(this.$statistics),0}process_mouse_event(e){if(!this.players_manager.is_me_round())return!1;if("round"!==this.state&&"last_round"!==this.state)return!1;let t=this.gl.canvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,n=this.cards_manager.click_card(s,i);if(null!==n)return this.top_board.click_card(n),!0;this.players_manager.clean();let o=this.tokens_manager.click_token(s,i);if(null!==o){this.tokens_manager.select_by_player(o)||this.top_board.add_error_message("不能这样操作",s,i)}}}class SplendorRoom{constructor(e){this.root=e,this.players=[],this.start()}start(){this.create_base()}add_listening_events(){this.$room_wrap.find(".room-check-button > button").on("click",(()=>{let e=this.$room_wrap.find(".room-check-input > input").val();if(""===e)return!1;this.check_pass(e)})),this.$room_wrap.find(".room-start > button:first").on("click",(()=>{if(this.is_owner){if(this.players.length<2)return!1;this.root.socket.start_game()}})),this.$room_wrap.find(".room-start > button:last").on("click",(()=>{this.is_owner&&(this.root.socket.cancel_room(),this.cancel_room())})),this.$room_wrap.find(".room-start > button:nth-child(2)").on("click",(e=>{let t=document.createElement("input"),s=`${BASE_URL}/splendor/page/menu/?room_id=${this.room_id}&need_pass=${this.need_pass}`;t.setAttribute("value",s),document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),alert("复制链接成功, 分享给好友邀请加入游戏")}))}cancel_room(){if(this.root.os)return this.root.os.api.window.close(),!1;window.location.href=`${BASE_URL}/splendor/`}start_game(){this.root.start_game(this.config,this.players,this.room_id)}create_base(){this.$room_wrap=$("\n<div class='room-wrap'>\n    <div class='room-check'>\n        <div class='room-check-title'>\n            <span>请输入房间密码</span>\n        </div>\n        <div class='room-check-input'>\n            <input type='text' maxlength='4' oninput= \"value = value.replace(/[^\\d]/g, '')\" name='room_pass'>\n        </div>\n        <div class='room-check-button'>\n            <button>确认</button>\n        </div>\n    </div>\n    <div class='room-box'>\n        <div class='room-title'>\n            <span></span>\n        </div>\n        <div class='room-player'>\n        </div>\n        <div class='room-start'>\n            <button>开始游戏</button>\n            <button>邀请玩家</button>\n            <button>解散房间</button>\n        </div>\n    </div>\n</div>\n"),this.$check=this.$room_wrap.find(".room-check"),this.$check.hide(),this.$box=this.$room_wrap.find(".room-box"),this.$box.hide(),this.$room_wrap.hide(),this.root.$menu_div.append(this.$room_wrap),this.add_listening_events()}show(){this.$room_wrap.show()}hide(){this.$room_wrap.hide()}create_room(e,t,s,i,n){this.room_id=t,this.is_owner=i,this.player_info=e,this.need_pass=s,this.config=n,this.$room_wrap.css("background-image","linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("+BASE_URL+e.back+")"),i?(this.players.push(e),this.$box.find(".room-title > span").text("房间 "+this.room_id+"("+n.room_player_number+"人房)"),this.padding_info(e),this.root.hide(),this.show(),this.$box.show()):(this.root.hide(),this.show(),"true"===s?this.$check.show():this.join_room(e,""))}check_pass(e){this.join_room(this.player_info,e)}join_room(e,t){setTimeout((()=>{this.root.socket.join_room(this.room_id,e,t)}),1e3)}receive_join_room(e,t){this.config=e,this.$check.hide(),this.playernumber=e.room_player_number,this.round_second=e.room_round_second,this.players=t,this.$box.find(".room-title > span").text("房间 "+this.room_id+"("+e.room_player_number+"人房)"),this.$box.find(".room-player").empty();for(let e=0;e<t.length;e++)this.padding_info(t[e]);this.$box.show()}padding_info(e){let t=this.$box.find(".room-player"),s=$(`\n<div class='player-element'>\n    <div class='player-photo'>\n        <img src='${BASE_URL}${e.photo}'>\n    </div>\n    <div class='player-name'>\n        <span>${e.name}</span>\n    </div>\n</div>\n`);t.append(s)}}class SplendorRoomSocket{BASE_WSS="wss://app3774.acapp.acwing.com.cn";constructor(e){this.root=e,this.start()}start(){this.ws=new WebSocket(`${this.BASE_WSS}/wss/splendor/multiplayer/room/?token=`+localStorage.getItem("gc-access")),this.receive()}receive_create_room(e){this.root.room_id=e.room_id,this.root.need_pass=e.need_pass,this.root.receive_create_room(e.config)}create_room(e){let t={room_config:e,room_owner:this.root.player_info};this.ws.send(JSON.stringify({event:"create_room",content:t}))}cancel_room(){this.ws.send(JSON.stringify({event:"cancel_room",content:{cancel_room:"true"}}))}start_game(){this.ws.send(JSON.stringify({event:"start_game",content:{start_game:"true"}}))}join_room(e,t,s,i="false"){let n={room_id:e,pass:s,player_info:t,match:i};this.ws.send(JSON.stringify({event:"join_room",content:n}))}receive_join_room(e){e.players.length>=2&&this.root.start_game(e.config,e.players,e.room_id)}receive_match_success(e){this.root.match_success(e)}stop_match(e,t){let s={email:e,score:t};this.ws.send(JSON.stringify({event:"stop_match",content:s}))}match(e,t){let s={email:e,score:t};this.ws.send(JSON.stringify({event:"match",content:s}))}receive_start_game(e){let t=e.config,s=e.players;this.root.room.config=t,this.root.room.players=s,this.root.room.start_game()}receive(){this.ws.onmessage=e=>{let t=JSON.parse(e.data),s=t.event,i=t.content;if("create_room"===s)this.receive_create_room(i);else if("join_room"===s)"false"===i.match?this.root.room.receive_join_room(i.config,i.players):this.receive_join_room(i);else if("match_success"===s)this.receive_match_success(i);else if("start_game"===s)this.receive_start_game(i);else{if(t.email===this.root.player_info.email)return!1;"cancel_room"===s?this.root.room.cancel_room():"send_message"===s?this.root.playground.socket.recevie_message(i):"send_get_tokens"===s?this.root.playground.socket.recevie_get_tokens(i):"send_book_card"===s?this.root.playground.socket.recevie_book_card(i):"send_buy_card"===s?this.root.playground.socket.receive_buy_card(i):"send_pass"===s&&this.root.playground.socket.receive_pass(i)}}}}
